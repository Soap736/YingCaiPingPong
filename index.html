<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ‰å®éªŒå­¦é™¢ä¹’ä¹“çƒä¿±ä¹éƒ¨ç§¯åˆ†ç³»ç»Ÿ v1.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f5f9ff;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 25px 0;
            text-align: center;
            margin-bottom: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            border: 2px solid #FFD700;
        }
        
        header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background-color: #FFD700;
        }
        
        .logo-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #FFD700 0%, #FFEC8B 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: #1e3c72;
            margin-right: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            border: 2px solid white;
        }
        
        .title-container h1 {
            font-size: 32px;
            margin-bottom: 5px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
        }
        
        .subtitle {
            font-size: 18px;
            margin-bottom: 15px;
            opacity: 0.9;
        }
        
        .version {
            display: inline-block;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 14px;
            margin-left: 10px;
        }
        
        .admin-status {
            display: inline-block;
            background-color: #FFD700;
            color: #1e3c72;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-top: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .tabs {
            display: flex;
            background-color: #1e3c72;
            border-radius: 10px 10px 0 0;
            overflow-x: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .tab {
            padding: 15px 25px;
            color: white;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            transition: all 0.3s;
            white-space: nowrap;
            position: relative;
        }
        
        .tab:hover {
            background-color: #2a5298;
        }
        
        .tab.active {
            background-color: #FFD700;
            color: #1e3c72;
            font-weight: bold;
        }
        
        .tab.active::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background-color: #1e3c72;
        }
        
        .tab-content {
            display: none;
            background-color: white;
            padding: 25px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            min-height: 500px;
            border: 1px solid #eaeaea;
            border-top: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #1e3c72;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #1e3c72;
            outline: none;
            box-shadow: 0 0 0 2px rgba(30, 60, 114, 0.2);
        }
        
        button {
            background-color: #1e3c72;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            margin: 5px;
            font-weight: bold;
        }
        
        button:hover {
            background-color: #2a5298;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        button.danger {
            background-color: #e74c3c;
        }
        
        button.danger:hover {
            background-color: #c0392b;
        }
        
        button.success {
            background-color: #27ae60;
        }
        
        button.success:hover {
            background-color: #219653;
        }
        
        button.warning {
            background-color: #f39c12;
        }
        
        button.warning:hover {
            background-color: #e67e22;
        }
        
        .row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -15px;
        }
        
        .col {
            flex: 1;
            padding: 0 15px;
            min-width: 300px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #eaeaea;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eaeaea;
        }
        
        th {
            background-color: #f0f5ff;
            font-weight: bold;
            color: #1e3c72;
        }
        
        tr:hover {
            background-color: #f8fbff;
        }
        
        .ranking-section {
            margin-bottom: 40px;
        }
        
        .ranking-title {
            color: #1e3c72;
            border-bottom: 2px solid #FFD700;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 22px;
            display: flex;
            align-items: center;
        }
        
        .ranking-title::before {
            content: "ğŸ“";
            margin-right: 10px;
            font-size: 24px;
        }
        
        .stats {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 25px;
        }
        
        .stat-item {
            background: linear-gradient(135deg, #f0f5ff 0%, #e6eeff 100%);
            border-radius: 10px;
            padding: 20px;
            margin: 0 15px 15px 0;
            min-width: 180px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            border-left: 4px solid #1e3c72;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #1e3c72;
        }
        
        .warning {
            color: #e74c3c;
            font-weight: bold;
            margin: 10px 0;
            padding: 10px;
            background-color: #ffeaea;
            border-radius: 6px;
            border-left: 4px solid #e74c3c;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            width: 450px;
            max-width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 2px solid #1e3c72;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #777;
            transition: color 0.3s;
        }
        
        .close-btn:hover {
            color: #1e3c72;
        }
        
        .login-form {
            margin-top: 20px;
        }
        
        .battle-log {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 15px;
            margin-top: 10px;
            background-color: #f9f9f9;
            border-radius: 6px;
        }
        
        .group-display {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 15px;
            margin-top: 10px;
            background-color: #f9f9f9;
            border-radius: 6px;
            white-space: pre-line;
        }
        
        .history-display {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 15px;
            margin-top: 10px;
            background-color: #f9f9f9;
            border-radius: 6px;
            white-space: pre-line;
        }
        
        .member-list {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 15px;
            margin-top: 10px;
            background-color: #f9f9f9;
            border-radius: 6px;
        }
        
        .member-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }
        
        .member-item:hover {
            background-color: #f0f5ff;
        }
        
        .member-item:last-child {
            border-bottom: none;
        }
        
        .admin-only {
            display: none;
        }
        
        .admin-mode .admin-only {
            display: block;
        }
        
        .admin-mode .admin-tab {
            display: inline-block;
        }
        
        .tournament-stage {
            margin: 20px 0;
        }
        
        .stage-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stage-content {
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            background-color: #fcfcff;
        }
        
        .tournament-group {
            margin-bottom: 25px;
        }
        
        .group-header {
            background-color: #f0f5ff;
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-weight: bold;
            color: #1e3c72;
            border-left: 4px solid #FFD700;
        }
        
        .match-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }
        
        .match-item:hover {
            background-color: #f8fbff;
        }
        
        .match-item.completed {
            color: #888;
            background-color: #f9f9f9;
        }
        
        .tournament-info {
            background-color: #f0f5ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #1e3c72;
        }
        
        .group-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .group-tab {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background: none;
            transition: all 0.3s;
        }
        
        .group-tab.active {
            background-color: #f0f5ff;
            border-bottom: 3px solid #1e3c72;
            color: #1e3c72;
            font-weight: bold;
        }
        
        .group-content {
            display: none;
        }
        
        .group-content.active {
            display: block;
        }
        
        .champion-display {
            background-color: #fff9e6;
            border: 1px solid #FFD700;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
            font-size: 20px;
            color: #1e3c72;
        }
        
        .match-actions {
            display: flex;
            gap: 8px;
        }
        
        .medal {
            display: inline-block;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            font-weight: bold;
            margin-right: 8px;
        }
        
        .gold {
            background-color: #FFD700;
            color: #1e3c72;
        }
        
        .silver {
            background-color: #C0C0C0;
            color: #333;
        }
        
        .bronze {
            background-color: #CD7F32;
            color: white;
        }
        
        .academy-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f5ff;
        }
        
        .section-header h2 {
            color: #1e3c72;
            margin-right: 15px;
        }
        
        .section-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        
        .score-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }
        
        .score-option {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .score-option:hover {
            background-color: #f0f5ff;
            border-color: #1e3c72;
        }
        
        .score-option.selected {
            background-color: #e6eeff;
            border-color: #1e3c72;
            box-shadow: 0 0 0 2px rgba(30, 60, 114, 0.2);
        }
        
        .score-display {
            display: inline-block;
            padding: 5px 10px;
            background-color: #f0f5ff;
            border-radius: 4px;
            font-weight: bold;
            color: #1e3c72;
            margin-left: 10px;
        }
        
        .footer {
            margin-top: 40px;
            text-align: center;
            padding: 20px;
            border-top: 1px solid #eaeaea;
            color: #666;
            font-size: 14px;
        }
        
        .copyright {
            margin-bottom: 10px;
        }
        
        .creator {
            font-size: 12px;
            color: #999;
        }
        
        @media (max-width: 768px) {
            .col {
                flex: 100%;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1;
                min-width: 120px;
                text-align: center;
            }
            
            .stage-buttons {
                flex-direction: column;
            }
            
            .match-actions {
                flex-direction: column;
            }
            
            .stat-item {
                min-width: 100%;
                margin-right: 0;
            }
            
            .logo-container {
                flex-direction: column;
            }
            
            .logo {
                margin-right: 0;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="academy-badge">è‹±æ‰å®éªŒå­¦é™¢</div>
            <div class="logo-container">
                <div class="logo">è‹±æ‰</div>
                <div class="title-container">
                    <h1>è‹±æ‰å®éªŒå­¦é™¢ä¹’ä¹“çƒä¿±ä¹éƒ¨<span class="version">v1.0</span></h1>
                    <div class="subtitle">ç§¯åˆ†æ’åä¸èµ›äº‹ç®¡ç†ç³»ç»Ÿ</div>
                </div>
            </div>
            <div id="adminStatus" class="admin-status" style="display: none;">ç®¡ç†å‘˜æ¨¡å¼</div>
            <div style="margin-top: 15px;">
                <button id="adminLoginBtn" class="success">ç®¡ç†å‘˜ç™»å½•</button>
            </div>
        </header>
        
        <div class="tabs">
            <button class="tab active" data-tab="ranking">ç§¯åˆ†æ’å</button>
            <button class="tab" data-tab="history">å†å²æˆ˜ç»©</button>
            <button class="tab" data-tab="tournament-results">æ¯”èµ›ç»“æœ</button>
            <button class="tab admin-only" data-tab="members">æˆå‘˜ç®¡ç†</button>
            <button class="tab admin-only" data-tab="battle">å¯¹æˆ˜è®°å½•</button>
            <button class="tab admin-only" data-tab="tournament">æ¯”èµ›ç®¡ç†</button>
            <button class="tab admin-only" data-tab="tournament-battle">æ¯”èµ›å¯¹æˆ˜</button>
            <button class="tab admin-only" data-tab="admin">ç³»ç»Ÿç®¡ç†</button>
        </div>
        
        <!-- ç§¯åˆ†æ’åé¡µé¢ -->
        <div id="ranking" class="tab-content active">
            <div class="section-header">
                <span class="section-icon">ğŸ†</span>
                <h2>ç§¯åˆ†æ’å</h2>
            </div>
            <button id="refreshRanking" class="success">åˆ·æ–°æ’å</button>
            
            <div class="ranking-section">
                <h3 class="ranking-title">ç§¯åˆ†æ’å</h3>
                <table id="rankingTable">
                    <thead>
                        <tr>
                            <th>æ’å</th>
                            <th>å§“å</th>
                            <th>ç§¯åˆ†</th>
                        </tr>
                    </thead>
                    <tbody id="rankingBody">
                        <!-- æ’åæ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                    </tbody>
                </table>
            </div>
            
            <div class="ranking-section">
                <h3 class="ranking-title">å‚ä¸èµ›äº‹æ¬¡æ•°æ’å</h3>
                <table id="tournamentParticipationTable">
                    <thead>
                        <tr>
                            <th>æ’å</th>
                            <th>å§“å</th>
                            <th>å‚ä¸èµ›äº‹æ¬¡æ•°</th>
                        </tr>
                    </thead>
                    <tbody id="tournamentParticipationBody">
                        <!-- å‚ä¸èµ›äº‹æ¬¡æ•°æ’åæ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                    </tbody>
                </table>
            </div>
            
            <div class="ranking-section">
                <h3 class="ranking-title">èƒœåœºæ•°é‡æ’å</h3>
                <table id="winsTable">
                    <thead>
                        <tr>
                            <th>æ’å</th>
                            <th>å§“å</th>
                            <th>èƒœåœºæ•°é‡</th>
                        </tr>
                    </thead>
                    <tbody id="winsBody">
                        <!-- èƒœåœºæ•°é‡æ’åæ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- å†å²æˆ˜ç»©é¡µé¢ -->
        <div id="history" class="tab-content">
            <div class="section-header">
                <span class="section-icon">ğŸ“Š</span>
                <h2>å†å²æˆ˜ç»©</h2>
            </div>
            <div class="form-group">
                <label for="historyMember">é€‰æ‹©æˆå‘˜æŸ¥çœ‹å†å²æˆ˜ç»©:</label>
                <select id="historyMember">
                    <option value="">--è¯·é€‰æ‹©æˆå‘˜--</option>
                </select>
                <button id="showHistory" class="success">æŸ¥è¯¢æˆ˜ç»©</button>
            </div>
            
            <h3>æˆ˜ç»©ç»Ÿè®¡:</h3>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-label">èƒœåœº</div>
                    <div id="winsCount" class="stat-value">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">è´Ÿåœº</div>
                    <div id="lossesCount" class="stat-value">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">å¹³å±€</div>
                    <div id="drawsCount" class="stat-value">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">èƒœç‡</div>
                    <div id="winRate" class="stat-value">0%</div>
                </div>
            </div>
            
            <h3>å†å²æˆ˜ç»©:</h3>
            <div id="historyDisplay" class="history-display">
                <!-- å†å²æˆ˜ç»©å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
            </div>
        </div>
        
        <!-- æ¯”èµ›ç»“æœé¡µé¢ -->
        <div id="tournament-results" class="tab-content">
            <div class="section-header">
                <span class="section-icon">ğŸ¯</span>
                <h2>æ¯”èµ›ç»“æœ</h2>
            </div>
            <div class="form-group">
                <label for="resultsTournament">é€‰æ‹©æ¯”èµ›:</label>
                <select id="resultsTournament">
                    <option value="">--è¯·é€‰æ‹©æ¯”èµ›--</option>
                </select>
                <button id="showTournamentResults" class="success">æŸ¥çœ‹æ¯”èµ›ç»“æœ</button>
            </div>
            
            <div id="tournamentResultsDisplay" class="history-display">
                <!-- æ¯”èµ›ç»“æœå°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
            </div>
        </div>
        
        <!-- æˆå‘˜ç®¡ç†é¡µé¢ (ä»…ç®¡ç†å‘˜å¯è§) -->
        <div id="members" class="tab-content admin-only">
            <div class="section-header">
                <span class="section-icon">ğŸ‘¥</span>
                <h2>æˆå‘˜ç®¡ç†</h2>
            </div>
            <div class="row">
                <div class="col">
                    <h3>æ·»åŠ æ–°æˆå‘˜</h3>
                    <div class="form-group">
                        <label for="memberName">å§“å:</label>
                        <input type="text" id="memberName" placeholder="è¯·è¾“å…¥å§“å">
                    </div>
                    <div class="form-group">
                        <label for="initialScore">åˆå§‹ç§¯åˆ†:</label>
                        <input type="number" id="initialScore" value="1500">
                    </div>
                    <button id="addMember" class="success">æ·»åŠ æˆå‘˜</button>
                </div>
                
                <div class="col">
                    <h3>æ‰€æœ‰æˆå‘˜</h3>
                    <div id="membersList" class="member-list">
                        <!-- æˆå‘˜åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                    </div>
                    <button id="deleteMember" class="danger">åˆ é™¤é€‰ä¸­æˆå‘˜</button>
                </div>
            </div>
        </div>
        
        <!-- å¯¹æˆ˜è®°å½•é¡µé¢ (ä»…ç®¡ç†å‘˜å¯è§) -->
        <div id="battle" class="tab-content admin-only">
            <div class="section-header">
                <span class="section-icon">âš”ï¸</span>
                <h2>å¯¹æˆ˜è®°å½•</h2>
            </div>
            <div class="row">
                <div class="col">
                    <h3>é€‰æ‹©å¯¹æˆ˜æˆå‘˜</h3>
                    <div class="form-group">
                        <label for="member1">æˆå‘˜1:</label>
                        <select id="member1">
                            <option value="">--è¯·é€‰æ‹©æˆå‘˜--</option>
                        </select>
                        <div id="member1Score">å½“å‰ç§¯åˆ†: -</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="member2">æˆå‘˜2:</label>
                        <select id="member2">
                            <option value="">--è¯·é€‰æ‹©æˆå‘˜--</option>
                        </select>
                        <div id="member2Score">å½“å‰ç§¯åˆ†: -</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="eventName">èµ›äº‹åç§°:</label>
                        <input type="text" id="eventName" value="æ—¥å¸¸å¯¹æˆ˜">
                    </div>
                    
                    <div class="form-group">
                        <label>å¯¹æˆ˜ç»“æœ:</label>
                        <div>
                            <input type="radio" id="member1Win" name="battleResult" value="member1_win">
                            <label for="member1Win" style="display: inline;">æˆå‘˜1è·èƒœ</label>
                        </div>
                        <div>
                            <input type="radio" id="member2Win" name="battleResult" value="member2_win">
                            <label for="member2Win" style="display: inline;">æˆå‘˜2è·èƒœ</label>
                        </div>
                        <div>
                            <input type="radio" id="draw" name="battleResult" value="draw">
                            <label for="draw" style="display: inline;">å¹³å±€</label>
                        </div>
                        <div>
                            <input type="radio" id="forfeit1" name="battleResult" value="forfeit1">
                            <label for="forfeit1" style="display: inline;">æˆå‘˜1å¼ƒæƒ</label>
                        </div>
                        <div>
                            <input type="radio" id="forfeit2" name="battleResult" value="forfeit2">
                            <label for="forfeit2" style="display: inline;">æˆå‘˜2å¼ƒæƒ</label>
                        </div>
                    </div>
                    
                    <button id="recordBattle" class="success">è®°å½•å¯¹æˆ˜ç»“æœ</button>
                </div>
                
                <div class="col">
                    <h3>æœ€è¿‘å¯¹æˆ˜è®°å½•</h3>
                    <div id="battleLog" class="battle-log">
                        <!-- å¯¹æˆ˜æ—¥å¿—å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ¯”èµ›ç®¡ç†é¡µé¢ (ä»…ç®¡ç†å‘˜å¯è§) -->
        <div id="tournament" class="tab-content admin-only">
            <div class="section-header">
                <span class="section-icon">ğŸ…</span>
                <h2>æ¯”èµ›ç®¡ç†</h2>
            </div>
            <div class="row">
                <div class="col">
                    <h3>åˆ›å»ºæ–°æ¯”èµ›</h3>
                    <div class="form-group">
                        <label for="tournamentName">æ¯”èµ›åç§°:</label>
                        <input type="text" id="tournamentName" placeholder="è¯·è¾“å…¥æ¯”èµ›åç§°">
                    </div>
                    
                    <div class="form-group">
                        <label>é€‰æ‹©å‚èµ›æˆå‘˜:</label>
                        <button id="selectAllMembers">å…¨é€‰</button>
                        <div id="memberSelectList" class="member-list">
                            <!-- æˆå‘˜é€‰æ‹©åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>æ¯”èµ›è®¾ç½®:</label>
                        <div class="row">
                            <div class="col">
                                <label for="groupSize">æ¯ç»„äººæ•°:</label>
                                <select id="groupSize">
                                    <option value="3">3äºº</option>
                                    <option value="4">4äºº</option>
                                    <option value="5">5äºº</option>
                                    <option value="6">6äºº</option>
                                    <option value="7">7äºº</option>
                                    <option value="8">8äºº</option>
                                    <option value="9">9äºº</option>
                                    <option value="10">10äºº</option>
                                </select>
                            </div>
                            <div class="col">
                                <label for="advanceCount">æ¯ç»„æ™‹çº§äººæ•°:</label>
                                <select id="advanceCount">
                                    <option value="1">1äºº</option>
                                    <option value="2">2äºº</option>
                                    <option value="3">3äºº</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <button id="createTournament" class="success">åˆ›å»ºæ¯”èµ›å¹¶åˆ†ç»„</button>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label for="tournamentSelect">é€‰æ‹©æ¯”èµ›:</label>
                        <select id="tournamentSelect">
                            <option value="">--è¯·é€‰æ‹©æ¯”èµ›--</option>
                        </select>
                        <button id="enterTournament" class="success">è¿›å…¥æ¯”èµ›</button>
                    </div>
                </div>
                
                <div class="col">
                    <h3>åˆ†ç»„æƒ…å†µ</h3>
                    <div id="groupDisplay" class="group-display">
                        <!-- åˆ†ç»„æƒ…å†µå°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ¯”èµ›å¯¹æˆ˜é¡µé¢ (ä»…ç®¡ç†å‘˜å¯è§) -->
        <div id="tournament-battle" class="tab-content admin-only">
            <div class="section-header">
                <span class="section-icon">ğŸ®</span>
                <h2>æ¯”èµ›å¯¹æˆ˜</h2>
            </div>
            <div class="tournament-info">
                <h3 id="currentTournamentName">å½“å‰æ¯”èµ›: æ— </h3>
                <div id="championDisplay" class="champion-display" style="display: none;">
                    <!-- å† å†›ä¿¡æ¯å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                </div>
            </div>
            
            <div class="tournament-stage">
                <h3>æ¯”èµ›é˜¶æ®µ:</h3>
                <div class="stage-buttons">
                    <button id="groupStageBtn" class="success">å°ç»„èµ›</button>
                    <button id="knockoutStageBtn">æ·˜æ±°èµ›</button>
                    <button id="generateKnockoutBtn" class="success" style="display: none;">ç”Ÿæˆæ·˜æ±°èµ›</button>
                </div>
                
                <div id="groupStageContent" class="stage-content">
                    <!-- å°ç»„èµ›å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                </div>
                
                <div id="knockoutStageContent" class="stage-content" style="display: none;">
                    <!-- æ·˜æ±°èµ›å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                </div>
            </div>
        </div>
        
        <!-- ç³»ç»Ÿç®¡ç†é¡µé¢ (ä»…ç®¡ç†å‘˜å¯è§) -->
        <div id="admin" class="tab-content admin-only">
            <div class="section-header">
                <span class="section-icon">âš™ï¸</span>
                <h2>ç³»ç»Ÿç®¡ç†</h2>
            </div>
            <div class="row">
                <div class="col">
                    <h3>ç³»ç»ŸçŠ¶æ€</h3>
                    <div class="stat-item">
                        <div class="stat-label">æˆå‘˜æ•°é‡</div>
                        <div id="memberCount" class="stat-value">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">å¯¹æˆ˜è®°å½•æ•°é‡</div>
                        <div id="battleCount" class="stat-value">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">æ¯”èµ›æ•°é‡</div>
                        <div id="tournamentCount" class="stat-value">0</div>
                    </div>
                    
                    <h3>æ•°æ®ç®¡ç†</h3>
                    <button id="backupData" class="success">å¤‡ä»½æ•°æ®</button>
                    <button id="restoreData" class="success">æ¢å¤æ•°æ®</button>
                    
                    <h3>ç³»ç»Ÿåˆå§‹åŒ–</h3>
                    <div class="warning">è­¦å‘Š: åˆå§‹åŒ–å°†åˆ é™¤æ‰€æœ‰æ•°æ®ï¼Œæ­¤æ“ä½œä¸å¯é€†!</div>
                    <button id="initializeSystem" class="danger">åˆå§‹åŒ–ç³»ç»Ÿæ•°æ®</button>
                    
                    <h3>é€€å‡ºç®¡ç†å‘˜æ¨¡å¼</h3>
                    <button id="exitAdmin" class="danger">é€€å‡ºç®¡ç†å‘˜æ¨¡å¼</button>
                </div>
            </div>
        </div>
        
        <!-- é¡µè„š -->
        <div class="footer">
            <div class="copyright">æœ€ç»ˆè§£é‡Šæƒå½’è‹±æ‰å®éªŒå­¦é™¢ä¹’ä¹“çƒç¤¾å›¢æ‰€æœ‰</div>
            <div class="creator">ç³»ç»Ÿè®¾è®¡ï¼šå´”é“­æ­£</div>
        </div>
    </div>
    
    <!-- ç®¡ç†å‘˜ç™»å½•æ¨¡æ€æ¡† -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç®¡ç†å‘˜ç™»å½•</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="login-form">
                <div class="form-group">
                    <label for="password">è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç :</label>
                    <input type="password" id="password" placeholder="å¯†ç ">
                </div>
                <button id="loginBtn" class="success">ç™»å½•</button>
            </div>
        </div>
    </div>

    <!-- æ¯”èµ›å¯¹æˆ˜ç»“æœè®°å½•æ¨¡æ€æ¡† -->
    <div id="battleResultModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="battleModalTitle">è®°å½•æ¯”èµ›å¯¹æˆ˜ç»“æœ</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="battle-form">
                <div class="form-group">
                    <h4 id="battlePlayers"></h4>
                </div>
                <div class="form-group">
                    <label>é€‰æ‹©æ¯”åˆ†:</label>
                    <div id="battleResultOptions" class="score-options">
                        <!-- æ¯”åˆ†é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                    </div>
                </div>
                <button id="confirmBattle" class="success">ç¡®è®¤è®°å½•</button>
                <button id="deleteBattle" class="danger" style="display: none;">åˆ é™¤è®°å½•</button>
            </div>
        </div>
    </div>

    <!-- æ·˜æ±°èµ›è®°å½•æ¨¡æ€æ¡† -->
    <div id="knockoutModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>è®°å½•æ·˜æ±°èµ›ç»“æœ</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="knockout-form">
                <div class="form-group">
                    <label for="knockoutMatchSelect">é€‰æ‹©æ·˜æ±°èµ›å¯¹é˜µ:</label>
                    <select id="knockoutMatchSelect">
                        <option value="">--è¯·é€‰æ‹©å¯¹é˜µ--</option>
                    </select>
                </div>
                <button id="selectKnockoutMatch" class="success">é€‰æ‹©å¯¹é˜µ</button>
            </div>
        </div>
    </div>

    <script>
        // æ•°æ®å­˜å‚¨
        let members = {};
        let battleHistory = [];
        let tournaments = [];
        let currentTournament = null;
        let adminMode = false;
        let currentGroupIndex = 0;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            setupEventListeners();
            updateRanking();
            updateMemberLists();
            updateAdminStats();
            updateTournamentLists();
        });

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // é€‰é¡¹å¡åˆ‡æ¢
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });

            // ç®¡ç†å‘˜ç™»å½•
            document.getElementById('adminLoginBtn').addEventListener('click', () => {
                document.getElementById('loginModal').style.display = 'flex';
            });
            document.getElementById('loginBtn').addEventListener('click', adminLogin);
            document.querySelector('.close-btn').addEventListener('click', () => {
                document.getElementById('loginModal').style.display = 'none';
            });

            // ç§¯åˆ†æ’å
            document.getElementById('refreshRanking').addEventListener('click', updateRanking);

            // å†å²æˆ˜ç»©
            document.getElementById('showHistory').addEventListener('click', showMemberHistory);

            // æ¯”èµ›ç»“æœ
            document.getElementById('showTournamentResults').addEventListener('click', showTournamentResults);

            // æˆå‘˜ç®¡ç†
            document.getElementById('addMember').addEventListener('click', addMember);
            document.getElementById('deleteMember').addEventListener('click', deleteMember);

            // å¯¹æˆ˜è®°å½•
            document.getElementById('member1').addEventListener('change', updateMemberScores);
            document.getElementById('member2').addEventListener('change', updateMemberScores);
            document.getElementById('recordBattle').addEventListener('click', recordBattle);

            // æ¯”èµ›ç®¡ç†
            document.getElementById('selectAllMembers').addEventListener('click', selectAllMembers);
            document.getElementById('createTournament').addEventListener('click', createTournament);
            document.getElementById('enterTournament').addEventListener('click', enterTournament);

            // æ¯”èµ›å¯¹æˆ˜
            document.getElementById('groupStageBtn').addEventListener('click', () => {
                document.getElementById('groupStageContent').style.display = 'block';
                document.getElementById('knockoutStageContent').style.display = 'none';
                document.getElementById('groupStageBtn').classList.add('success');
                document.getElementById('knockoutStageBtn').classList.remove('success');
                setupGroupStageDisplay();
            });
            
            document.getElementById('knockoutStageBtn').addEventListener('click', () => {
                document.getElementById('groupStageContent').style.display = 'none';
                document.getElementById('knockoutStageContent').style.display = 'block';
                document.getElementById('knockoutStageBtn').classList.add('success');
                document.getElementById('groupStageBtn').classList.remove('success');
                setupKnockoutStageDisplay();
            });

            document.getElementById('generateKnockoutBtn').addEventListener('click', generateKnockoutStage);

            // ç³»ç»Ÿç®¡ç†
            document.getElementById('backupData').addEventListener('click', backupData);
            document.getElementById('restoreData').addEventListener('click', restoreData);
            document.getElementById('initializeSystem').addEventListener('click', initializeSystem);
            document.getElementById('exitAdmin').addEventListener('click', exitAdminMode);

            // å¯¹æˆ˜ç»“æœæ¨¡æ€æ¡†
            document.getElementById('confirmBattle').addEventListener('click', confirmBattleResult);
            document.getElementById('deleteBattle').addEventListener('click', deleteBattleRecord);
            document.querySelectorAll('#battleResultModal .close-btn')[0].addEventListener('click', () => {
                document.getElementById('battleResultModal').style.display = 'none';
            });

            // æ·˜æ±°èµ›æ¨¡æ€æ¡†
            document.getElementById('selectKnockoutMatch').addEventListener('click', selectKnockoutMatch);
            document.querySelectorAll('#knockoutModal .close-btn')[0].addEventListener('click', () => {
                document.getElementById('knockoutModal').style.display = 'none';
            });
        }

        // åˆ‡æ¢é€‰é¡¹å¡
        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                }
            });

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                if (content.id === tabId) {
                    content.classList.add('active');
                }
            });
        }

        // ç®¡ç†å‘˜ç™»å½•
        function adminLogin() {
            const password = document.getElementById('password').value;
            if (password === '1092973377') {
                adminMode = true;
                document.getElementById('loginModal').style.display = 'none';
                document.body.classList.add('admin-mode');
                document.getElementById('adminStatus').style.display = 'inline-block';
                document.getElementById('adminLoginBtn').textContent = 'ç®¡ç†å‘˜é€€å‡º';
                document.getElementById('adminLoginBtn').classList.remove('success');
                document.getElementById('adminLoginBtn').classList.add('danger');
                document.getElementById('adminLoginBtn').removeEventListener('click', adminLogin);
                document.getElementById('adminLoginBtn').addEventListener('click', exitAdminMode);
                alert('ç®¡ç†å‘˜æ¨¡å¼å·²å¯ç”¨');
            } else if (password) {
                alert('å¯†ç é”™è¯¯');
            }
        }

        // é€€å‡ºç®¡ç†å‘˜æ¨¡å¼
        function exitAdminMode() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç®¡ç†å‘˜æ¨¡å¼å—ï¼Ÿ')) {
                adminMode = false;
                document.body.classList.remove('admin-mode');
                document.getElementById('adminStatus').style.display = 'none';
                document.getElementById('adminLoginBtn').textContent = 'ç®¡ç†å‘˜ç™»å½•';
                document.getElementById('adminLoginBtn').classList.remove('danger');
                document.getElementById('adminLoginBtn').classList.add('success');
                document.getElementById('adminLoginBtn').removeEventListener('click', exitAdminMode);
                document.getElementById('adminLoginBtn').addEventListener('click', () => {
                    document.getElementById('loginModal').style.display = 'flex';
                });
                alert('å·²é€€å‡ºç®¡ç†å‘˜æ¨¡å¼');
            }
        }

        // åŠ è½½æ•°æ®
        function loadData() {
            const savedMembers = localStorage.getItem('pingpong_members');
            const savedHistory = localStorage.getItem('pingpong_history');
            const savedTournaments = localStorage.getItem('pingpong_tournaments');

            if (savedMembers) {
                members = JSON.parse(savedMembers);
            }

            if (savedHistory) {
                battleHistory = JSON.parse(savedHistory);
            }

            if (savedTournaments) {
                tournaments = JSON.parse(savedTournaments);
            }
        }

        // ä¿å­˜æ•°æ®
        function saveData() {
            localStorage.setItem('pingpong_members', JSON.stringify(members));
            localStorage.setItem('pingpong_history', JSON.stringify(battleHistory));
            localStorage.setItem('pingpong_tournaments', JSON.stringify(tournaments));
            updateAdminStats();
        }

        // æ›´æ–°ç®¡ç†å‘˜ç»Ÿè®¡ä¿¡æ¯
        function updateAdminStats() {
            document.getElementById('memberCount').textContent = Object.keys(members).length;
            document.getElementById('battleCount').textContent = battleHistory.length;
            document.getElementById('tournamentCount').textContent = tournaments.length;
        }

        // è®¡ç®—å‚ä¸èµ›äº‹æ¬¡æ•°æ’å
        function calculateTournamentParticipationRanking() {
            const participationStats = {};
            
            // åˆå§‹åŒ–æ¯ä¸ªæˆå‘˜çš„ç»Ÿè®¡æ•°æ®
            Object.keys(members).forEach(name => {
                participationStats[name] = 0;
            });
            
            // éå†æ‰€æœ‰æ¯”èµ›ï¼Œç»Ÿè®¡æ¯ä¸ªæˆå‘˜çš„å‚ä¸æ¬¡æ•°
            tournaments.forEach(tournament => {
                if (tournament.participants) {
                    tournament.participants.forEach(participant => {
                        if (participationStats[participant] !== undefined) {
                            participationStats[participant]++;
                        }
                    });
                }
            });
            
            // è½¬æ¢ä¸ºæ•°ç»„å¹¶æŒ‰å‚ä¸æ¬¡æ•°æ’åº
            const sortedStats = Object.entries(participationStats)
                .sort((a, b) => b[1] - a[1]);
            
            return sortedStats;
        }

        // è®¡ç®—èƒœåœºæ•°é‡æ’å
        function calculateWinsRanking() {
            const winsStats = {};
            
            // åˆå§‹åŒ–æ¯ä¸ªæˆå‘˜çš„ç»Ÿè®¡æ•°æ®
            Object.keys(members).forEach(name => {
                winsStats[name] = 0;
            });
            
            // éå†æ‰€æœ‰å¯¹æˆ˜è®°å½•ï¼Œç»Ÿè®¡æ¯ä¸ªæˆå‘˜çš„èƒœåœºæ•°
            battleHistory.forEach(battle => {
                if (battle.result === 'member1_win') {
                    winsStats[battle.member1]++;
                } else if (battle.result === 'member2_win') {
                    winsStats[battle.member2]++;
                }
                // æ³¨æ„ï¼šå¼ƒæƒä¸ç®—èƒœåœº
            });
            
            // è½¬æ¢ä¸ºæ•°ç»„å¹¶æŒ‰èƒœåœºæ•°æ’åº
            const sortedStats = Object.entries(winsStats)
                .sort((a, b) => b[1] - a[1]);
            
            return sortedStats;
        }

        // æ›´æ–°ç§¯åˆ†æ’å
        function updateRanking() {
            // æ›´æ–°ç§¯åˆ†æ’å
            const rankingBody = document.getElementById('rankingBody');
            rankingBody.innerHTML = '';

            // æŒ‰ç§¯åˆ†æ’åº
            const sortedMembers = Object.entries(members)
                .sort((a, b) => b[1] - a[1])
                .map(([name, score], index) => ({ rank: index + 1, name, score }));

            sortedMembers.forEach(member => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${member.rank}</td>
                    <td>${member.name}</td>
                    <td>${member.score}</td>
                `;
                rankingBody.appendChild(row);
            });
            
            // æ›´æ–°å‚ä¸èµ›äº‹æ¬¡æ•°æ’å
            const tournamentParticipationBody = document.getElementById('tournamentParticipationBody');
            tournamentParticipationBody.innerHTML = '';
            
            const tournamentParticipationRanking = calculateTournamentParticipationRanking();
            tournamentParticipationRanking.forEach(([name, count], index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${name}</td>
                    <td>${count}</td>
                `;
                tournamentParticipationBody.appendChild(row);
            });
            
            // æ›´æ–°èƒœåœºæ•°é‡æ’å
            const winsBody = document.getElementById('winsBody');
            winsBody.innerHTML = '';
            
            const winsRanking = calculateWinsRanking();
            winsRanking.forEach(([name, wins], index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${name}</td>
                    <td>${wins}</td>
                `;
                winsBody.appendChild(row);
            });
        }

        // æ›´æ–°æˆå‘˜åˆ—è¡¨
        function updateMemberLists() {
            // æ›´æ–°å†å²æˆ˜ç»©æˆå‘˜ä¸‹æ‹‰æ¡†
            const historyMember = document.getElementById('historyMember');
            historyMember.innerHTML = '<option value="">--è¯·é€‰æ‹©æˆå‘˜--</option>';
            
            Object.keys(members).forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                historyMember.appendChild(option);
            });

            // æ›´æ–°å¯¹æˆ˜è®°å½•æˆå‘˜ä¸‹æ‹‰æ¡†
            const member1 = document.getElementById('member1');
            const member2 = document.getElementById('member2');
            member1.innerHTML = member2.innerHTML = '<option value="">--è¯·é€‰æ‹©æˆå‘˜--</option>';
            
            Object.keys(members).forEach(name => {
                const option1 = document.createElement('option');
                option1.value = name;
                option1.textContent = name;
                member1.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = name;
                option2.textContent = name;
                member2.appendChild(option2);
            });

            // æ›´æ–°æˆå‘˜ç®¡ç†åˆ—è¡¨
            const membersList = document.getElementById('membersList');
            membersList.innerHTML = '';
            
            Object.entries(members).forEach(([name, score]) => {
                const memberItem = document.createElement('div');
                memberItem.className = 'member-item';
                memberItem.innerHTML = `
                    <span>${name}: ${score}åˆ†</span>
                    <input type="checkbox" data-name="${name}">
                `;
                membersList.appendChild(memberItem);
            });

            // æ›´æ–°æ¯”èµ›ç®¡ç†æˆå‘˜é€‰æ‹©åˆ—è¡¨
            const memberSelectList = document.getElementById('memberSelectList');
            memberSelectList.innerHTML = '';
            
            Object.keys(members).forEach(name => {
                const memberItem = document.createElement('div');
                memberItem.className = 'member-item';
                memberItem.innerHTML = `
                    <span>${name}</span>
                    <input type="checkbox" data-name="${name}">
                `;
                memberSelectList.appendChild(memberItem);
            });
        }

        // æ›´æ–°æ¯”èµ›åˆ—è¡¨
        function updateTournamentLists() {
            // æ›´æ–°æ¯”èµ›ç®¡ç†ä¸‹æ‹‰æ¡†
            const tournamentSelect = document.getElementById('tournamentSelect');
            tournamentSelect.innerHTML = '<option value="">--è¯·é€‰æ‹©æ¯”èµ›--</option>';
            
            tournaments.forEach(tournament => {
                const option = document.createElement('option');
                option.value = tournament.name;
                option.textContent = tournament.name;
                tournamentSelect.appendChild(option);
            });

            // æ›´æ–°æ¯”èµ›ç»“æœä¸‹æ‹‰æ¡†
            const resultsTournament = document.getElementById('resultsTournament');
            resultsTournament.innerHTML = '<option value="">--è¯·é€‰æ‹©æ¯”èµ›--</option>';
            
            tournaments.forEach(tournament => {
                const option = document.createElement('option');
                option.value = tournament.name;
                option.textContent = tournament.name;
                resultsTournament.appendChild(option);
            });
        }

        // æ˜¾ç¤ºæˆå‘˜å†å²æˆ˜ç»©
        function showMemberHistory() {
            const member = document.getElementById('historyMember').value;
            if (!member) {
                alert('è¯·é€‰æ‹©æˆå‘˜');
                return;
            }

            // ç»Ÿè®¡æˆ˜ç»©
            let wins = 0, losses = 0, draws = 0, forfeits = 0;
            const memberBattles = battleHistory.filter(battle => 
                battle.member1 === member || battle.member2 === member
            );

            memberBattles.forEach(battle => {
                if (battle.result === 'member1_win') {
                    if (battle.member1 === member) wins++;
                    else losses++;
                } else if (battle.result === 'member2_win') {
                    if (battle.member2 === member) wins++;
                    else losses++;
                } else if (battle.result === 'draw') {
                    draws++;
                } else if (battle.result === 'forfeit1') {
                    if (battle.member1 === member) forfeits++;
                    else wins++;
                } else if (battle.result === 'forfeit2') {
                    if (battle.member2 === member) forfeits++;
                    else wins++;
                }
            });

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            const totalBattles = wins + losses + draws + forfeits;
            const winRate = totalBattles > 0 ? (wins / totalBattles * 100).toFixed(1) : 0;

            document.getElementById('winsCount').textContent = wins;
            document.getElementById('lossesCount').textContent = losses;
            document.getElementById('drawsCount').textContent = draws;
            document.getElementById('winRate').textContent = `${winRate}%`;

            // æ˜¾ç¤ºå†å²æˆ˜ç»©
            const historyDisplay = document.getElementById('historyDisplay');
            let historyText = `${member} çš„å†å²æˆ˜ç»© (å…± ${totalBattles} åœº):\n\n`;

            if (memberBattles.length === 0) {
                historyText += 'æš‚æ— å¯¹æˆ˜è®°å½•';
            } else {
                // æŒ‰æ—¶é—´å€’åºæ’åˆ—
                memberBattles.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                memberBattles.forEach(battle => {
                    let opponent, result;
                    
                    if (battle.member1 === member) {
                        opponent = battle.member2;
                        if (battle.result === 'member1_win') result = 'èƒœåˆ©';
                        else if (battle.result === 'member2_win') result = 'å¤±è´¥';
                        else if (battle.result === 'draw') result = 'å¹³å±€';
                        else if (battle.result === 'forfeit1') result = 'å¼ƒæƒ';
                        else if (battle.result === 'forfeit2') result = 'å¯¹æ‰‹å¼ƒæƒ';
                    } else {
                        opponent = battle.member1;
                        if (battle.result === 'member2_win') result = 'èƒœåˆ©';
                        else if (battle.result === 'member1_win') result = 'å¤±è´¥';
                        else if (battle.result === 'draw') result = 'å¹³å±€';
                        else if (battle.result === 'forfeit2') result = 'å¼ƒæƒ';
                        else if (battle.result === 'forfeit1') result = 'å¯¹æ‰‹å¼ƒæƒ';
                    }
                    
                    const date = battle.date || 'æœªçŸ¥æ—¥æœŸ';
                    const eventName = battle.event_name || 'æ—¥å¸¸å¯¹æˆ˜';
                    
                    historyText += `${date} - [${eventName}] å¯¹æˆ˜ ${opponent}: ${result}\n`;
                });
            }

            historyDisplay.textContent = historyText;
        }

        // æ˜¾ç¤ºæ¯”èµ›ç»“æœ
        function showTournamentResults() {
            const tournamentName = document.getElementById('resultsTournament').value;
            if (!tournamentName) {
                alert('è¯·é€‰æ‹©æ¯”èµ›');
                return;
            }

            // æŸ¥æ‰¾æ¯”èµ›
            const tournament = tournaments.find(t => t.name === tournamentName);
            if (!tournament) {
                alert('æœªæ‰¾åˆ°é€‰æ‹©çš„æ¯”èµ›');
                return;
            }

            // ç”Ÿæˆæ¯”èµ›ç»“æœæ–‡æœ¬
            let resultsText = `æ¯”èµ›åç§°: ${tournament.name}\n`;
            resultsText += `åˆ›å»ºæ—¶é—´: ${tournament.timestamp || 'æœªçŸ¥'}\n`;
            resultsText += `æ¯”èµ›çŠ¶æ€: ${tournament.status || 'æœªçŸ¥'}\n\n`;

            // æ˜¾ç¤ºå† å†›ä¿¡æ¯
            if (tournament.champion) {
                resultsText += `ğŸ† å† å†›: ${tournament.champion} ğŸ†\n`;
            }
            if (tournament.runnerUp) {
                resultsText += `ğŸ¥ˆ äºšå†›: ${tournament.runnerUp} ğŸ¥ˆ\n`;
            }
            if (tournament.thirdPlace) {
                resultsText += `ğŸ¥‰ å­£å†›: ${tournament.thirdPlace} ğŸ¥‰\n`;
            }
            resultsText += "\n";

            // æ˜¾ç¤ºå°ç»„èµ›ç»“æœ
            resultsText += "=== å°ç»„èµ›ç»“æœ ===\n\n";

            if (tournament.groups) {
                tournament.groups.forEach((group, i) => {
                    resultsText += `ç¬¬ ${i + 1} ç»„:\n`;

                    // è®¡ç®—å°ç»„ç§¯åˆ†
                    const groupStats = calculateGroupStats(group, tournament.name);

                    // æŒ‰ç§¯åˆ†æ’åº
                    const sortedStats = Object.entries(groupStats)
                        .sort((a, b) => b[1].points - a[1].points);

                    sortedStats.forEach(([name, stats], index) => {
                        resultsText += `  ${index + 1}. ${name} - ç§¯åˆ†: ${stats.points}, èƒœ: ${stats.wins}, è´Ÿ: ${stats.losses}, å¼ƒæƒ: ${stats.forfeits}\n`;
                    });

                    // æ˜¾ç¤ºæ™‹çº§é€‰æ‰‹
                    if (tournament.advanceCount && sortedStats.length > 0) {
                        resultsText += `  æ™‹çº§: `;
                        for (let i = 0; i < Math.min(tournament.advanceCount, sortedStats.length); i++) {
                            resultsText += `${sortedStats[i][0]}${i < Math.min(tournament.advanceCount, sortedStats.length) - 1 ? ', ' : ''}`;
                        }
                        resultsText += `\n`;
                    }

                    resultsText += "\n";
                });
            }

            // æ˜¾ç¤ºæ·˜æ±°èµ›ç»“æœ
            if (tournament.knockout_bracket) {
                resultsText += "=== æ·˜æ±°èµ›ç»“æœ ===\n\n";

                Object.entries(tournament.knockout_bracket).forEach(([roundName, matches]) => {
                    resultsText += `${roundName}:\n`;
                    matches.forEach(match => {
                        if (match.completed) {
                            resultsText += `  ${match.player1} vs ${match.player2} -> ${match.winner}\n`;
                        } else {
                            resultsText += `  ${match.player1} vs ${match.player2} (æœªå®Œæˆ)\n`;
                        }
                    });
                    resultsText += "\n";
                });
            }

            // æ˜¾ç¤ºæ¯”èµ›è¿‡ç¨‹
            resultsText += "=== æ¯”èµ›è¿‡ç¨‹ ===\n\n";

            // æŸ¥æ‰¾è¯¥æ¯”èµ›çš„æ‰€æœ‰å¯¹æˆ˜è®°å½•
            const tournamentBattles = battleHistory.filter(battle => 
                battle.event_name === tournament.name
            );

            if (tournamentBattles.length > 0) {
                // æŒ‰æ—¶é—´æ’åº
                tournamentBattles.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                tournamentBattles.forEach(battle => {
                    const date = battle.date || 'æœªçŸ¥æ—¥æœŸ';
                    const { member1, member2 } = battle;

                    let result;
                    if (battle.result === 'member1_win') {
                        result = `${member1} èƒœ`;
                    } else if (battle.result === 'member2_win') {
                        result = `${member2} èƒœ`;
                    } else if (battle.result === 'draw') {
                        result = 'å¹³å±€';
                    } else if (battle.result === 'forfeit1') {
                        result = `${member1} å¼ƒæƒ`;
                    } else if (battle.result === 'forfeit2') {
                        result = `${member2} å¼ƒæƒ`;
                    }

                    resultsText += `${date}: ${member1} vs ${member2} -> ${result}\n`;
                });
            } else {
                resultsText += "æš‚æ— æ¯”èµ›è®°å½•\n";
            }

            // æ˜¾ç¤ºç»“æœ
            document.getElementById('tournamentResultsDisplay').textContent = resultsText;
        }

        // æ·»åŠ æˆå‘˜
        function addMember() {
            const name = document.getElementById('memberName').value.trim();
            const scoreStr = document.getElementById('initialScore').value.trim();

            if (!name) {
                alert('è¯·è¾“å…¥å§“å');
                return;
            }

            const score = parseInt(scoreStr);
            if (isNaN(score)) {
                alert('ç§¯åˆ†å¿…é¡»æ˜¯æ•´æ•°');
                return;
            }

            members[name] = score;
            saveData();
            updateMemberLists();
            updateRanking();

            document.getElementById('memberName').value = '';
            alert(`æˆå‘˜ ${name} æ·»åŠ æˆåŠŸ`);
        }

        // åˆ é™¤æˆå‘˜
        function deleteMember() {
            const checkboxes = document.querySelectorAll('#membersList input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                alert('è¯·é€‰æ‹©è¦åˆ é™¤çš„æˆå‘˜');
                return;
            }

            const names = Array.from(checkboxes).map(cb => cb.getAttribute('data-name'));
            if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${names.length} åæˆå‘˜å—ï¼Ÿè¿™å°†åˆ é™¤è¿™äº›æˆå‘˜çš„æ‰€æœ‰æ•°æ®ï¼Œä¸”ä¸å¯æ¢å¤ï¼`)) {
                names.forEach(name => {
                    delete members[name];
                    // ä»å¯¹æˆ˜è®°å½•ä¸­åˆ é™¤
                    battleHistory = battleHistory.filter(battle => 
                        battle.member1 !== name && battle.member2 !== name
                    );
                    // ä»æ¯”èµ›è®°å½•ä¸­åˆ é™¤
                    tournaments.forEach(tournament => {
                        if (tournament.participants && tournament.participants.includes(name)) {
                            tournament.participants = tournament.participants.filter(p => p !== name);
                        }
                        if (tournament.groups) {
                            tournament.groups.forEach(group => {
                                const index = group.indexOf(name);
                                if (index !== -1) {
                                    group.splice(index, 1);
                                }
                            });
                        }
                    });
                });

                // åˆ é™¤ç©ºçš„åˆ†ç»„å’Œç©ºæ¯”èµ›
                tournaments = tournaments.filter(tournament => 
                    tournament.participants && tournament.participants.length > 0
                );

                saveData();
                updateMemberLists();
                updateRanking();
                updateTournamentLists();
                alert('é€‰ä¸­çš„æˆå‘˜å·²åˆ é™¤');
            }
        }

        // æ›´æ–°æˆå‘˜ç§¯åˆ†æ˜¾ç¤º
        function updateMemberScores() {
            const member1 = document.getElementById('member1').value;
            const member2 = document.getElementById('member2').value;

            document.getElementById('member1Score').textContent = 
                member1 && members[member1] ? `å½“å‰ç§¯åˆ†: ${members[member1]}` : 'å½“å‰ç§¯åˆ†: -';
            
            document.getElementById('member2Score').textContent = 
                member2 && members[member2] ? `å½“å‰ç§¯åˆ†: ${members[member2]}` : 'å½“å‰ç§¯åˆ†: -';
        }

        // è®¡ç®—ç§¯åˆ†å˜åŒ–
        function calculateRatingChange(playerRating, opponentRating, result, kFactor = 32) {
            const expectedScore = 1 / (1 + Math.pow(10, (opponentRating - playerRating) / 400));
            const ratingChange = kFactor * (result - expectedScore);
            return Math.round(ratingChange);
        }

        // è®°å½•å¯¹æˆ˜ç»“æœ
        function recordBattle() {
            const member1 = document.getElementById('member1').value;
            const member2 = document.getElementById('member2').value;
            const result = document.querySelector('input[name="battleResult"]:checked').value;
            const eventName = document.getElementById('eventName').value.trim() || 'æ—¥å¸¸å¯¹æˆ˜';

            if (!member1 || !member2) {
                alert('è¯·é€‰æ‹©å¯¹æˆ˜æˆå‘˜');
                return;
            }

            if (member1 === member2) {
                alert('ä¸èƒ½é€‰æ‹©ç›¸åŒçš„æˆå‘˜');
                return;
            }

            // è·å–å½“å‰ç§¯åˆ†
            const member1Rating = members[member1];
            const member2Rating = members[member2];

            // åˆ›å»ºå¯¹æˆ˜è®°å½•
            const battleRecord = {
                member1,
                member2,
                result,
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' }),
                event_name: eventName,
                member1_rating_before: member1Rating,
                member2_rating_before: member2Rating
            };

            // æ ¹æ®ç»“æœè®¡ç®—ç§¯åˆ†å˜åŒ–
            let member1Change, member2Change, logText;

            if (result === 'member1_win') {
                // æˆå‘˜1è·èƒœ
                member1Change = calculateRatingChange(member1Rating, member2Rating, 1);
                member2Change = calculateRatingChange(member2Rating, member1Rating, 0);
                logText = `${member1} æˆ˜èƒœäº† ${member2}`;
            } else if (result === 'member2_win') {
                // æˆå‘˜2è·èƒœ
                member1Change = calculateRatingChange(member1Rating, member2Rating, 0);
                member2Change = calculateRatingChange(member2Rating, member1Rating, 1);
                logText = `${member2} æˆ˜èƒœäº† ${member1}`;
            } else if (result === 'draw') { // å¹³å±€
                member1Change = calculateRatingChange(member1Rating, member2Rating, 0.5);
                member2Change = calculateRatingChange(member2Rating, member1Rating, 0.5);
                logText = `${member1} ä¸ ${member2} æˆ˜å¹³`;
            } else if (result === 'forfeit1') { // æˆå‘˜1å¼ƒæƒ
                member1Change = calculateRatingChange(member1Rating, member2Rating, 0);
                member2Change = calculateRatingChange(member2Rating, member1Rating, 1);
                logText = `${member1} å¼ƒæƒï¼Œ${member2} è·èƒœ`;
            } else if (result === 'forfeit2') { // æˆå‘˜2å¼ƒæƒ
                member1Change = calculateRatingChange(member1Rating, member2Rating, 1);
                member2Change = calculateRatingChange(member2Rating, member1Rating, 0);
                logText = `${member2} å¼ƒæƒï¼Œ${member1} è·èƒœ`;
            }

            // æ›´æ–°ç§¯åˆ†
            members[member1] += member1Change;
            members[member2] += member2Change;

            // è®°å½•ç§¯åˆ†å˜åŒ–
            battleRecord.member1_change = member1Change;
            battleRecord.member2_change = member2Change;
            battleRecord.member1_rating_after = members[member1];
            battleRecord.member2_rating_after = members[member2];

            // ä¿å­˜å¯¹æˆ˜è®°å½•
            battleHistory.push(battleRecord);

            // ä¿å­˜æ•°æ®
            saveData();

            // æ›´æ–°æ˜¾ç¤º
            updateMemberLists();
            updateRanking();
            updateMemberScores();

            // è®°å½•å¯¹æˆ˜æ—¥å¿—
            const battleLog = document.getElementById('battleLog');
            logText += ` (${member1}: ${member1Change > 0 ? '+' : ''}${member1Change}, ${member2}: ${member2Change > 0 ? '+' : ''}${member2Change})`;
            battleLog.textContent += `${battleRecord.date} - [${eventName}] ${logText}\n`;
            battleLog.scrollTop = battleLog.scrollHeight;

            alert('å¯¹æˆ˜ç»“æœå·²è®°å½•');
        }

        // å…¨é€‰æˆå‘˜
        function selectAllMembers() {
            const checkboxes = document.querySelectorAll('#memberSelectList input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
        }

        // ç”Ÿæˆå¹³è¡¡çš„æ¯”èµ›æ—¥ç¨‹
        function generateBalancedSchedule(groupMembers) {
            // ç”Ÿæˆæ‰€æœ‰å¯èƒ½çš„æ¯”èµ›ç»„åˆ
            const matches = [];
            for (let i = 0; i < groupMembers.length; i++) {
                for (let j = i + 1; j < groupMembers.length; j++) {
                    matches.push([groupMembers[i], groupMembers[j]]);
                }
            }

            // å¦‚æœæ¯”èµ›åœºæ¬¡å°‘ï¼Œç›´æ¥è¿”å›
            if (matches.length <= 3) {
                return matches;
            }

            // åˆ›å»ºä¸€ä¸ªå­—å…¸æ¥è·Ÿè¸ªæ¯ä¸ªæˆå‘˜çš„æ¯”èµ›é—´éš”
            const playerLastMatch = {};
            groupMembers.forEach(player => {
                playerLastMatch[player] = -1;
            });

            // ç”Ÿæˆå¹³è¡¡çš„æ¯”èµ›æ—¥ç¨‹
            const schedule = [];
            const remainingMatches = [...matches];
            let roundNum = 0;

            while (remainingMatches.length > 0) {
                // æ‰¾å‡ºå¯ä»¥å®‰æ’åœ¨è¿™ä¸€è½®æ¯”èµ›çš„åœºæ¬¡
                let availableMatches = [];
                for (const match of remainingMatches) {
                    const [player1, player2] = match;
                    // æ£€æŸ¥ä¸¤ä¸ªçƒå‘˜æ˜¯å¦éƒ½åœ¨ä¸Šä¸€è½®æ¯”èµ›ä¸­
                    if (playerLastMatch[player1] < roundNum - 1 && playerLastMatch[player2] < roundNum - 1) {
                        availableMatches.push(match);
                    }
                }

                // å¦‚æœæ²¡æœ‰åˆé€‚çš„æ¯”èµ›ï¼Œæ”¾å®½æ¡ä»¶
                if (availableMatches.length === 0) {
                    for (const match of remainingMatches) {
                        const [player1, player2] = match;
                        // è‡³å°‘ç¡®ä¿ä¸€ä¸ªçƒå‘˜æ²¡æœ‰åœ¨ä¸Šä¸€è½®æ¯”èµ›
                        if (playerLastMatch[player1] < roundNum || playerLastMatch[player2] < roundNum) {
                            availableMatches.push(match);
                        }
                    }
                }

                // å¦‚æœä»ç„¶æ²¡æœ‰åˆé€‚çš„æ¯”èµ›ï¼Œé€‰æ‹©ç¬¬ä¸€åœº
                if (availableMatches.length === 0) {
                    availableMatches = [remainingMatches[0]];
                }

                // ä»å¯ç”¨çš„æ¯”èµ›ä¸­éšæœºé€‰æ‹©ä¸€åœº
                const selectedMatch = availableMatches[Math.floor(Math.random() * availableMatches.length)];
                schedule.push(selectedMatch);
                const index = remainingMatches.indexOf(selectedMatch);
                if (index !== -1) {
                    remainingMatches.splice(index, 1);
                }

                // æ›´æ–°çƒå‘˜çš„æœ€åæ¯”èµ›è½®æ¬¡
                const [player1, player2] = selectedMatch;
                playerLastMatch[player1] = roundNum;
                playerLastMatch[player2] = roundNum;

                roundNum++;
            }

            return schedule;
        }

        // åˆ›å»ºæ¯”èµ›
        function createTournament() {
            const tournamentName = document.getElementById('tournamentName').value.trim();
            if (!tournamentName) {
                alert('è¯·è¾“å…¥æ¯”èµ›åç§°');
                return;
            }

            // è·å–é€‰ä¸­çš„æˆå‘˜
            const checkboxes = document.querySelectorAll('#memberSelectList input[type="checkbox"]:checked');
            if (checkboxes.length < 3) {
                alert('è‡³å°‘é€‰æ‹©3åæˆå‘˜');
                return;
            }

            const selectedMembers = Array.from(checkboxes).map(cb => cb.getAttribute('data-name'));

            // è·å–æ¯ç»„äººæ•°å’Œæ™‹çº§äººæ•°
            const groupSize = parseInt(document.getElementById('groupSize').value);
            const advanceCount = parseInt(document.getElementById('advanceCount').value);

            // æ£€æŸ¥æ™‹çº§äººæ•°æ˜¯å¦åˆç†
            if (advanceCount >= groupSize) {
                alert('æ™‹çº§äººæ•°ä¸èƒ½å¤§äºæˆ–ç­‰äºå°ç»„äººæ•°');
                return;
            }

            // éšæœºæ‰“ä¹±æˆå‘˜é¡ºåº
            const shuffledMembers = [...selectedMembers].sort(() => Math.random() - 0.5);

            // åˆ†ç»„
            const groups = [];
            for (let i = 0; i < shuffledMembers.length; i += groupSize) {
                const group = shuffledMembers.slice(i, i + groupSize);
                groups.push(group);
            }

            // å¦‚æœæœ€åä¸€ç»„äººæ•°ä¸è¶³ï¼Œå°†å…¶åˆå¹¶åˆ°å‰ä¸€ç»„
            if (groups.length > 1 && groups[groups.length - 1].length < groupSize - 1) {
                const lastGroup = groups.pop();
                groups[groups.length - 1].push(...lastGroup);
            }

            // ç”Ÿæˆåˆ†ç»„æ˜¾ç¤ºæ–‡æœ¬
            let displayText = `æ¯”èµ›åç§°: ${tournamentName}\n`;
            displayText += `å‚èµ›äººæ•°: ${selectedMembers.length}\n`;
            displayText += `åˆ†ç»„æ•°é‡: ${groups.length}\n`;
            displayText += `æ¯ç»„äººæ•°: ${groupSize}\n`;
            displayText += `æ¯ç»„æ™‹çº§äººæ•°: ${advanceCount}\n\n`;

            groups.forEach((group, i) => {
                displayText += `ç¬¬ ${i + 1} ç»„:\n`;
                group.forEach((member, j) => {
                    displayText += `  ${j + 1}. ${member} (ç§¯åˆ†: ${members[member]})\n`;
                });
                displayText += "\n";
            });

            // ç”Ÿæˆå°ç»„èµ›å¯¹é˜µè¡¨
            displayText += "å°ç»„èµ›å¯¹é˜µå®‰æ’:\n";
            groups.forEach((group, i) => {
                displayText += `\nç¬¬ ${i + 1} ç»„å¯¹é˜µ:\n`;
                // ç”Ÿæˆå¹³è¡¡çš„æ¯”èµ›æ—¥ç¨‹
                const schedule = generateBalancedSchedule(group);
                for (let j = 0; j < schedule.length; j++) {
                    displayText += `  ç¬¬${j + 1}åœº: ${schedule[j][0]} vs ${schedule[j][1]}\n`;
                }
            });

            // æ˜¾ç¤ºåˆ†ç»„æƒ…å†µ
            document.getElementById('groupDisplay').textContent = displayText;

            // ä¿å­˜æ¯”èµ›è®°å½•
            const tournament = {
                name: tournamentName,
                participants: selectedMembers,
                groups: groups,
                group_size: groupSize,
                advance_count: advanceCount,
                timestamp: new Date().toISOString(),
                status: 'created'  // æ¯”èµ›çŠ¶æ€ï¼šcreated, group_stage, knockout_stage, finished
            };
            tournaments.push(tournament);

            // æ›´æ–°æ¯”èµ›åˆ—è¡¨
            updateTournamentLists();

            alert(`æ¯”èµ› '${tournamentName}' å·²åˆ›å»ºï¼Œå…±åˆ†ä¸º ${groups.length} ç»„`);
        }

        // è¿›å…¥æ¯”èµ›
        function enterTournament() {
            const tournamentName = document.getElementById('tournamentSelect').value;
            if (!tournamentName) {
                alert('è¯·é€‰æ‹©æ¯”èµ›');
                return;
            }

            // æŸ¥æ‰¾æ¯”èµ›
            currentTournament = tournaments.find(t => t.name === tournamentName);
            if (!currentTournament) {
                alert('æœªæ‰¾åˆ°é€‰æ‹©çš„æ¯”èµ›');
                return;
            }

            // æ›´æ–°æ¯”èµ›å¯¹æˆ˜é¡µé¢æ˜¾ç¤º
            document.getElementById('currentTournamentName').textContent = `å½“å‰æ¯”èµ›: ${tournamentName}`;
            
            // æ˜¾ç¤ºå† å†›ä¿¡æ¯
            updateChampionDisplay();
            
            // æ˜¾ç¤ºæˆ–éšè—ç”Ÿæˆæ·˜æ±°èµ›æŒ‰é’®
            if (currentTournament.status === 'created' || currentTournament.status === 'group_stage') {
                document.getElementById('generateKnockoutBtn').style.display = 'inline-block';
            } else {
                document.getElementById('generateKnockoutBtn').style.display = 'none';
            }
            
            setupGroupStageDisplay();

            // åˆ‡æ¢åˆ°æ¯”èµ›å¯¹æˆ˜é¡µé¢
            switchTab('tournament-battle');

            alert(`å·²è¿›å…¥æ¯”èµ›: ${tournamentName}`);
        }

        // æ›´æ–°å† å†›æ˜¾ç¤º
        function updateChampionDisplay() {
            const championDisplay = document.getElementById('championDisplay');
            if (currentTournament.champion) {
                championDisplay.style.display = 'block';
                championDisplay.textContent = `ğŸ† å† å†›: ${currentTournament.champion} ğŸ†`;
            } else {
                championDisplay.style.display = 'none';
            }
        }

        // è®¡ç®—å°ç»„èµ›ç»Ÿè®¡æ•°æ® - ä¿®æ”¹ä¸ºæ–°çš„è®¡åˆ†è§„åˆ™
        function calculateGroupStats(groupMembers, tournamentName) {
            const stats = {};

            // åˆå§‹åŒ–ç»Ÿè®¡
            groupMembers.forEach(member => {
                stats[member] = {
                    points: 0,
                    wins: 0,
                    losses: 0,
                    forfeits: 0,
                    games_won: 0,
                    games_lost: 0
                };
            });

            // æŸ¥æ‰¾è¯¥å°ç»„çš„æ‰€æœ‰å¯¹æˆ˜è®°å½•
            battleHistory.forEach(battle => {
                if (battle.event_name === tournamentName &&
                    groupMembers.includes(battle.member1) &&
                    groupMembers.includes(battle.member2)) {

                    if (battle.result === 'member1_win') {
                        // æˆå‘˜1è·èƒœ
                        if (battle.score === '2-0') {
                            stats[battle.member1].points += 3; // 2-0èƒœåˆ©è®¡3åˆ†
                            stats[battle.member2].points += 1; // è¾“æ‰æ¯”èµ›è®¡1åˆ†
                        } else if (battle.score === '2-1') {
                            stats[battle.member1].points += 2; // 2-1èƒœåˆ©è®¡2åˆ†
                            stats[battle.member2].points += 1; // è¾“æ‰æ¯”èµ›è®¡1åˆ†
                        }
                        stats[battle.member1].wins += 1;
                        stats[battle.member2].losses += 1;
                        
                        // è®°å½•å±€æ•°
                        if (battle.score === '2-0') {
                            stats[battle.member1].games_won += 2;
                            stats[battle.member2].games_lost += 2;
                        } else if (battle.score === '2-1') {
                            stats[battle.member1].games_won += 2;
                            stats[battle.member1].games_lost += 1;
                            stats[battle.member2].games_won += 1;
                            stats[battle.member2].games_lost += 2;
                        }
                    } else if (battle.result === 'member2_win') {
                        // æˆå‘˜2è·èƒœ
                        if (battle.score === '2-0') {
                            stats[battle.member2].points += 3; // 2-0èƒœåˆ©è®¡3åˆ†
                            stats[battle.member1].points += 1; // è¾“æ‰æ¯”èµ›è®¡1åˆ†
                        } else if (battle.score === '2-1') {
                            stats[battle.member2].points += 2; // 2-1èƒœåˆ©è®¡2åˆ†
                            stats[battle.member1].points += 1; // è¾“æ‰æ¯”èµ›è®¡1åˆ†
                        }
                        stats[battle.member2].wins += 1;
                        stats[battle.member1].losses += 1;
                        
                        // è®°å½•å±€æ•°
                        if (battle.score === '2-0') {
                            stats[battle.member2].games_won += 2;
                            stats[battle.member1].games_lost += 2;
                        } else if (battle.score === '2-1') {
                            stats[battle.member2].games_won += 2;
                            stats[battle.member2].games_lost += 1;
                            stats[battle.member1].games_won += 1;
                            stats[battle.member1].games_lost += 2;
                        }
                    } else if (battle.result === 'forfeit1') {
                        // æˆå‘˜1å¼ƒæƒ
                        stats[battle.member1].forfeits += 1;
                        stats[battle.member2].points += 3; // å¼ƒæƒèƒœåˆ©è®¡3åˆ†
                        stats[battle.member2].wins += 1;
                        stats[battle.member2].games_won += 2;
                        stats[battle.member1].games_lost += 2;
                    } else if (battle.result === 'forfeit2') {
                        // æˆå‘˜2å¼ƒæƒ
                        stats[battle.member2].forfeits += 1;
                        stats[battle.member1].points += 3; // å¼ƒæƒèƒœåˆ©è®¡3åˆ†
                        stats[battle.member1].wins += 1;
                        stats[battle.member1].games_won += 2;
                        stats[battle.member2].games_lost += 2;
                    }
                    // å¹³å±€ä¸è®¡åˆ†
                }
            });

            return stats;
        }

        // æ£€æŸ¥æ¯”èµ›æ˜¯å¦å·²ç»è¿›è¡Œè¿‡
        function hasMatchBeenPlayed(player1, player2, tournamentName) {
            return battleHistory.some(battle => 
                battle.event_name === tournamentName &&
                ((battle.member1 === player1 && battle.member2 === player2) ||
                 (battle.member1 === player2 && battle.member2 === player1))
            );
        }

        // è·å–æ¯”èµ›ç»“æœ
        function getMatchResult(player1, player2, tournamentName) {
            const battle = battleHistory.find(b => 
                b.event_name === tournamentName &&
                ((b.member1 === player1 && b.member2 === player2) ||
                 (b.member1 === player2 && b.member2 === player1))
            );

            if (!battle) return 'æœªçŸ¥';

            if (battle.result === 'member1_win') {
                if (battle.member1 === player1) return `${player1} èƒœ (${battle.score})`;
                else return `${player2} èƒœ (${battle.score})`;
            } else if (battle.result === 'member2_win') {
                if (battle.member2 === player1) return `${player1} èƒœ (${battle.score})`;
                else return `${player2} èƒœ (${battle.score})`;
            } else if (battle.result === 'draw') {
                return 'å¹³å±€';
            } else if (battle.result === 'forfeit1') {
                if (battle.member1 === player1) return `${player1} å¼ƒæƒ`;
                else return `${player2} å¼ƒæƒ`;
            } else if (battle.result === 'forfeit2') {
                if (battle.member2 === player1) return `${player1} å¼ƒæƒ`;
                else return `${player2} å¼ƒæƒ`;
            }
        }

        // è·å–å¯¹æˆ˜è®°å½•
        function getBattleRecord(player1, player2, tournamentName) {
            return battleHistory.find(b => 
                b.event_name === tournamentName &&
                ((b.member1 === player1 && b.member2 === player2) ||
                 (b.member1 === player2 && b.member2 === player1))
            );
        }

        // è®¾ç½®å°ç»„èµ›æ˜¾ç¤º
        function setupGroupStageDisplay() {
            const groupStageContent = document.getElementById('groupStageContent');
            groupStageContent.innerHTML = '';

            if (!currentTournament) {
                groupStageContent.innerHTML = '<p>è¯·å…ˆé€‰æ‹©å¹¶è¿›å…¥ä¸€ä¸ªæ¯”èµ›</p>';
                return;
            }

            // åˆ›å»ºåˆ†ç»„é€‰é¡¹å¡
            const groupTabs = document.createElement('div');
            groupTabs.className = 'group-tabs';
            groupStageContent.appendChild(groupTabs);

            // åˆ›å»ºåˆ†ç»„å†…å®¹å®¹å™¨
            const groupContents = document.createElement('div');
            groupContents.className = 'group-contents';
            groupStageContent.appendChild(groupContents);

            // ä¸ºæ¯ä¸ªå°ç»„åˆ›å»ºé€‰é¡¹å¡å’Œå†…å®¹
            currentTournament.groups.forEach((group, groupIndex) => {
                // åˆ›å»ºé€‰é¡¹å¡
                const groupTab = document.createElement('button');
                groupTab.className = 'group-tab';
                if (groupIndex === 0) groupTab.classList.add('active');
                groupTab.textContent = `ç¬¬ ${groupIndex + 1} ç»„`;
                groupTab.addEventListener('click', () => {
                    // æ¿€æ´»å½“å‰é€‰é¡¹å¡
                    document.querySelectorAll('.group-tab').forEach(tab => tab.classList.remove('active'));
                    groupTab.classList.add('active');
                    
                    // æ˜¾ç¤ºå½“å‰åˆ†ç»„å†…å®¹
                    document.querySelectorAll('.group-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(`groupContent${groupIndex}`).classList.add('active');
                    
                    currentGroupIndex = groupIndex;
                });
                groupTabs.appendChild(groupTab);

                // åˆ›å»ºåˆ†ç»„å†…å®¹
                const groupContent = document.createElement('div');
                groupContent.className = 'group-content';
                groupContent.id = `groupContent${groupIndex}`;
                if (groupIndex === 0) groupContent.classList.add('active');
                groupContents.appendChild(groupContent);

                // å°ç»„ç§¯åˆ†æ¦œ
                const statsHeader = document.createElement('h4');
                statsHeader.textContent = 'å°ç»„ç§¯åˆ†æ¦œ:';
                groupContent.appendChild(statsHeader);

                const statsTable = document.createElement('table');
                statsTable.innerHTML = `
                    <thead>
                        <tr>
                            <th>æ’å</th>
                            <th>å§“å</th>
                            <th>ç§¯åˆ†</th>
                            <th>èƒœåœº</th>
                            <th>è´Ÿåœº</th>
                            <th>å¼ƒæƒ</th>
                            <th>èƒœå±€</th>
                            <th>è´Ÿå±€</th>
                        </tr>
                    </thead>
                    <tbody id="groupStats${groupIndex}">
                    </tbody>
                `;
                groupContent.appendChild(statsTable);

                // è®¡ç®—å°ç»„ç§¯åˆ†
                const groupStats = calculateGroupStats(group, currentTournament.name);

                // æŒ‰ç§¯åˆ†æ’åº
                const sortedStats = Object.entries(groupStats)
                    .sort((a, b) => {
                        // å…ˆæŒ‰ç§¯åˆ†æ’åº
                        if (b[1].points !== a[1].points) {
                            return b[1].points - a[1].points;
                        }
                        // ç§¯åˆ†ç›¸åŒæŒ‰èƒœå±€æ•°æ’åº
                        if (b[1].games_won !== a[1].games_won) {
                            return b[1].games_won - a[1].games_won;
                        }
                        // èƒœå±€æ•°ç›¸åŒæŒ‰å‡€èƒœå±€æ’åº
                        const netGamesA = a[1].games_won - a[1].games_lost;
                        const netGamesB = b[1].games_won - b[1].games_lost;
                        return netGamesB - netGamesA;
                    });

                // æ·»åŠ æ’åæ•°æ®
                const statsBody = document.getElementById(`groupStats${groupIndex}`);
                sortedStats.forEach(([name, stats], rank) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${rank + 1}</td>
                        <td>${name}</td>
                        <td>${stats.points}</td>
                        <td>${stats.wins}</td>
                        <td>${stats.losses}</td>
                        <td>${stats.forfeits}</td>
                        <td>${stats.games_won}</td>
                        <td>${stats.games_lost}</td>
                    `;
                    statsBody.appendChild(row);
                });

                // å°ç»„å¯¹é˜µ
                const matchesHeader = document.createElement('h4');
                matchesHeader.textContent = 'å°ç»„å¯¹é˜µ:';
                groupContent.appendChild(matchesHeader);

                const matchesDiv = document.createElement('div');
                matchesDiv.className = 'matches-list';
                groupContent.appendChild(matchesDiv);

                // ç”Ÿæˆæ‰€æœ‰å¯èƒ½çš„å¯¹æˆ˜ç»„åˆ
                const matches = [];
                for (let i = 0; i < group.length; i++) {
                    for (let j = i + 1; j < group.length; j++) {
                        matches.push([group[i], group[j]]);
                    }
                }

                // åˆ†ç¦»å·²å®Œæˆå’Œæœªå®Œæˆçš„æ¯”èµ›
                const availableMatches = []; // æœªå®Œæˆçš„æ¯”èµ›
                const completedMatches = []; // å·²å®Œæˆçš„æ¯”èµ›

                matches.forEach(match => {
                    const [player1, player2] = match;
                    if (hasMatchBeenPlayed(player1, player2, currentTournament.name)) {
                        completedMatches.push(match);
                    } else {
                        availableMatches.push(match);
                    }
                });

                // æ˜¾ç¤ºæœªå®Œæˆçš„æ¯”èµ›
                if (availableMatches.length > 0) {
                    const availableHeader = document.createElement('h5');
                    availableHeader.textContent = 'æœªå®Œæˆçš„æ¯”èµ›:';
                    matchesDiv.appendChild(availableHeader);

                    availableMatches.forEach(match => {
                        const [player1, player2] = match;
                        const matchItem = document.createElement('div');
                        matchItem.className = 'match-item';
                        matchItem.innerHTML = `
                            <span>${player1} vs ${player2}</span>
                            <div class="match-actions">
                                <button class="success" data-action="record" data-player1="${player1}" data-player2="${player2}">è®°å½•ç»“æœ</button>
                            </div>
                        `;
                        matchesDiv.appendChild(matchItem);
                    });
                }

                // æ˜¾ç¤ºå·²å®Œæˆçš„æ¯”èµ›
                if (completedMatches.length > 0) {
                    const completedHeader = document.createElement('h5');
                    completedHeader.textContent = 'å·²å®Œæˆçš„æ¯”èµ›:';
                    matchesDiv.appendChild(completedHeader);

                    completedMatches.forEach(match => {
                        const [player1, player2] = match;
                        const result = getMatchResult(player1, player2, currentTournament.name);
                        const matchItem = document.createElement('div');
                        matchItem.className = 'match-item completed';
                        matchItem.innerHTML = `
                            <span>${player1} vs ${player2} (${result})</span>
                            <div class="match-actions">
                                <button class="warning" data-action="modify" data-player1="${player1}" data-player2="${player2}">ä¿®æ”¹ç»“æœ</button>
                                <button class="danger" data-action="delete" data-player1="${player1}" data-player2="${player2}">åˆ é™¤è®°å½•</button>
                            </div>
                        `;
                        matchesDiv.appendChild(matchItem);
                    });
                }
            });

            // ä¸ºæ‰€æœ‰æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            document.querySelectorAll('.match-actions button').forEach(button => {
                button.addEventListener('click', function() {
                    const action = this.getAttribute('data-action');
                    const player1 = this.getAttribute('data-player1');
                    const player2 = this.getAttribute('data-player2');
                    
                    if (action === 'record') {
                        openBattleModal(player1, player2, null, false);
                    } else if (action === 'modify') {
                        openBattleModal(player1, player2, null, true);
                    } else if (action === 'delete') {
                        deleteBattleRecord(player1, player2);
                    }
                });
            });
        }

        // æ‰“å¼€å¯¹æˆ˜è®°å½•æ¨¡æ€æ¡† - å¢åŠ æ¯”åˆ†é€‰æ‹©
        function openBattleModal(player1, player2, group, isModify = false) {
            document.getElementById('battleModalTitle').textContent = isModify ? 'ä¿®æ”¹æ¯”èµ›ç»“æœ' : 'è®°å½•æ¯”èµ›å¯¹æˆ˜ç»“æœ';
            document.getElementById('battlePlayers').textContent = `${player1} vs ${player2}`;
            
            // è®¾ç½®æ¯”åˆ†é€‰é¡¹
            const resultOptions = document.getElementById('battleResultOptions');
            resultOptions.innerHTML = `
                <div class="score-option" data-result="member1_win" data-score="2-0">
                    <input type="radio" name="tournamentBattleResult" value="member1_win" data-score="2-0" style="display: none;">
                    <span>${player1} è·èƒœ (2-0)</span>
                    <span class="score-display">èƒœæ–¹: 3åˆ† | è´Ÿæ–¹: 1åˆ†</span>
                </div>
                <div class="score-option" data-result="member1_win" data-score="2-1">
                    <input type="radio" name="tournamentBattleResult" value="member1_win" data-score="2-1" style="display: none;">
                    <span>${player1} è·èƒœ (2-1)</span>
                    <span class="score-display">èƒœæ–¹: 2åˆ† | è´Ÿæ–¹: 1åˆ†</span>
                </div>
                <div class="score-option" data-result="member2_win" data-score="2-0">
                    <input type="radio" name="tournamentBattleResult" value="member2_win" data-score="2-0" style="display: none;">
                    <span>${player2} è·èƒœ (2-0)</span>
                    <span class="score-display">èƒœæ–¹: 3åˆ† | è´Ÿæ–¹: 1åˆ†</span>
                </div>
                <div class="score-option" data-result="member2_win" data-score="2-1">
                    <input type="radio" name="tournamentBattleResult" value="member2_win" data-score="2-1" style="display: none;">
                    <span>${player2} è·èƒœ (2-1)</span>
                    <span class="score-display">èƒœæ–¹: 2åˆ† | è´Ÿæ–¹: 1åˆ†</span>
                </div>
                <div class="score-option" data-result="forfeit1" data-score="å¼ƒæƒ">
                    <input type="radio" name="tournamentBattleResult" value="forfeit1" data-score="å¼ƒæƒ" style="display: none;">
                    <span>${player1} å¼ƒæƒ</span>
                    <span class="score-display">èƒœæ–¹: 3åˆ† | è´Ÿæ–¹: 0åˆ†</span>
                </div>
                <div class="score-option" data-result="forfeit2" data-score="å¼ƒæƒ">
                    <input type="radio" name="tournamentBattleResult" value="forfeit2" data-score="å¼ƒæƒ" style="display: none;">
                    <span>${player2} å¼ƒæƒ</span>
                    <span class="score-display">èƒœæ–¹: 3åˆ† | è´Ÿæ–¹: 0åˆ†</span>
                </div>
            `;
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.score-option').forEach(option => {
                option.addEventListener('click', function() {
                    // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
                    document.querySelectorAll('.score-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    // æ·»åŠ å½“å‰é€‰ä¸­çŠ¶æ€
                    this.classList.add('selected');
                    // é€‰ä¸­å¯¹åº”çš„å•é€‰æŒ‰é’®
                    const radio = this.querySelector('input[type="radio"]');
                    radio.checked = true;
                });
            });
            
            // å¦‚æœæ˜¯ä¿®æ”¹æ¨¡å¼ï¼Œè®¾ç½®å½“å‰ç»“æœ
            if (isModify) {
                const battleRecord = getBattleRecord(player1, player2, currentTournament.name);
                if (battleRecord) {
                    const result = battleRecord.result;
                    const score = battleRecord.score || '2-0';
                    
                    // æ‰¾åˆ°å¯¹åº”çš„é€‰é¡¹å¹¶é€‰ä¸­
                    const option = document.querySelector(`.score-option[data-result="${result}"][data-score="${score}"]`);
                    if (option) {
                        option.classList.add('selected');
                        const radio = option.querySelector('input[type="radio"]');
                        radio.checked = true;
                    }
                }
                document.getElementById('deleteBattle').style.display = 'inline-block';
            } else {
                document.getElementById('deleteBattle').style.display = 'none';
            }
            
            // å­˜å‚¨å½“å‰å¯¹æˆ˜ä¿¡æ¯
            window.currentBattle = { player1, player2, group, isModify };
            window.currentKnockout = null; // ç¡®ä¿è¿™æ˜¯å°ç»„èµ›
            
            document.getElementById('battleResultModal').style.display = 'flex';
        }

        // ç¡®è®¤å¯¹æˆ˜ç»“æœ
        function confirmBattleResult() {
            const selectedOption = document.querySelector('.score-option.selected');
            if (!selectedOption) {
                alert('è¯·é€‰æ‹©æ¯”èµ›ç»“æœ');
                return;
            }
            
            const result = selectedOption.getAttribute('data-result');
            const score = selectedOption.getAttribute('data-score');
            
            // å¤„ç†å°ç»„èµ›ç»“æœ
            if (window.currentBattle) {
                const { player1, player2, group, isModify } = window.currentBattle;
                const eventName = currentTournament.name;

                // å¦‚æœæ˜¯ä¿®æ”¹æ¨¡å¼ï¼Œå…ˆåˆ é™¤åŸæ¥çš„è®°å½•
                if (isModify) {
                    deleteBattleRecord(player1, player2, false);
                }

                // è·å–å½“å‰ç§¯åˆ†
                const player1Rating = members[player1];
                const player2Rating = members[player2];

                // åˆ›å»ºå¯¹æˆ˜è®°å½•
                const battleRecord = {
                    member1: player1,
                    member2: player2,
                    result: result,
                    score: score,
                    timestamp: new Date().toISOString(),
                    date: new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' }),
                    event_name: eventName,
                    member1_rating_before: player1Rating,
                    member2_rating_before: player2Rating
                };

                // æ ¹æ®ç»“æœè®¡ç®—ç§¯åˆ†å˜åŒ–
                let player1Change, player2Change;

                if (result === 'member1_win') {
                    player1Change = calculateRatingChange(player1Rating, player2Rating, 1);
                    player2Change = calculateRatingChange(player2Rating, player1Rating, 0);
                } else if (result === 'member2_win') {
                    player1Change = calculateRatingChange(player1Rating, player2Rating, 0);
                    player2Change = calculateRatingChange(player2Rating, player1Rating, 1);
                } else if (result === 'forfeit1') {
                    player1Change = calculateRatingChange(player1Rating, player2Rating, 0);
                    player2Change = calculateRatingChange(player2Rating, player1Rating, 1);
                } else if (result === 'forfeit2') {
                    player1Change = calculateRatingChange(player1Rating, player2Rating, 1);
                    player2Change = calculateRatingChange(player2Rating, player1Rating, 0);
                }

                // æ›´æ–°ç§¯åˆ†
                members[player1] += player1Change;
                members[player2] += player2Change;

                // è®°å½•ç§¯åˆ†å˜åŒ–
                battleRecord.member1_change = player1Change;
                battleRecord.member2_change = player2Change;
                battleRecord.member1_rating_after = members[player1];
                battleRecord.member2_rating_after = members[player2];

                // ä¿å­˜å¯¹æˆ˜è®°å½•
                battleHistory.push(battleRecord);

                // æ›´æ–°æ¯”èµ›çŠ¶æ€
                if (currentTournament.status === 'created') {
                    currentTournament.status = 'group_stage';
                }

                // ä¿å­˜æ•°æ®
                saveData();

                // æ›´æ–°æ˜¾ç¤º
                updateMemberLists();
                updateRanking();
                setupGroupStageDisplay();

                document.getElementById('battleResultModal').style.display = 'none';
                alert(isModify ? 'æ¯”èµ›ç»“æœå·²ä¿®æ”¹' : 'æ¯”èµ›å¯¹æˆ˜ç»“æœå·²è®°å½•');
            }
            // å¤„ç†æ·˜æ±°èµ›ç»“æœ
            else if (window.currentKnockout) {
                const { roundName, player1, player2, isModify } = window.currentKnockout;
                const winner = result === 'member1_win' ? player1 : player2;
                const eventName = currentTournament.name + " - " + roundName;

                // å¦‚æœæ˜¯ä¿®æ”¹æ¨¡å¼ï¼Œå…ˆåˆ é™¤åŸæ¥çš„è®°å½•
                if (isModify) {
                    deleteBattleRecord(player1, player2, false);
                }

                // è·å–å½“å‰ç§¯åˆ†
                const player1Rating = members[player1];
                const player2Rating = members[player2];

                // åˆ›å»ºå¯¹æˆ˜è®°å½•
                const battleRecord = {
                    member1: player1,
                    member2: player2,
                    result: result,
                    score: score,
                    timestamp: new Date().toISOString(),
                    date: new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' }),
                    event_name: eventName,
                    member1_rating_before: player1Rating,
                    member2_rating_before: player2Rating
                };

                // æ ¹æ®ç»“æœè®¡ç®—ç§¯åˆ†å˜åŒ–
                let player1Change, player2Change;

                if (result === 'member1_win') {
                    player1Change = calculateRatingChange(player1Rating, player2Rating, 1);
                    player2Change = calculateRatingChange(player2Rating, player1Rating, 0);
                } else {
                    player1Change = calculateRatingChange(player1Rating, player2Rating, 0);
                    player2Change = calculateRatingChange(player2Rating, player1Rating, 1);
                }

                // æ›´æ–°ç§¯åˆ†
                members[player1] += player1Change;
                members[player2] += player2Change;

                // è®°å½•ç§¯åˆ†å˜åŒ–
                battleRecord.member1_change = player1Change;
                battleRecord.member2_change = player2Change;
                battleRecord.member1_rating_after = members[player1];
                battleRecord.member2_rating_after = members[player2];

                // ä¿å­˜å¯¹æˆ˜è®°å½•
                battleHistory.push(battleRecord);

                // æ›´æ–°æ·˜æ±°èµ›å¯¹é˜µ
                const bracket = currentTournament.knockout_bracket;
                for (const match of bracket[roundName]) {
                    if (match.player1 === player1 && match.player2 === player2) {
                        match.completed = true;
                        match.winner = winner;
                        break;
                    }
                }

                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ¯”èµ›éƒ½å·²å®Œæˆ
                const allCompleted = bracket[roundName].every(match => match.completed);

                if (allCompleted) {
                    // ç”Ÿæˆä¸‹ä¸€è½®æ·˜æ±°èµ›
                    const nextRoundWinners = bracket[roundName].map(match => match.winner);

                    if (nextRoundWinners.length > 1) {
                        // ç¡®å®šä¸‹ä¸€è½®åç§°
                        let nextRoundName;
                        if (nextRoundWinners.length === 2) {
                            nextRoundName = "å†³èµ›";
                        } else if (nextRoundWinners.length === 4) {
                            nextRoundName = "åŠå†³èµ›";
                        } else {
                            nextRoundName = `${nextRoundWinners.length}å¼ºèµ›`;
                        }

                        // ç”Ÿæˆä¸‹ä¸€è½®å¯¹é˜µ
                        const nextMatches = [];
                        for (let i = 0; i < nextRoundWinners.length; i += 2) {
                            if (i + 1 < nextRoundWinners.length) {
                                nextMatches.push({
                                    player1: nextRoundWinners[i],
                                    player2: nextRoundWinners[i + 1],
                                    completed: false,
                                    winner: null
                                });
                            }
                        }

                        bracket[nextRoundName] = nextMatches;

                        // å¦‚æœæ˜¯å†³èµ›ä¸”å·²å®Œæˆï¼Œåˆ™æ¯”èµ›ç»“æŸ
                        if (nextRoundName === "å†³èµ›" && nextMatches.length === 1 && nextMatches[0].completed) {
                            currentTournament.status = "finished";
                            currentTournament.champion = nextMatches[0].winner;
                            // è®¾ç½®äºšå†›
                            const finalMatch = nextMatches[0];
                            currentTournament.runnerUp = finalMatch.winner === finalMatch.player1 ? finalMatch.player2 : finalMatch.player1;
                            
                            // ç”Ÿæˆå­£å†›èµ›
                            if (bracket['åŠå†³èµ›'] && bracket['åŠå†³èµ›'].length === 2) {
                                const semiFinalLosers = bracket['åŠå†³èµ›'].map(match => 
                                    match.winner === match.player1 ? match.player2 : match.player1
                                );
                                
                                bracket['å­£å†›èµ›'] = [{
                                    player1: semiFinalLosers[0],
                                    player2: semiFinalLosers[1],
                                    completed: false,
                                    winner: null
                                }];
                            }
                            updateChampionDisplay();
                        }
                    }
                }

                // å¦‚æœæ˜¯å­£å†›èµ›å®Œæˆï¼Œè®°å½•å­£å†›
                if (roundName === 'å­£å†›èµ›' && allCompleted) {
                    currentTournament.thirdPlace = winner;
                }

                // ä¿å­˜æ•°æ®
                saveData();

                // æ›´æ–°æ˜¾ç¤º
                updateMemberLists();
                updateRanking();
                setupKnockoutStageDisplay();

                document.getElementById('battleResultModal').style.display = 'none';
                alert(isModify ? 'æ·˜æ±°èµ›ç»“æœå·²ä¿®æ”¹' : `æ·˜æ±°èµ›ç»“æœå·²è®°å½•ï¼Œ${winner} æ™‹çº§`);
            }
        }

        // åˆ é™¤å¯¹æˆ˜è®°å½•
        function deleteBattleRecord(player1, player2, showAlert = true) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¯¹æˆ˜è®°å½•å—ï¼Ÿ')) {
                return;
            }

            // æŸ¥æ‰¾å¯¹æˆ˜è®°å½•
            const battleIndex = battleHistory.findIndex(battle => 
                battle.event_name === currentTournament.name &&
                ((battle.member1 === player1 && battle.member2 === player2) ||
                 (battle.member1 === player2 && battle.member2 === player1))
            );

            if (battleIndex !== -1) {
                const battle = battleHistory[battleIndex];
                
                // æ’¤é”€ç§¯åˆ†å˜åŒ–
                members[battle.member1] = battle.member1_rating_before;
                members[battle.member2] = battle.member2_rating_before;
                
                // åˆ é™¤å¯¹æˆ˜è®°å½•
                battleHistory.splice(battleIndex, 1);
                
                // æ›´æ–°æ·˜æ±°èµ›çŠ¶æ€ï¼ˆå¦‚æœæ˜¯æ·˜æ±°èµ›ï¼‰
                if (currentTournament.knockout_bracket) {
                    Object.entries(currentTournament.knockout_bracket).forEach(([roundName, matches]) => {
                        matches.forEach(match => {
                            if (match.player1 === player1 && match.player2 === player2) {
                                match.completed = false;
                                match.winner = null;
                            }
                        });
                    });
                    
                    // é‡ç½®å† å†›ã€äºšå†›å’Œå­£å†›
                    currentTournament.champion = null;
                    currentTournament.runnerUp = null;
                    currentTournament.thirdPlace = null;
                    updateChampionDisplay();
                }
                
                // ä¿å­˜æ•°æ®
                saveData();
                
                // æ›´æ–°æ˜¾ç¤º
                updateMemberLists();
                updateRanking();
                setupGroupStageDisplay();
                setupKnockoutStageDisplay();
                
                if (showAlert) {
                    alert('å¯¹æˆ˜è®°å½•å·²åˆ é™¤');
                }
                
                document.getElementById('battleResultModal').style.display = 'none';
            }
        }

        // ç”Ÿæˆæ·˜æ±°èµ›é˜¶æ®µ - ä¿®æ”¹ä¸ºæ ¹æ®æ™‹çº§äººæ•°è‡ªåŠ¨ç”Ÿæˆ
        function generateKnockoutStage() {
            if (!currentTournament) {
                alert('æ²¡æœ‰å½“å‰æ¯”èµ›');
                return;
            }

            // è·å–æ¯ä¸ªå°ç»„çš„æ™‹çº§é€‰æ‰‹
            const advancePlayers = [];
            currentTournament.groups.forEach(group => {
                const groupStats = calculateGroupStats(group, currentTournament.name);
                if (!groupStats) {
                    alert('å°ç»„èµ›æ•°æ®ä¸å®Œæ•´');
                    return;
                }

                // æŒ‰ç§¯åˆ†æ’åº
                const sortedStats = Object.entries(groupStats)
                    .sort((a, b) => {
                        // å…ˆæŒ‰ç§¯åˆ†æ’åº
                        if (b[1].points !== a[1].points) {
                            return b[1].points - a[1].points;
                        }
                        // ç§¯åˆ†ç›¸åŒæŒ‰èƒœå±€æ•°æ’åº
                        if (b[1].games_won !== a[1].games_won) {
                            return b[1].games_won - a[1].games_won;
                        }
                        // èƒœå±€æ•°ç›¸åŒæŒ‰å‡€èƒœå±€æ’åº
                        const netGamesA = a[1].games_won - a[1].games_lost;
                        const netGamesB = b[1].games_won - b[1].games_lost;
                        return netGamesB - netGamesA;
                    });
                
                // å–å‰advance_countå
                for (let i = 0; i < Math.min(currentTournament.advance_count, sortedStats.length); i++) {
                    advancePlayers.push(sortedStats[i][0]);
                }
            });

            // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„æ™‹çº§é€‰æ‰‹
            if (advancePlayers.length < 2) {
                alert('å°ç»„èµ›å°šæœªå®Œæˆæˆ–æ™‹çº§é€‰æ‰‹ä¸è¶³');
                return;
            }

            // éšæœºæ‰“ä¹±æ™‹çº§é€‰æ‰‹é¡ºåº
            const shuffledPlayers = [...advancePlayers].sort(() => Math.random() - 0.5);

            // è®¡ç®—éœ€è¦è½®ç©ºçš„é€‰æ‰‹æ•°é‡
            const totalPlayers = shuffledPlayers.length;
            const nextPowerOfTwo = Math.pow(2, Math.ceil(Math.log2(totalPlayers)));
            const byes = nextPowerOfTwo - totalPlayers;

            // ç”Ÿæˆæ·˜æ±°èµ›å¯¹é˜µ
            const knockoutBracket = {};
            let roundName;

            if (totalPlayers <= 4) {
                roundName = "åŠå†³èµ›";
            } else if (totalPlayers <= 8) {
                roundName = "å…«å¼ºèµ›";
            } else if (totalPlayers <= 16) {
                roundName = "åå…­å¼ºèµ›";
            } else {
                roundName = "ä¸‰åäºŒå¼ºèµ›";
            }

            // åˆ›å»ºç¬¬ä¸€è½®å¯¹é˜µ
            const firstRoundMatches = [];
            let playersLeft = [...shuffledPlayers];
            
            // å¦‚æœæœ‰è½®ç©ºï¼Œéšæœºé€‰æ‹©è½®ç©ºé€‰æ‰‹
            if (byes > 0) {
                const byePlayers = playersLeft.splice(0, byes);
                // è½®ç©ºé€‰æ‰‹ç›´æ¥æ™‹çº§ä¸‹ä¸€è½®
                knockoutBracket["è½®ç©ºæ™‹çº§"] = byePlayers.map(player => ({
                    player: player,
                    type: "bye"
                }));
            }

            // åˆ›å»ºå¯¹é˜µ
            for (let i = 0; i < playersLeft.length; i += 2) {
                if (i + 1 < playersLeft.length) {
                    firstRoundMatches.push({
                        player1: playersLeft[i],
                        player2: playersLeft[i + 1],
                        completed: false,
                        winner: null
                    });
                }
            }

            knockoutBracket[roundName] = firstRoundMatches;

            // æ›´æ–°æ¯”èµ›çŠ¶æ€å’Œæ·˜æ±°èµ›å¯¹é˜µ
            currentTournament.status = 'knockout_stage';
            currentTournament.knockout_bracket = knockoutBracket;

            // ä¿å­˜æ•°æ®
            saveData();

            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('generateKnockoutBtn').style.display = 'none';
            setupKnockoutStageDisplay();

            alert(`æ·˜æ±°èµ›å·²ç”Ÿæˆï¼Œå…±${totalPlayers}åé€‰æ‰‹æ™‹çº§${byes > 0 ? `ï¼Œå…¶ä¸­${byes}åé€‰æ‰‹è½®ç©º` : ''}`);
        }

        // è®¾ç½®æ·˜æ±°èµ›æ˜¾ç¤º
        function setupKnockoutStageDisplay() {
            const knockoutStageContent = document.getElementById('knockoutStageContent');
            knockoutStageContent.innerHTML = '';

            if (!currentTournament || !currentTournament.knockout_bracket) {
                knockoutStageContent.innerHTML = '<p>æ·˜æ±°èµ›å°šæœªç”Ÿæˆ</p>';
                return;
            }

            // åˆ›å»ºæ·˜æ±°èµ›æ ‘å½¢è§†å›¾
            const knockoutTable = document.createElement('table');
            knockoutTable.innerHTML = `
                <thead>
                    <tr>
                        <th>è½®æ¬¡</th>
                        <th>å¯¹é˜µ</th>
                        <th>çŠ¶æ€</th>
                        <th>èƒœè€…</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="knockoutBody">
                </tbody>
            `;
            knockoutStageContent.appendChild(knockoutTable);

            // æ·»åŠ æ·˜æ±°èµ›æ•°æ®
            const knockoutBody = document.getElementById('knockoutBody');
            Object.entries(currentTournament.knockout_bracket).forEach(([roundName, matches]) => {
                // å¤„ç†è½®ç©ºæƒ…å†µ
                if (roundName === "è½®ç©ºæ™‹çº§") {
                    matches.forEach(match => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>è½®ç©º</td>
                            <td>${match.player} (è½®ç©º)</td>
                            <td>å·²æ™‹çº§</td>
                            <td>${match.player}</td>
                            <td class="match-actions">è½®ç©º</td>
                        `;
                        knockoutBody.appendChild(row);
                    });
                } else {
                    matches.forEach(match => {
                        const row = document.createElement('tr');
                        const status = match.completed ? 'å·²å®Œæˆ' : 'æœªå¼€å§‹';
                        const winner = match.completed ? match.winner : 'å¾…å®š';
                        
                        row.innerHTML = `
                            <td>${roundName}</td>
                            <td>${match.player1} vs ${match.player2}</td>
                            <td>${status}</td>
                            <td>${winner}</td>
                            <td class="match-actions">
                                ${match.completed ? 
                                    `<button class="warning" data-action="modify" data-round="${roundName}" data-player1="${match.player1}" data-player2="${match.player2}">ä¿®æ”¹</button>
                                     <button class="danger" data-action="delete" data-player1="${match.player1}" data-player2="${match.player2}">åˆ é™¤</button>` :
                                    `<button class="success" data-action="record" data-round="${roundName}" data-player1="${match.player1}" data-player2="${match.player2}">è®°å½•ç»“æœ</button>`
                                }
                            </td>
                        `;
                        knockoutBody.appendChild(row);
                    });
                }
            });

            // ä¸ºæ‰€æœ‰æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            document.querySelectorAll('#knockoutBody .match-actions button').forEach(button => {
                button.addEventListener('click', function() {
                    const action = this.getAttribute('data-action');
                    const player1 = this.getAttribute('data-player1');
                    const player2 = this.getAttribute('data-player2');
                    const roundName = this.getAttribute('data-round');
                    
                    if (action === 'record') {
                        openKnockoutBattleModal(roundName, player1, player2, false);
                    } else if (action === 'modify') {
                        openKnockoutBattleModal(roundName, player1, player2, true);
                    } else if (action === 'delete') {
                        deleteBattleRecord(player1, player2);
                    }
                });
            });
        }

        // æ‰“å¼€æ·˜æ±°èµ›å¯¹æˆ˜æ¨¡æ€æ¡†
        function openKnockoutBattleModal(roundName, player1, player2, isModify = false) {
            document.getElementById('battleModalTitle').textContent = isModify ? 'ä¿®æ”¹æ·˜æ±°èµ›ç»“æœ' : 'è®°å½•æ·˜æ±°èµ›ç»“æœ';
            document.getElementById('battlePlayers').textContent = `${player1} vs ${player2}`;
            
            // è®¾ç½®å¯¹æˆ˜ç»“æœé€‰é¡¹ - æ·˜æ±°èµ›æ²¡æœ‰å¹³å±€å’Œå¼ƒæƒé€‰é¡¹
            const resultOptions = document.getElementById('battleResultOptions');
            resultOptions.innerHTML = `
                <div class="score-option" data-result="member1_win" data-score="2-0">
                    <input type="radio" name="tournamentBattleResult" value="member1_win" data-score="2-0" style="display: none;">
                    <span>${player1} è·èƒœ (2-0)</span>
                </div>
                <div class="score-option" data-result="member1_win" data-score="2-1">
                    <input type="radio" name="tournamentBattleResult" value="member1_win" data-score="2-1" style="display: none;">
                    <span>${player1} è·èƒœ (2-1)</span>
                </div>
                <div class="score-option" data-result="member2_win" data-score="2-0">
                    <input type="radio" name="tournamentBattleResult" value="member2_win" data-score="2-0" style="display: none;">
                    <span>${player2} è·èƒœ (2-0)</span>
                </div>
                <div class="score-option" data-result="member2_win" data-score="2-1">
                    <input type="radio" name="tournamentBattleResult" value="member2_win" data-score="2-1" style="display: none;">
                    <span>${player2} è·èƒœ (2-1)</span>
                </div>
            `;
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.score-option').forEach(option => {
                option.addEventListener('click', function() {
                    // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
                    document.querySelectorAll('.score-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    // æ·»åŠ å½“å‰é€‰ä¸­çŠ¶æ€
                    this.classList.add('selected');
                    // é€‰ä¸­å¯¹åº”çš„å•é€‰æŒ‰é’®
                    const radio = this.querySelector('input[type="radio"]');
                    radio.checked = true;
                });
            });
            
            // å¦‚æœæ˜¯ä¿®æ”¹æ¨¡å¼ï¼Œè®¾ç½®å½“å‰ç»“æœ
            if (isModify) {
                const battleRecord = getBattleRecord(player1, player2, currentTournament.name + " - " + roundName);
                if (battleRecord) {
                    const result = battleRecord.result;
                    const score = battleRecord.score || '2-0';
                    
                    // æ‰¾åˆ°å¯¹åº”çš„é€‰é¡¹å¹¶é€‰ä¸­
                    const option = document.querySelector(`.score-option[data-result="${result}"][data-score="${score}"]`);
                    if (option) {
                        option.classList.add('selected');
                        const radio = option.querySelector('input[type="radio"]');
                        radio.checked = true;
                    }
                }
                document.getElementById('deleteBattle').style.display = 'inline-block';
            } else {
                document.getElementById('deleteBattle').style.display = 'none';
            }
            
            // å­˜å‚¨å½“å‰æ·˜æ±°èµ›ä¿¡æ¯
            window.currentKnockout = { roundName, player1, player2, isModify };
            window.currentBattle = null; // ç¡®ä¿è¿™æ˜¯æ·˜æ±°èµ›
            
            document.getElementById('battleResultModal').style.display = 'flex';
        }

        // æ‰“å¼€æ·˜æ±°èµ›æ¨¡æ€æ¡†
        function openKnockoutModal() {
            if (!currentTournament || !currentTournament.knockout_bracket) {
                alert('æ·˜æ±°èµ›å°šæœªç”Ÿæˆ');
                return;
            }

            const knockoutMatchSelect = document.getElementById('knockoutMatchSelect');
            knockoutMatchSelect.innerHTML = '<option value="">--è¯·é€‰æ‹©å¯¹é˜µ--</option>';

            // æ·»åŠ æ·˜æ±°èµ›æ•°æ®
            Object.entries(currentTournament.knockout_bracket).forEach(([roundName, matches]) => {
                // è·³è¿‡è½®ç©ºæ™‹çº§
                if (roundName === "è½®ç©ºæ™‹çº§") return;
                
                matches.forEach(match => {
                    if (!match.completed) {
                        const option = document.createElement('option');
                        option.value = `${roundName}|${match.player1}|${match.player2}`;
                        option.textContent = `${roundName}: ${match.player1} vs ${match.player2}`;
                        knockoutMatchSelect.appendChild(option);
                    }
                });
            });

            document.getElementById('knockoutModal').style.display = 'flex';
        }

        // é€‰æ‹©æ·˜æ±°èµ›å¯¹é˜µ
        function selectKnockoutMatch() {
            const selectedValue = document.getElementById('knockoutMatchSelect').value;
            if (!selectedValue) {
                alert('è¯·é€‰æ‹©æ·˜æ±°èµ›å¯¹é˜µ');
                return;
            }

            const [roundName, player1, player2] = selectedValue.split('|');
            
            document.getElementById('knockoutModal').style.display = 'none';
            
            // æ‰“å¼€å¯¹æˆ˜è®°å½•æ¨¡æ€æ¡†
            openKnockoutBattleModal(roundName, player1, player2, false);
        }

        // å¤‡ä»½æ•°æ®
        function backupData() {
            const backupData = {
                members: members,
                battle_history: battleHistory,
                tournaments: tournaments,
                backup_time: new Date().toISOString()
            };

            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pingpong_backup_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('æ•°æ®å¤‡ä»½æˆåŠŸ');
        }

        // æ¢å¤æ•°æ®
        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const backupData = JSON.parse(event.target.result);
                        
                        members = backupData.members || {};
                        battleHistory = backupData.battle_history || [];
                        tournaments = backupData.tournaments || [];
                        currentTournament = null;
                        
                        saveData();
                        updateMemberLists();
                        updateRanking();
                        updateAdminStats();
                        updateTournamentLists();
                        
                        alert('æ•°æ®æ¢å¤æˆåŠŸ');
                    } catch (error) {
                        alert('æ¢å¤å¤±è´¥: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // åˆå§‹åŒ–ç³»ç»Ÿ
        function initializeSystem() {
            if (confirm('ç¡®å®šè¦åˆå§‹åŒ–ç³»ç»Ÿå—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰æ•°æ®ï¼Œæ“ä½œä¸å¯é€†ï¼')) {
                members = {};
                battleHistory = [];
                tournaments = [];
                currentTournament = null;
                
                saveData();
                updateMemberLists();
                updateRanking();
                updateAdminStats();
                updateTournamentLists();
                
                alert('ç³»ç»Ÿå·²åˆå§‹åŒ–ï¼Œæ‰€æœ‰æ•°æ®å·²æ¸…ç©º');
            }
        }
    </script>
</body>
</html>