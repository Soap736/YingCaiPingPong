<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ëã±ÊâçÂÆûÈ™åÂ≠¶Èô¢‰πí‰πìÁêÉ‰ø±‰πêÈÉ®ÁßØÂàÜÁ≥ªÁªü v1.0</title>
    
    <!-- ÂºïÂÖ•Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f5f9ff;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 25px 0;
            text-align: center;
            margin-bottom: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            border: 2px solid #FFD700;
        }
        
        header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background-color: #FFD700;
        }
        
        .logo-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #FFD700 0%, #FFEC8B 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: #1e3c72;
            margin-right: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            border: 2px solid white;
        }
        
        .title-container h1 {
            font-size: 32px;
            margin-bottom: 5px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
        }
        
        .subtitle {
            font-size: 18px;
            margin-bottom: 15px;
            opacity: 0.9;
        }
        
        .version {
            display: inline-block;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 14px;
            margin-left: 10px;
        }
        
        .admin-status {
            display: inline-block;
            background-color: #FFD700;
            color: #1e3c72;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-top: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .tabs {
            display: flex;
            background-color: #1e3c72;
            border-radius: 10px 10px 0 0;
            overflow-x: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .tab {
            padding: 15px 25px;
            color: white;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            transition: all 0.3s;
            white-space: nowrap;
            position: relative;
        }
        
        .tab:hover {
            background-color: #2a5298;
        }
        
        .tab.active {
            background-color: #FFD700;
            color: #1e3c72;
            font-weight: bold;
        }
        
        .tab.active::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background-color: #1e3c72;
        }
        
        .tab-content {
            display: none;
            background-color: white;
            padding: 25px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            min-height: 500px;
            border: 1px solid #eaeaea;
            border-top: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #1e3c72;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #1e3c72;
            outline: none;
            box-shadow: 0 0 0 2px rgba(30, 60, 114, 0.2);
        }
        
        button {
            background-color: #1e3c72;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            margin: 5px;
            font-weight: bold;
        }
        
        button:hover {
            background-color: #2a5298;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        button.danger {
            background-color: #e74c3c;
        }
        
        button.danger:hover {
            background-color: #c0392b;
        }
        
        button.success {
            background-color: #27ae60;
        }
        
        button.success:hover {
            background-color: #219653;
        }
        
        button.warning {
            background-color: #f39c12;
        }
        
        button.warning:hover {
            background-color: #e67e22;
        }
        
        .row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -15px;
        }
        
        .col {
            flex: 1;
            padding: 0 15px;
            min-width: 300px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #eaeaea;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eaeaea;
        }
        
        th {
            background-color: #f0f5ff;
            font-weight: bold;
            color: #1e3c72;
        }
        
        tr:hover {
            background-color: #f8fbff;
        }
        
        .ranking-section {
            margin-bottom: 40px;
        }
        
        .ranking-title {
            color: #1e3c72;
            border-bottom: 2px solid #FFD700;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 22px;
            display: flex;
            align-items: center;
        }
        
        .ranking-title::before {
            content: "üèì";
            margin-right: 10px;
            font-size: 24px;
        }
        
        .stats {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 25px;
        }
        
        .stat-item {
            background: linear-gradient(135deg, #f0f5ff 0%, #e6eeff 100%);
            border-radius: 10px;
            padding: 20px;
            margin: 0 15px 15px 0;
            min-width: 180px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            border-left: 4px solid #1e3c72;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #1e3c72;
        }
        
        .warning {
            color: #e74c3c;
            font-weight: bold;
            margin: 10px 0;
            padding: 10px;
            background-color: #ffeaea;
            border-radius: 6px;
            border-left: 4px solid #e74c3c;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            width: 450px;
            max-width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 2px solid #1e3c72;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #777;
            transition: color 0.3s;
        }
        
        .close-btn:hover {
            color: #1e3c72;
        }
        
        .login-form {
            margin-top: 20px;
        }
        
        .battle-log {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 15px;
            margin-top: 10px;
            background-color: #f9f9f9;
            border-radius: 6px;
        }
        
        .group-display {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 15px;
            margin-top: 10px;
            background-color: #f9f9f9;
            border-radius: 6px;
            white-space: pre-line;
        }
        
        .history-display {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 15px;
            margin-top: 10px;
            background-color: #f9f9f9;
            border-radius: 6px;
            white-space: pre-line;
        }
        
        .member-list {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 15px;
            margin-top: 10px;
            background-color: #f9f9f9;
            border-radius: 6px;
        }
        
        .member-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }
        
        .member-item:hover {
            background-color: #f0f5ff;
        }
        
        .member-item:last-child {
            border-bottom: none;
        }
        
        .admin-only {
            display: none;
        }
        
        .admin-mode .admin-only {
            display: block;
        }
        
        .admin-mode .admin-tab {
            display: inline-block;
        }
        
        .tournament-stage {
            margin: 20px 0;
        }
        
        .stage-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stage-content {
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            background-color: #fcfcff;
        }
        
        .tournament-group {
            margin-bottom: 25px;
        }
        
        .group-header {
            background-color: #f0f5ff;
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-weight: bold;
            color: #1e3c72;
            border-left: 4px solid #FFD700;
        }
        
        .match-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }
        
        .match-item:hover {
            background-color: #f8fbff;
        }
        
        .match-item.completed {
            color: #888;
            background-color: #f9f9f9;
        }
        
        .tournament-info {
            background-color: #f0f5ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #1e3c72;
        }
        
        .group-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .group-tab {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background: none;
            transition: all 0.3s;
        }
        
        .group-tab.active {
            background-color: #f0f5ff;
            border-bottom: 3px solid #1e3c72;
            color: #1e3c72;
            font-weight: bold;
        }
        
        .group-content {
            display: none;
        }
        
        .group-content.active {
            display: block;
        }
        
        .champion-display {
            background-color: #fff9e6;
            border: 1px solid #FFD700;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
            font-size: 20px;
            color: #1e3c72;
        }
        
        .match-actions {
            display: flex;
            gap: 8px;
        }
        
        .medal {
            display: inline-block;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            font-weight: bold;
            margin-right: 8px;
        }
        
        .gold {
            background-color: #FFD700;
            color: #1e3c72;
        }
        
        .silver {
            background-color: #C0C0C0;
            color: #333;
        }
        
        .bronze {
            background-color: #CD7F32;
            color: white;
        }
        
        .academy-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f5ff;
        }
        
        .section-header h2 {
            color: #1e3c72;
            margin-right: 15px;
        }
        
        .section-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        
        .score-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }
        
        .score-option {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .score-option:hover {
            background-color: #f0f5ff;
            border-color: #1e3c72;
        }
        
        .score-option.selected {
            background-color: #e6eeff;
            border-color: #1e3c72;
            box-shadow: 0 0 0 2px rgba(30, 60, 114, 0.2);
        }
        
        .score-display {
            display: inline-block;
            padding: 5px 10px;
            background-color: #f0f5ff;
            border-radius: 4px;
            font-weight: bold;
            color: #1e3c72;
            margin-left: 10px;
        }
        
        .footer {
            margin-top: 40px;
            text-align: center;
            padding: 20px;
            border-top: 1px solid #eaeaea;
            color: #666;
            font-size: 14px;
        }
        
        .copyright {
            margin-bottom: 10px;
        }
        
        .creator {
            font-size: 12px;
            color: #999;
        }
        
        .firebase-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
        }
        
        .firebase-connected {
            background-color: #27ae60;
            color: white;
        }
        
        .firebase-disconnected {
            background-color: #e74c3c;
            color: white;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .sync-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        @media (max-width: 768px) {
            .col {
                flex: 100%;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1;
                min-width: 120px;
                text-align: center;
            }
            
            .stage-buttons {
                flex-direction: column;
            }
            
            .match-actions {
                flex-direction: column;
            }
            
            .stat-item {
                min-width: 100%;
                margin-right: 0;
            }
            
            .logo-container {
                flex-direction: column;
            }
            
            .logo {
                margin-right: 0;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="academy-badge">Ëã±ÊâçÂÆûÈ™åÂ≠¶Èô¢</div>
            <div class="logo-container">
                <div class="logo">Ëã±Êâç</div>
                <div class="title-container">
                    <h1>Ëã±ÊâçÂÆûÈ™åÂ≠¶Èô¢‰πí‰πìÁêÉ‰ø±‰πêÈÉ®<span class="version">v1.0</span></h1>
                    <div class="subtitle">ÁßØÂàÜÊéíÂêç‰∏éËµõ‰∫ãÁÆ°ÁêÜÁ≥ªÁªü</div>
                </div>
            </div>
            <div id="adminStatus" class="admin-status" style="display: none;">ÁÆ°ÁêÜÂëòÊ®°Âºè</div>
            <div style="margin-top: 15px;">
                <button id="adminLoginBtn" class="success">ÁÆ°ÁêÜÂëòÁôªÂΩï</button>
            </div>
        </header>
        
        <div class="tabs">
            <button class="tab active" data-tab="ranking">ÁßØÂàÜÊéíÂêç</button>
            <button class="tab" data-tab="history">ÂéÜÂè≤ÊàòÁª©</button>
            <button class="tab" data-tab="tournament-results">ÊØîËµõÁªìÊûú</button>
            <button class="tab admin-only" data-tab="members">ÊàêÂëòÁÆ°ÁêÜ</button>
            <button class="tab admin-only" data-tab="battle">ÂØπÊàòËÆ∞ÂΩï</button>
            <button class="tab admin-only" data-tab="tournament">ÊØîËµõÁÆ°ÁêÜ</button>
            <button class="tab admin-only" data-tab="tournament-battle">ÊØîËµõÂØπÊàò</button>
            <button class="tab admin-only" data-tab="admin">Á≥ªÁªüÁÆ°ÁêÜ</button>
        </div>
        
        <!-- ÁßØÂàÜÊéíÂêçÈ°µÈù¢ -->
        <div id="ranking" class="tab-content active">
            <div class="section-header">
                <span class="section-icon">üèÜ</span>
                <h2>ÁßØÂàÜÊéíÂêç</h2>
            </div>
            <button id="refreshRanking" class="success">Âà∑Êñ∞ÊéíÂêç</button>
            
            <div class="ranking-section">
                <h3 class="ranking-title">ÁßØÂàÜÊéíÂêç</h3>
                <table id="rankingTable">
                    <thead>
                        <tr>
                            <th>ÊéíÂêç</th>
                            <th>ÂßìÂêç</th>
                            <th>ÁßØÂàÜ</th>
                        </tr>
                    </thead>
                    <tbody id="rankingBody">
                        <!-- ÊéíÂêçÊï∞ÊçÆÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂ°´ÂÖÖ -->
                    </tbody>
                </table>
            </div>
            
            <div class="ranking-section">
                <h3 class="ranking-title">ÂèÇ‰∏éËµõ‰∫ãÊ¨°Êï∞ÊéíÂêç</h3>
                <table id="tournamentParticipationTable">
                    <thead>
                        <tr>
                            <th>ÊéíÂêç</th>
                            <th>ÂßìÂêç</th>
                            <th>ÂèÇ‰∏éËµõ‰∫ãÊ¨°Êï∞</th>
                        </tr>
                    </thead>
                    <tbody id="tournamentParticipationBody">
                        <!-- ÂèÇ‰∏éËµõ‰∫ãÊ¨°Êï∞ÊéíÂêçÊï∞ÊçÆÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂ°´ÂÖÖ -->
                    </tbody>
                </table>
            </div>
            
            <div class="ranking-section">
                <h3 class="ranking-title">ËÉúÂú∫Êï∞ÈáèÊéíÂêç</h3>
                <table id="winsTable">
                    <thead>
                        <tr>
                            <th>ÊéíÂêç</th>
                            <th>ÂßìÂêç</th>
                            <th>ËÉúÂú∫Êï∞Èáè</th>
                        </tr>
                    </thead>
                    <tbody id="winsBody">
                        <!-- ËÉúÂú∫Êï∞ÈáèÊéíÂêçÊï∞ÊçÆÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂ°´ÂÖÖ -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- ÂéÜÂè≤ÊàòÁª©È°µÈù¢ -->
        <div id="history" class="tab-content">
            <div class="section-header">
                <span class="section-icon">üìä</span>
                <h2>ÂéÜÂè≤ÊàòÁª©</h2>
            </div>
            <div class="form-group">
                <label for="historyMember">ÈÄâÊã©ÊàêÂëòÊü•ÁúãÂéÜÂè≤ÊàòÁª©:</label>
                <select id="historyMember">
                    <option value="">--ËØ∑ÈÄâÊã©ÊàêÂëò--</option>
                </select>
                <button id="showHistory" class="success">Êü•ËØ¢ÊàòÁª©</button>
            </div>
            
            <h3>ÊàòÁª©ÁªüËÆ°:</h3>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-label">ËÉúÂú∫</div>
                    <div id="winsCount" class="stat-value">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Ë¥üÂú∫</div>
                    <div id="lossesCount" class="stat-value">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Âπ≥Â±Ä</div>
                    <div id="drawsCount" class="stat-value">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ËÉúÁéá</div>
                    <div id="winRate" class="stat-value">0%</div>
                </div>
            </div>
            
            <h3>ÂéÜÂè≤ÊàòÁª©:</h3>
            <div id="historyDisplay" class="history-display">
                <!-- ÂéÜÂè≤ÊàòÁª©Â∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂ°´ÂÖÖ -->
            </div>
        </div>
        
        <!-- ÊØîËµõÁªìÊûúÈ°µÈù¢ -->
        <div id="tournament-results" class="tab-content">
            <div class="section-header">
                <span class="section-icon">üéØ</span>
                <h2>ÊØîËµõÁªìÊûú</h2>
            </div>
            <div class="form-group">
                <label for="resultsTournament">ÈÄâÊã©ÊØîËµõ:</label>
                <select id="resultsTournament">
                    <option value="">--ËØ∑ÈÄâÊã©ÊØîËµõ--</option>
                </select>
                <button id="showTournamentResults" class="success">Êü•ÁúãÊØîËµõÁªìÊûú</button>
            </div>
            
            <div id="tournamentResultsDisplay" class="history-display">
                <!-- ÊØîËµõÁªìÊûúÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂ°´ÂÖÖ -->
            </div>
        </div>
        
        <!-- ÊàêÂëòÁÆ°ÁêÜÈ°µÈù¢ (‰ªÖÁÆ°ÁêÜÂëòÂèØËßÅ) -->
        <div id="members" class="tab-content admin-only">
            <div class="section-header">
                <span class="section-icon">üë•</span>
                <h2>ÊàêÂëòÁÆ°ÁêÜ</h2>
            </div>
            <div class="row">
                <div class="col">
                    <h3>Ê∑ªÂä†Êñ∞ÊàêÂëò</h3>
                    <div class="form-group">
                        <label for="memberName">ÂßìÂêç:</label>
                        <input type="text" id="memberName" placeholder="ËØ∑ËæìÂÖ•ÂßìÂêç">
                    </div>
                    <div class="form-group">
                        <label for="initialScore">ÂàùÂßãÁßØÂàÜ:</label>
                        <input type="number" id="initialScore" value="1500">
                    </div>
                    <button id="addMember" class="success">Ê∑ªÂä†ÊàêÂëò</button>
                </div>
                
                <div class="col">
                    <h3>ÊâÄÊúâÊàêÂëò</h3>
                    <div id="membersList" class="member-list">
                        <!-- ÊàêÂëòÂàóË°®Â∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂ°´ÂÖÖ -->
                    </div>
                    <button id="deleteMember" class="danger">Âà†Èô§ÈÄâ‰∏≠ÊàêÂëò</button>
                </div>
            </div>
        </div>
        
        <!-- ÂØπÊàòËÆ∞ÂΩïÈ°µÈù¢ (‰ªÖÁÆ°ÁêÜÂëòÂèØËßÅ) -->
        <div id="battle" class="tab-content admin-only">
            <div class="section-header">
                <span class="section-icon">‚öîÔ∏è</span>
                <h2>ÂØπÊàòËÆ∞ÂΩï</h2>
            </div>
            <div class="row">
                <div class="col">
                    <h3>ÈÄâÊã©ÂØπÊàòÊàêÂëò</h3>
                    <div class="form-group">
                        <label for="member1">ÊàêÂëò1:</label>
                        <select id="member1">
                            <option value="">--ËØ∑ÈÄâÊã©ÊàêÂëò--</option>
                        </select>
                        <div id="member1Score">ÂΩìÂâçÁßØÂàÜ: -</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="member2">ÊàêÂëò2:</label>
                        <select id="member2">
                            <option value="">--ËØ∑ÈÄâÊã©ÊàêÂëò--</option>
                        </select>
                        <div id="member2Score">ÂΩìÂâçÁßØÂàÜ: -</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="eventName">Ëµõ‰∫ãÂêçÁß∞:</label>
                        <input type="text" id="eventName" value="Êó•Â∏∏ÂØπÊàò">
                    </div>
                    
                    <div class="form-group">
                        <label>ÂØπÊàòÁªìÊûú:</label>
                        <div>
                            <input type="radio" id="member1Win" name="battleResult" value="member1_win">
                            <label for="member1Win" style="display: inline;">ÊàêÂëò1Ëé∑ËÉú</label>
                        </div>
                        <div>
                            <input type="radio" id="member2Win" name="battleResult" value="member2_win">
                            <label for="member2Win" style="display: inline;">ÊàêÂëò2Ëé∑ËÉú</label>
                        </div>
                        <div>
                            <input type="radio" id="draw" name="battleResult" value="draw">
                            <label for="draw" style="display: inline;">Âπ≥Â±Ä</label>
                        </div>
                        <div>
                            <input type="radio" id="forfeit1" name="battleResult" value="forfeit1">
                            <label for="forfeit1" style="display: inline;">ÊàêÂëò1ÂºÉÊùÉ</label>
                        </div>
                        <div>
                            <input type="radio" id="forfeit2" name="battleResult" value="forfeit2">
                            <label for="forfeit2" style="display: inline;">ÊàêÂëò2ÂºÉÊùÉ</label>
                        </div>
                    </div>
                    
                    <button id="recordBattle" class="success">ËÆ∞ÂΩïÂØπÊàòÁªìÊûú</button>
                </div>
                
                <div class="col">
                    <h3>ÊúÄËøëÂØπÊàòËÆ∞ÂΩï</h3>
                    <div id="battleLog" class="battle-log">
                        <!-- ÂØπÊàòÊó•ÂøóÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂ°´ÂÖÖ -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ÊØîËµõÁÆ°ÁêÜÈ°µÈù¢ (‰ªÖÁÆ°ÁêÜÂëòÂèØËßÅ) -->
        <div id="tournament" class="tab-content admin-only">
            <div class="section-header">
                <span class="section-icon">üèÖ</span>
                <h2>ÊØîËµõÁÆ°ÁêÜ</h2>
            </div>
            <div class="row">
                <div class="col">
                    <h3>ÂàõÂª∫Êñ∞ÊØîËµõ</h3>
                    <div class="form-group">
                        <label for="tournamentName">ÊØîËµõÂêçÁß∞:</label>
                        <input type="text" id="tournamentName" placeholder="ËØ∑ËæìÂÖ•ÊØîËµõÂêçÁß∞">
                    </div>
                    
                    <div class="form-group">
                        <label>ÈÄâÊã©ÂèÇËµõÊàêÂëò:</label>
                        <button id="selectAllMembers">ÂÖ®ÈÄâ</button>
                        <div id="memberSelectList" class="member-list">
                            <!-- ÊàêÂëòÈÄâÊã©ÂàóË°®Â∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂ°´ÂÖÖ -->
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>ÊØîËµõËÆæÁΩÆ:</label>
                        <div class="row">
                            <div class="col">
                                <label for="groupSize">ÊØèÁªÑ‰∫∫Êï∞:</label>
                                <select id="groupSize">
                                    <option value="3">3‰∫∫</option>
                                    <option value="4">4‰∫∫</option>
                                    <option value="5">5‰∫∫</option>
                                    <option value="6">6‰∫∫</option>
                                    <option value="7">7‰∫∫</option>
                                    <option value="8">8‰∫∫</option>
                                    <option value="9">9‰∫∫</option>
                                    <option value="10">10‰∫∫</option>
                                </select>
                            </div>
                            <div class="col">
                                <label for="advanceCount">ÊØèÁªÑÊôãÁ∫ß‰∫∫Êï∞:</label>
                                <select id="advanceCount">
                                    <option value="1">1‰∫∫</option>
                                    <option value="2">2‰∫∫</option>
                                    <option value="3">3‰∫∫</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <button id="createTournament" class="success">ÂàõÂª∫ÊØîËµõÂπ∂ÂàÜÁªÑ</button>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label for="tournamentSelect">ÈÄâÊã©ÊØîËµõ:</label>
                        <select id="tournamentSelect">
                            <option value="">--ËØ∑ÈÄâÊã©ÊØîËµõ--</option>
                        </select>
                        <button id="enterTournament" class="success">ËøõÂÖ•ÊØîËµõ</button>
                    </div>
                </div>
                
                <div class="col">
                    <h3>ÂàÜÁªÑÊÉÖÂÜµ</h3>
                    <div id="groupDisplay" class="group-display">
                        <!-- ÂàÜÁªÑÊÉÖÂÜµÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂ°´ÂÖÖ -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ÊØîËµõÂØπÊàòÈ°µÈù¢ (‰ªÖÁÆ°ÁêÜÂëòÂèØËßÅ) -->
        <div id="tournament-battle" class="tab-content admin-only">
            <div class="section-header">
                <span class="section-icon">üéÆ</span>
                <h2>ÊØîËµõÂØπÊàò</h2>
            </div>
            <div class="tournament-info">
                <h3 id="currentTournamentName">ÂΩìÂâçÊØîËµõ: Êó†</h3>
                <div id="championDisplay" class="champion-display" style="display: none;">
                    <!-- ÂÜ†ÂÜõ‰ø°ÊÅØÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂ°´ÂÖÖ -->
                </div>
            </div>
            
            <div class="tournament-stage">
                <h3>ÊØîËµõÈò∂ÊÆµ:</h3>
                <div class="stage-buttons">
                    <button id="groupStageBtn" class="success">Â∞èÁªÑËµõ</button>
                    <button id="knockoutStageBtn">Ê∑òÊ±∞Ëµõ</button>
                    <button id="generateKnockoutBtn" class="success" style="display: none;">ÁîüÊàêÊ∑òÊ±∞Ëµõ</button>
                </div>
                
                <div id="groupStageContent" class="stage-content">
                    <!-- Â∞èÁªÑËµõÂÜÖÂÆπÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂ°´ÂÖÖ -->
                </div>
                
                <div id="knockoutStageContent" class="stage-content" style="display: none;">
                    <!-- Ê∑òÊ±∞ËµõÂÜÖÂÆπÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂ°´ÂÖÖ -->
                </div>
            </div>
        </div>
        
        <!-- Á≥ªÁªüÁÆ°ÁêÜÈ°µÈù¢ (‰ªÖÁÆ°ÁêÜÂëòÂèØËßÅ) -->
        <div id="admin" class="tab-content admin-only">
            <div class="section-header">
                <span class="section-icon">‚öôÔ∏è</span>
                <h2>Á≥ªÁªüÁÆ°ÁêÜ</h2>
            </div>
            <div class="row">
                <div class="col">
                    <h3>Á≥ªÁªüÁä∂ÊÄÅ</h3>
                    <div class="stat-item">
                        <div class="stat-label">ÊàêÂëòÊï∞Èáè</div>
                        <div id="memberCount" class="stat-value">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">ÂØπÊàòËÆ∞ÂΩïÊï∞Èáè</div>
                        <div id="battleCount" class="stat-value">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">ÊØîËµõÊï∞Èáè</div>
                        <div id="tournamentCount" class="stat-value">0</div>
                    </div>
                    
                    <h3>Êï∞ÊçÆÁÆ°ÁêÜ</h3>
                    <button id="backupData" class="success">Â§á‰ªΩÊï∞ÊçÆ</button>
                    <button id="restoreData" class="success">ÊÅ¢Â§çÊï∞ÊçÆ</button>
                    
                    <div class="sync-section">
                        <h3>Êï∞ÊçÆÂêåÊ≠•</h3>
                        <button id="forceSync" class="success">Âº∫Âà∂ÂêåÊ≠•Êï∞ÊçÆ</button>
                        <button id="checkConnection" class="warning">Ê£ÄÊü•ËøûÊé•Áä∂ÊÄÅ</button>
                        <div id="syncStatus" style="margin-top: 10px;"></div>
                    </div>
                    
                    <h3>Á≥ªÁªüÂàùÂßãÂåñ</h3>
                    <div class="warning">Ë≠¶Âëä: ÂàùÂßãÂåñÂ∞ÜÂà†Èô§ÊâÄÊúâÊï∞ÊçÆÔºåÊ≠§Êìç‰Ωú‰∏çÂèØÈÄÜ!</div>
                    <button id="initializeSystem" class="danger">ÂàùÂßãÂåñÁ≥ªÁªüÊï∞ÊçÆ</button>
                    
                    <h3>ÈÄÄÂá∫ÁÆ°ÁêÜÂëòÊ®°Âºè</h3>
                    <button id="exitAdmin" class="danger">ÈÄÄÂá∫ÁÆ°ÁêÜÂëòÊ®°Âºè</button>
                </div>
            </div>
        </div>
        
        <!-- È°µËÑö -->
        <div class="footer">
            <div class="copyright">ÊúÄÁªàËß£ÈáäÊùÉÂΩíËã±ÊâçÂÆûÈ™åÂ≠¶Èô¢‰πí‰πìÁêÉÁ§æÂõ¢ÊâÄÊúâ</div>
            <div class="creator">Á≥ªÁªüËÆæËÆ°ÔºöÂ¥îÈì≠Ê≠£</div>
        </div>
    </div>
    
    <!-- FirebaseËøûÊé•Áä∂ÊÄÅÊåáÁ§∫Âô® -->
    <div id="firebaseStatus" class="firebase-status firebase-disconnected">Firebase: ËøûÊé•‰∏≠...</div>
    
    <!-- ÁÆ°ÁêÜÂëòÁôªÂΩïÊ®°ÊÄÅÊ°Ü -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ÁÆ°ÁêÜÂëòÁôªÂΩï</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="login-form">
                <div class="form-group">
                    <label for="password">ËØ∑ËæìÂÖ•ÁÆ°ÁêÜÂëòÂØÜÁ†Å:</label>
                    <input type="password" id="password" placeholder="ÂØÜÁ†Å">
                </div>
                <button id="loginBtn" class="success">ÁôªÂΩï</button>
            </div>
        </div>
    </div>

    <!-- ÊØîËµõÂØπÊàòÁªìÊûúËÆ∞ÂΩïÊ®°ÊÄÅÊ°Ü -->
    <div id="battleResultModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="battleModalTitle">ËÆ∞ÂΩïÊØîËµõÂØπÊàòÁªìÊûú</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="battle-form">
                <div class="form-group">
                    <h4 id="battlePlayers"></h4>
                </div>
                <div class="form-group">
                    <label>ÈÄâÊã©ÊØîÂàÜ:</label>
                    <div id="battleResultOptions" class="score-options">
                        <!-- ÊØîÂàÜÈÄâÈ°πÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂ°´ÂÖÖ -->
                    </div>
                </div>
                <button id="confirmBattle" class="success">Á°ÆËÆ§ËÆ∞ÂΩï</button>
                <button id="deleteBattle" class="danger" style="display: none;">Âà†Èô§ËÆ∞ÂΩï</button>
            </div>
        </div>
    </div>

    <script>
        // FirebaseÈÖçÁΩÆ
        const firebaseConfig = {
            apiKey: "AIzaSyDYbBOm1TxDMAu94VuVzH4xyEih9zLxb2E",
            authDomain: "pingpong-1c0ae.firebaseapp.com",
            projectId: "pingpong-1c0ae",
            storageBucket: "pingpong-1c0ae.firebasestorage.app",
            messagingSenderId: "408777067855",
            appId: "1:408777067855:web:27dfbdaba767bc7708493a"
        };

        // ÂàùÂßãÂåñFirebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Êï∞ÊçÆÂ≠òÂÇ®
        let members = {};
        let battleHistory = [];
        let tournaments = {};
        let currentTournament = null;
        let adminMode = false;
        let currentGroupIndex = 0;

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            initFirebase();
            setupEventListeners();
        });

        // ÂàùÂßãÂåñFirebase
        async function initFirebase() {
            try {
                updateFirebaseStatus('ËøûÊé•‰∏≠...', 'disconnected');
                
                // ËÆæÁΩÆËøûÊé•Áä∂ÊÄÅÁõëÂê¨
                firebase.firestore().enableNetwork()
                    .then(() => {
                        updateFirebaseStatus('Â∑≤ËøûÊé•', 'connected');
                        console.log('FirebaseËøûÊé•ÊàêÂäü');
                    })
                    .catch((error) => {
                        console.error('FirebaseÁΩëÁªúËøûÊé•Â§±Ë¥•:', error);
                        updateFirebaseStatus('ËøûÊé•Â§±Ë¥•', 'error');
                        // ÈáçËØïËøûÊé•
                        setTimeout(initFirebase, 5000);
                    });

                // Âä†ËΩΩÊï∞ÊçÆ
                await loadData();
                
                // ËÆæÁΩÆÂÆûÊó∂ÁõëÂê¨
                setupRealtimeListener();
                
                // ÂàùÂßãÂåñUI
                updateRanking();
                updateMemberLists();
                updateAdminStats();
                updateTournamentLists();
                
            } catch (error) {
                console.error('ÂàùÂßãÂåñÂ§±Ë¥•:', error);
                updateFirebaseStatus('ÂàùÂßãÂåñÂ§±Ë¥•', 'error');
                // ÈáçËØïÂàùÂßãÂåñ
                setTimeout(initFirebase, 5000);
            }
        }

        // Êõ¥Êñ∞FirebaseËøûÊé•Áä∂ÊÄÅÊòæÁ§∫
        function updateFirebaseStatus(message, status) {
            const statusElement = document.getElementById('firebaseStatus');
            statusElement.textContent = `Firebase: ${message}`;
            
            statusElement.className = 'firebase-status ';
            if (status === 'connected') {
                statusElement.classList.add('firebase-connected');
            } else if (status === 'error') {
                statusElement.classList.add('firebase-disconnected');
            } else {
                statusElement.style.backgroundColor = '#f39c12';
            }
        }

        // ËÆæÁΩÆÂÆûÊó∂Êï∞ÊçÆÁõëÂê¨
        function setupRealtimeListener() {
            db.collection('pingpong').doc('data')
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        console.log('Êî∂Âà∞ÂÆûÊó∂Êï∞ÊçÆÊõ¥Êñ∞', data);
                        
                        // Êõ¥Êñ∞Êú¨Âú∞Êï∞ÊçÆ
                        members = data.members || {};
                        battleHistory = data.battleHistory || [];
                        tournaments = data.tournaments || {};
                        
                        // Êõ¥Êñ∞UI
                        updateRanking();
                        updateMemberLists();
                        updateAdminStats();
                        updateTournamentLists();
                        
                        // Â¶ÇÊûúÂΩìÂâçÊúâÊ≠£Âú®Êü•ÁúãÁöÑÊØîËµõÔºåÊõ¥Êñ∞ÊØîËµõÊòæÁ§∫
                        if (currentTournament && currentTournament.name) {
                            const updatedTournament = tournaments[currentTournament.name];
                            if (updatedTournament) {
                                currentTournament = updatedTournament;
                                setupGroupStageDisplay();
                                setupKnockoutStageDisplay();
                            }
                        }
                        
                        updateFirebaseStatus('Â∑≤ËøûÊé•(ÂÆûÊó∂)', 'connected');
                        
                        // ÈöêËóèÁ¶ªÁ∫øË≠¶Âëä
                        const offlineWarning = document.getElementById('offlineWarning');
                        if (offlineWarning) {
                            offlineWarning.textContent = 'Â∑≤ÈáçÊñ∞ËøûÊé•Âà∞ÊúçÂä°Âô®';
                            setTimeout(() => {
                                if (document.getElementById('offlineWarning')) {
                                    document.body.removeChild(offlineWarning);
                                }
                            }, 3000);
                        }
                    }
                }, (error) => {
                    console.error('ÁõëÂê¨Êï∞ÊçÆÂèòÂåñÂ§±Ë¥•:', error);
                    updateFirebaseStatus('ËøûÊé•‰∏≠Êñ≠', 'error');
                    
                    // ÊòæÁ§∫ËøûÊé•ÈîôËØØÊèêÁ§∫
                    if (!document.getElementById('connectionError')) {
                        const errorDiv = document.createElement('div');
                        errorDiv.id = 'connectionError';
                        errorDiv.className = 'warning';
                        errorDiv.style.position = 'fixed';
                        errorDiv.style.top = '60px';
                        errorDiv.style.left = '50%';
                        errorDiv.style.transform = 'translateX(-50%)';
                        errorDiv.style.zIndex = '10000';
                        errorDiv.textContent = 'ÊúçÂä°Âô®ËøûÊé•‰∏≠Êñ≠ÔºåÊ≠£Âú®Â∞ùËØïÈáçÊñ∞ËøûÊé•...';
                        document.body.appendChild(errorDiv);
                    }
                });
        }

        // ‰ªéFirebaseÂä†ËΩΩÊï∞ÊçÆ
        async function loadData() {
            try {
                const doc = await db.collection('pingpong').doc('data').get();
                if (doc.exists) {
                    const data = doc.data();
                    members = data.members || {};
                    battleHistory = data.battleHistory || [];
                    tournaments = data.tournaments || {};
                    console.log('Êï∞ÊçÆÂä†ËΩΩÊàêÂäü');
                    updateFirebaseStatus('Â∑≤ËøûÊé•', 'connected');
                } else {
                    // Â¶ÇÊûúÊñáÊ°£‰∏çÂ≠òÂú®ÔºåÂàõÂª∫ÂàùÂßãÊï∞ÊçÆ
                    await saveDataToFirebase();
                    console.log('ÂàõÂª∫ÂàùÂßãÊï∞ÊçÆ');
                }
            } catch (error) {
                console.error('‰ªéFirebaseÂä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•:', error);
                // ‰ΩøÁî®Êú¨Âú∞Â≠òÂÇ®‰Ωú‰∏∫Â§áÁî®
                const savedMembers = localStorage.getItem('pingpong_members');
                const savedHistory = localStorage.getItem('pingpong_history');
                const savedTournaments = localStorage.getItem('pingpong_tournaments');

                if (savedMembers) members = JSON.parse(savedMembers);
                if (savedHistory) battleHistory = JSON.parse(savedHistory);
                if (savedTournaments) tournaments = JSON.parse(savedTournaments);
                
                updateFirebaseStatus('Á¶ªÁ∫øÊ®°Âºè', 'error');
            }
        }

        // ‰øùÂ≠òÊï∞ÊçÆÂà∞Firebase
        async function saveDataToFirebase() {
            const data = {
                members,
                battleHistory,
                tournaments,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                await db.collection('pingpong').doc('data').set(data);
                console.log('Êï∞ÊçÆ‰øùÂ≠òÂà∞FirebaseÊàêÂäü');
                updateFirebaseStatus('Â∑≤‰øùÂ≠ò', 'connected');
                
                // ÂêåÊó∂‰øùÂ≠òÂà∞Êú¨Âú∞‰Ωú‰∏∫Â§á‰ªΩ
                localStorage.setItem('pingpong_members', JSON.stringify(members));
                localStorage.setItem('pingpong_history', JSON.stringify(battleHistory));
                localStorage.setItem('pingpong_tournaments', JSON.stringify(tournaments));
                
                return true;
            } catch (error) {
                console.error('‰øùÂ≠òÊï∞ÊçÆÂà∞FirebaseÂ§±Ë¥•:', error);
                
                // Â¶ÇÊûúFirebase‰∏çÂèØÁî®Ôºå‰øùÂ≠òÂà∞Êú¨Âú∞Âπ∂ÊèêÁ§∫Áî®Êà∑
                localStorage.setItem('pingpong_members', JSON.stringify(members));
                localStorage.setItem('pingpong_history', JSON.stringify(battleHistory));
                localStorage.setItem('pingpong_tournaments', JSON.stringify(tournaments));
                
                updateFirebaseStatus('‰øùÂ≠òÂ§±Ë¥•(Á¶ªÁ∫øÊ®°Âºè)', 'error');
                
                // ÊòæÁ§∫Á¶ªÁ∫øÊ®°ÂºèÊèêÁ§∫
                if (!document.getElementById('offlineWarning')) {
                    const warning = document.createElement('div');
                    warning.id = 'offlineWarning';
                    warning.className = 'warning';
                    warning.style.position = 'fixed';
                    warning.style.top = '10px';
                    warning.style.left = '50%';
                    warning.style.transform = 'translateX(-50%)';
                    warning.style.zIndex = '10000';
                    warning.textContent = 'ÂΩìÂâçÂ§Ñ‰∫éÁ¶ªÁ∫øÊ®°ÂºèÔºåÊï∞ÊçÆÂ∞Ü‰øùÂ≠òÂú®Êú¨Âú∞';
                    document.body.appendChild(warning);
                    
                    setTimeout(() => {
                        if (document.getElementById('offlineWarning')) {
                            document.body.removeChild(warning);
                        }
                    }, 5000);
                }
                
                return false;
            }
        }

        // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
        function setupEventListeners() {
            // ÈÄâÈ°πÂç°ÂàáÊç¢
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });

            // ÁÆ°ÁêÜÂëòÁôªÂΩï
            document.getElementById('adminLoginBtn').addEventListener('click', () => {
                document.getElementById('loginModal').style.display = 'flex';
            });
            document.getElementById('loginBtn').addEventListener('click', adminLogin);
            document.querySelector('.close-btn').addEventListener('click', () => {
                document.getElementById('loginModal').style.display = 'none';
            });

            // ÁßØÂàÜÊéíÂêç
            document.getElementById('refreshRanking').addEventListener('click', updateRanking);

            // ÂéÜÂè≤ÊàòÁª©
            document.getElementById('showHistory').addEventListener('click', showMemberHistory);

            // ÊØîËµõÁªìÊûú
            document.getElementById('showTournamentResults').addEventListener('click', showTournamentResults);

            // ÊàêÂëòÁÆ°ÁêÜ
            document.getElementById('addMember').addEventListener('click', addMember);
            document.getElementById('deleteMember').addEventListener('click', deleteMember);

            // ÂØπÊàòËÆ∞ÂΩï
            document.getElementById('member1').addEventListener('change', updateMemberScores);
            document.getElementById('member2').addEventListener('change', updateMemberScores);
            document.getElementById('recordBattle').addEventListener('click', recordBattle);

            // ÊØîËµõÁÆ°ÁêÜ
            document.getElementById('selectAllMembers').addEventListener('click', selectAllMembers);
            document.getElementById('createTournament').addEventListener('click', createTournament);
            document.getElementById('enterTournament').addEventListener('click', enterTournament);

            // ÊØîËµõÂØπÊàò
            document.getElementById('groupStageBtn').addEventListener('click', () => {
                document.getElementById('groupStageContent').style.display = 'block';
                document.getElementById('knockoutStageContent').style.display = 'none';
                document.getElementById('groupStageBtn').classList.add('success');
                document.getElementById('knockoutStageBtn').classList.remove('success');
                setupGroupStageDisplay();
            });
            
            document.getElementById('knockoutStageBtn').addEventListener('click', () => {
                document.getElementById('groupStageContent').style.display = 'none';
                document.getElementById('knockoutStageContent').style.display = 'block';
                document.getElementById('knockoutStageBtn').classList.add('success');
                document.getElementById('groupStageBtn').classList.remove('success');
                setupKnockoutStageDisplay();
            });

            document.getElementById('generateKnockoutBtn').addEventListener('click', generateKnockoutStage);

            // Á≥ªÁªüÁÆ°ÁêÜ
            document.getElementById('backupData').addEventListener('click', backupData);
            document.getElementById('restoreData').addEventListener('click', restoreData);
            document.getElementById('initializeSystem').addEventListener('click', initializeSystem);
            document.getElementById('exitAdmin').addEventListener('click', exitAdminMode);

            // ÂêåÊ≠•ÂäüËÉΩ
            document.getElementById('forceSync').addEventListener('click', forceSync);
            document.getElementById('checkConnection').addEventListener('click', checkConnection);

            // ÂØπÊàòÁªìÊûúÊ®°ÊÄÅÊ°Ü
            document.getElementById('confirmBattle').addEventListener('click', confirmBattleResult);
            document.getElementById('deleteBattle').addEventListener('click', deleteBattleRecord);
            document.querySelectorAll('#battleResultModal .close-btn')[0].addEventListener('click', () => {
                document.getElementById('battleResultModal').style.display = 'none';
            });
        }

        // Âº∫Âà∂ÂêåÊ≠•ÂáΩÊï∞
        async function forceSync() {
            const syncStatus = document.getElementById('syncStatus');
            syncStatus.textContent = 'Ê≠£Âú®ÂêåÊ≠•Êï∞ÊçÆ...';
            syncStatus.className = '';
            
            try {
                await saveDataToFirebase();
                await loadData();
                
                syncStatus.textContent = 'Êï∞ÊçÆÂêåÊ≠•ÊàêÂäüÔºÅ';
                syncStatus.style.color = 'green';
                
                // Êõ¥Êñ∞ÊâÄÊúâUI
                updateRanking();
                updateMemberLists();
                updateAdminStats();
                updateTournamentLists();
                
            } catch (error) {
                syncStatus.textContent = 'Êï∞ÊçÆÂêåÊ≠•Â§±Ë¥•: ' + error.message;
                syncStatus.style.color = 'red';
            }
        }

        // Ê£ÄÊü•ËøûÊé•Áä∂ÊÄÅ
        function checkConnection() {
            const syncStatus = document.getElementById('syncStatus');
            
            db.collection('pingpong').doc('data').get()
                .then((doc) => {
                    if (doc.exists) {
                        syncStatus.textContent = 'ËøûÊé•Ê≠£Â∏∏ÔºåÂèØ‰ª•ËØªÂÜôÊï∞ÊçÆ';
                        syncStatus.style.color = 'green';
                    } else {
                        syncStatus.textContent = 'ËøûÊé•Ê≠£Â∏∏Ôºå‰ΩÜÊñáÊ°£‰∏çÂ≠òÂú®';
                        syncStatus.style.color = 'orange';
                    }
                })
                .catch((error) => {
                    syncStatus.textContent = 'ËøûÊé•Â§±Ë¥•: ' + error.message;
                    syncStatus.style.color = 'red';
                });
        }

        // ÂàáÊç¢ÈÄâÈ°πÂç°
        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                }
            });

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                if (content.id === tabId) {
                    content.classList.add('active');
                }
            });
        }

        // ÁÆ°ÁêÜÂëòÁôªÂΩï
        function adminLogin() {
            const password = document.getElementById('password').value;
            if (password === '1092973377') {
                adminMode = true;
                document.getElementById('loginModal').style.display = 'none';
                document.body.classList.add('admin-mode');
                document.getElementById('adminStatus').style.display = 'inline-block';
                document.getElementById('adminLoginBtn').textContent = 'ÁÆ°ÁêÜÂëòÈÄÄÂá∫';
                document.getElementById('adminLoginBtn').classList.remove('success');
                document.getElementById('adminLoginBtn').classList.add('danger');
                document.getElementById('adminLoginBtn').removeEventListener('click', adminLogin);
                document.getElementById('adminLoginBtn').addEventListener('click', exitAdminMode);
                alert('ÁÆ°ÁêÜÂëòÊ®°ÂºèÂ∑≤ÂêØÁî®');
            } else if (password) {
                alert('ÂØÜÁ†ÅÈîôËØØ');
            }
        }

        // ÈÄÄÂá∫ÁÆ°ÁêÜÂëòÊ®°Âºè
        function exitAdminMode() {
            if (confirm('Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÁÆ°ÁêÜÂëòÊ®°ÂºèÂêóÔºü')) {
                adminMode = false;
                document.body.classList.remove('admin-mode');
                document.getElementById('adminStatus').style.display = 'none';
                document.getElementById('adminLoginBtn').textContent = 'ÁÆ°ÁêÜÂëòÁôªÂΩï';
                document.getElementById('adminLoginBtn').classList.remove('danger');
                document.getElementById('adminLoginBtn').classList.add('success');
                document.getElementById('adminLoginBtn').removeEventListener('click', exitAdminMode);
                document.getElementById('adminLoginBtn').addEventListener('click', () => {
                    document.getElementById('loginModal').style.display = 'flex';
                });
                alert('Â∑≤ÈÄÄÂá∫ÁÆ°ÁêÜÂëòÊ®°Âºè');
            }
        }

        // Êõ¥Êñ∞ÁßØÂàÜÊéíÂêç
        function updateRanking() {
            // Êõ¥Êñ∞ÁßØÂàÜÊéíÂêç
            const rankingBody = document.getElementById('rankingBody');
            rankingBody.innerHTML = '';

            // ÊåâÁßØÂàÜÊéíÂ∫è
            const sortedMembers = Object.entries(members)
                .sort((a, b) => b[1] - a[1])
                .map(([name, score], index) => ({ rank: index + 1, name, score }));

            sortedMembers.forEach(member => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${member.rank}</td>
                    <td>${member.name}</td>
                    <td>${member.score}</td>
                `;
                rankingBody.appendChild(row);
            });
            
            // Êõ¥Êñ∞ÂèÇ‰∏éËµõ‰∫ãÊ¨°Êï∞ÊéíÂêç
            const tournamentParticipationBody = document.getElementById('tournamentParticipationBody');
            tournamentParticipationBody.innerHTML = '';
            
            const tournamentParticipationRanking = calculateTournamentParticipationRanking();
            tournamentParticipationRanking.forEach(([name, count], index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${name}</td>
                    <td>${count}</td>
                `;
                tournamentParticipationBody.appendChild(row);
            });
            
            // Êõ¥Êñ∞ËÉúÂú∫Êï∞ÈáèÊéíÂêç
            const winsBody = document.getElementById('winsBody');
            winsBody.innerHTML = '';
            
            const winsRanking = calculateWinsRanking();
            winsRanking.forEach(([name, wins], index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${name}</td>
                    <td>${wins}</td>
                `;
                winsBody.appendChild(row);
            });
        }

        // ËÆ°ÁÆóÂèÇ‰∏éËµõ‰∫ãÊ¨°Êï∞ÊéíÂêç
        function calculateTournamentParticipationRanking() {
            const participationStats = {};
            
            // ÂàùÂßãÂåñÊØè‰∏™ÊàêÂëòÁöÑÁªüËÆ°Êï∞ÊçÆ
            Object.keys(members).forEach(name => {
                participationStats[name] = 0;
            });
            
            // ÈÅçÂéÜÊâÄÊúâÊØîËµõÔºåÁªüËÆ°ÊØè‰∏™ÊàêÂëòÁöÑÂèÇ‰∏éÊ¨°Êï∞
            Object.values(tournaments).forEach(tournament => {
                if (tournament.participants) {
                    tournament.participants.forEach(participant => {
                        if (participationStats[participant] !== undefined) {
                            participationStats[participant]++;
                        }
                    });
                }
            });
            
            // ËΩ¨Êç¢‰∏∫Êï∞ÁªÑÂπ∂ÊåâÂèÇ‰∏éÊ¨°Êï∞ÊéíÂ∫è
            const sortedStats = Object.entries(participationStats)
                .sort((a, b) => b[1] - a[1]);
            
            return sortedStats;
        }

        // ËÆ°ÁÆóËÉúÂú∫Êï∞ÈáèÊéíÂêç
        function calculateWinsRanking() {
            const winsStats = {};
            
            // ÂàùÂßãÂåñÊØè‰∏™ÊàêÂëòÁöÑÁªüËÆ°Êï∞ÊçÆ
            Object.keys(members).forEach(name => {
                winsStats[name] = 0;
            });
            
            // ÈÅçÂéÜÊâÄÊúâÂØπÊàòËÆ∞ÂΩïÔºåÁªüËÆ°ÊØè‰∏™ÊàêÂëòÁöÑËÉúÂú∫Êï∞
            battleHistory.forEach(battle => {
                if (battle.result === 'member1_win') {
                    winsStats[battle.member1]++;
                } else if (battle.result === 'member2_win') {
                    winsStats[battle.member2]++;
                }
                // Ê≥®ÊÑèÔºöÂºÉÊùÉ‰∏çÁÆóËÉúÂú∫
            });
            
            // ËΩ¨Êç¢‰∏∫Êï∞ÁªÑÂπ∂ÊåâËÉúÂú∫Êï∞ÊéíÂ∫è
            const sortedStats = Object.entries(winsStats)
                .sort((a, b) => b[1] - a[1]);
            
            return sortedStats;
        }

        // Êõ¥Êñ∞ÊàêÂëòÂàóË°®
        function updateMemberLists() {
            // Êõ¥Êñ∞ÂéÜÂè≤ÊàòÁª©ÊàêÂëò‰∏ãÊãâÊ°Ü
            const historyMember = document.getElementById('historyMember');
            historyMember.innerHTML = '<option value="">--ËØ∑ÈÄâÊã©ÊàêÂëò--</option>';
            
            Object.keys(members).forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                historyMember.appendChild(option);
            });

            // Êõ¥Êñ∞ÂØπÊàòËÆ∞ÂΩïÊàêÂëò‰∏ãÊãâÊ°Ü
            const member1 = document.getElementById('member1');
            const member2 = document.getElementById('member2');
            member1.innerHTML = member2.innerHTML = '<option value="">--ËØ∑ÈÄâÊã©ÊàêÂëò--</option>';
            
            Object.keys(members).forEach(name => {
                const option1 = document.createElement('option');
                option1.value = name;
                option1.textContent = name;
                member1.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = name;
                option2.textContent = name;
                member2.appendChild(option2);
            });

            // Êõ¥Êñ∞ÊàêÂëòÁÆ°ÁêÜÂàóË°®
            const membersList = document.getElementById('membersList');
            membersList.innerHTML = '';
            
            Object.entries(members).forEach(([name, score]) => {
                const memberItem = document.createElement('div');
                memberItem.className = 'member-item';
                memberItem.innerHTML = `
                    <span>${name}: ${score}ÂàÜ</span>
                    <input type="checkbox" data-name="${name}">
                `;
                membersList.appendChild(memberItem);
            });

            // Êõ¥Êñ∞ÊØîËµõÁÆ°ÁêÜÊàêÂëòÈÄâÊã©ÂàóË°®
            const memberSelectList = document.getElementById('memberSelectList');
            memberSelectList.innerHTML = '';
            
            Object.keys(members).forEach(name => {
                const memberItem = document.createElement('div');
                memberItem.className = 'member-item';
                memberItem.innerHTML = `
                    <span>${name}</span>
                    <input type="checkbox" data-name="${name}">
                `;
                memberSelectList.appendChild(memberItem);
            });
        }

        // Êõ¥Êñ∞ÊØîËµõÂàóË°®
        function updateTournamentLists() {
            // Êõ¥Êñ∞ÊØîËµõÁÆ°ÁêÜ‰∏ãÊãâÊ°Ü
            const tournamentSelect = document.getElementById('tournamentSelect');
            tournamentSelect.innerHTML = '<option value="">--ËØ∑ÈÄâÊã©ÊØîËµõ--</option>';
            
            Object.values(tournaments).forEach(tournament => {
                const option = document.createElement('option');
                option.value = tournament.name;
                option.textContent = tournament.name;
                tournamentSelect.appendChild(option);
            });

            // Êõ¥Êñ∞ÊØîËµõÁªìÊûú‰∏ãÊãâÊ°Ü
            const resultsTournament = document.getElementById('resultsTournament');
            resultsTournament.innerHTML = '<option value="">--ËØ∑ÈÄâÊã©ÊØîËµõ--</option>';
            
            Object.values(tournaments).forEach(tournament => {
                const option = document.createElement('option');
                option.value = tournament.name;
                option.textContent = tournament.name;
                resultsTournament.appendChild(option);
            });
        }

        // Êõ¥Êñ∞ÁÆ°ÁêÜÂëòÁªüËÆ°‰ø°ÊÅØ
        function updateAdminStats() {
            document.getElementById('memberCount').textContent = Object.keys(members).length;
            document.getElementById('battleCount').textContent = battleHistory.length;
            document.getElementById('tournamentCount').textContent = Object.keys(tournaments).length;
        }

        // Ê∑ªÂä†ÊàêÂëò
        function addMember() {
            const name = document.getElementById('memberName').value.trim();
            const scoreStr = document.getElementById('initialScore').value.trim();

            if (!name) {
                alert('ËØ∑ËæìÂÖ•ÂßìÂêç');
                return;
            }

            if (members[name]) {
                alert('ËØ•ÊàêÂëòÂ∑≤Â≠òÂú®');
                return;
            }

            const score = parseInt(scoreStr);
            if (isNaN(score)) {
                alert('ÁßØÂàÜÂøÖÈ°ªÊòØÊï¥Êï∞');
                return;
            }

            members[name] = score;
            saveDataToFirebase();
            updateMemberLists();
            updateRanking();

            document.getElementById('memberName').value = '';
            alert(`ÊàêÂëò ${name} Ê∑ªÂä†ÊàêÂäü`);
        }

        // Âà†Èô§ÊàêÂëò
        function deleteMember() {
            const checkboxes = document.querySelectorAll('#membersList input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                alert('ËØ∑ÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑÊàêÂëò');
                return;
            }

            const names = Array.from(checkboxes).map(cb => cb.getAttribute('data-name'));
            if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${names.length} ÂêçÊàêÂëòÂêóÔºüËøôÂ∞ÜÂà†Èô§Ëøô‰∫õÊàêÂëòÁöÑÊâÄÊúâÊï∞ÊçÆÔºå‰∏î‰∏çÂèØÊÅ¢Â§çÔºÅ`)) {
                names.forEach(name => {
                    delete members[name];
                    // ‰ªéÂØπÊàòËÆ∞ÂΩï‰∏≠Âà†Èô§
                    battleHistory = battleHistory.filter(battle => 
                        battle.member1 !== name && battle.member2 !== name
                    );
                    // ‰ªéÊØîËµõËÆ∞ÂΩï‰∏≠Âà†Èô§
                    Object.values(tournaments).forEach(tournament => {
                        if (tournament.participants && tournament.participants.includes(name)) {
                            tournament.participants = tournament.participants.filter(p => p !== name);
                        }
                        if (tournament.groups) {
                            tournament.groups.forEach(group => {
                                const index = group.indexOf(name);
                                if (index !== -1) {
                                    group.splice(index, 1);
                                }
                            });
                        }
                    });
                });

                // Âà†Èô§Á©∫ÁöÑÂàÜÁªÑÂíåÁ©∫ÊØîËµõ
                Object.keys(tournaments).forEach(tournamentName => {
                    if (tournaments[tournamentName].participants && tournaments[tournamentName].participants.length === 0) {
                        delete tournaments[tournamentName];
                    }
                });

                saveDataToFirebase();
                updateMemberLists();
                updateRanking();
                updateTournamentLists();
                alert('ÈÄâ‰∏≠ÁöÑÊàêÂëòÂ∑≤Âà†Èô§');
            }
        }

        // Êõ¥Êñ∞ÊàêÂëòÁßØÂàÜÊòæÁ§∫
        function updateMemberScores() {
            const member1 = document.getElementById('member1').value;
            const member2 = document.getElementById('member2').value;

            document.getElementById('member1Score').textContent = 
                member1 && members[member1] ? `ÂΩìÂâçÁßØÂàÜ: ${members[member1]}` : 'ÂΩìÂâçÁßØÂàÜ: -';
            
            document.getElementById('member2Score').textContent = 
                member2 && members[member2] ? `ÂΩìÂâçÁßØÂàÜ: ${members[member2]}` : 'ÂΩìÂâçÁßØÂàÜ: -';
        }

        // ËÆ∞ÂΩïÂØπÊàòÁªìÊûú
        function recordBattle() {
            const member1 = document.getElementById('member1').value;
            const member2 = document.getElementById('member2').value;
            const resultElement = document.querySelector('input[name="battleResult"]:checked');
            const eventName = document.getElementById('eventName').value.trim() || 'Êó•Â∏∏ÂØπÊàò';

            if (!member1 || !member2) {
                alert('ËØ∑ÈÄâÊã©ÂØπÊàòÊàêÂëò');
                return;
            }

            if (!resultElement) {
                alert('ËØ∑ÈÄâÊã©ÂØπÊàòÁªìÊûú');
                return;
            }

            if (member1 === member2) {
                alert('‰∏çËÉΩÈÄâÊã©Áõ∏ÂêåÁöÑÊàêÂëò');
                return;
            }

            const result = resultElement.value;

            // Ëé∑ÂèñÂΩìÂâçÁßØÂàÜ
            const member1Rating = members[member1];
            const member2Rating = members[member2];

            // ÂàõÂª∫ÂØπÊàòËÆ∞ÂΩï
            const battleRecord = {
                member1,
                member2,
                result,
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' }),
                event_name: eventName,
                member1_rating_before: member1Rating,
                member2_rating_before: member2Rating
            };

            // Ê†πÊçÆÁªìÊûúËÆ°ÁÆóÁßØÂàÜÂèòÂåñ
            let member1Change, member2Change, logText;

            if (result === 'member1_win') {
                // ÊàêÂëò1Ëé∑ËÉú
                member1Change = 10;
                member2Change = -10;
                logText = `${member1} ÊàòËÉú‰∫Ü ${member2}`;
            } else if (result === 'member2_win') {
                // ÊàêÂëò2Ëé∑ËÉú
                member1Change = -10;
                member2Change = 10;
                logText = `${member2} ÊàòËÉú‰∫Ü ${member1}`;
            } else if (result === 'draw') { // Âπ≥Â±Ä
                member1Change = 0;
                member2Change = 0;
                logText = `${member1} ‰∏é ${member2} ÊàòÂπ≥`;
            } else if (result === 'forfeit1') { // ÊàêÂëò1ÂºÉÊùÉ
                member1Change = -15;
                member2Change = 5;
                logText = `${member1} ÂºÉÊùÉÔºå${member2} Ëé∑ËÉú`;
            } else if (result === 'forfeit2') { // ÊàêÂëò2ÂºÉÊùÉ
                member1Change = 5;
                member2Change = -15;
                logText = `${member2} ÂºÉÊùÉÔºå${member1} Ëé∑ËÉú`;
            }

            // Êõ¥Êñ∞ÁßØÂàÜ
            members[member1] += member1Change;
            members[member2] += member2Change;

            // ËÆ∞ÂΩïÁßØÂàÜÂèòÂåñ
            battleRecord.member1_change = member1Change;
            battleRecord.member2_change = member2Change;
            battleRecord.member1_rating_after = members[member1];
            battleRecord.member2_rating_after = members[member2];

            // ‰øùÂ≠òÂØπÊàòËÆ∞ÂΩï
            battleHistory.push(battleRecord);

            // ‰øùÂ≠òÊï∞ÊçÆ
            saveDataToFirebase();

            // Êõ¥Êñ∞ÊòæÁ§∫
            updateMemberLists();
            updateRanking();
            updateMemberScores();

            // ËÆ∞ÂΩïÂØπÊàòÊó•Âøó
            const battleLog = document.getElementById('battleLog');
            logText += ` (${member1}: ${member1Change > 0 ? '+' : ''}${member1Change}, ${member2}: ${member2Change > 0 ? '+' : ''}${member2Change})`;
            battleLog.textContent += `${battleRecord.date} - [${eventName}] ${logText}\n`;
            battleLog.scrollTop = battleLog.scrollHeight;

            alert('ÂØπÊàòÁªìÊûúÂ∑≤ËÆ∞ÂΩï');
        }

        // ÂÖ®ÈÄâÊàêÂëò
        function selectAllMembers() {
            const checkboxes = document.querySelectorAll('#memberSelectList input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
        }

        // ÂàõÂª∫ÊØîËµõ
        function createTournament() {
            const tournamentName = document.getElementById('tournamentName').value.trim();
            if (!tournamentName) {
                alert('ËØ∑ËæìÂÖ•ÊØîËµõÂêçÁß∞');
                return;
            }

            // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÊàêÂëò
            const checkboxes = document.querySelectorAll('#memberSelectList input[type="checkbox"]:checked');
            if (checkboxes.length < 3) {
                alert('Ëá≥Â∞ëÈÄâÊã©3ÂêçÊàêÂëò');
                return;
            }

            const selectedMembers = Array.from(checkboxes).map(cb => cb.getAttribute('data-name'));

            // Ëé∑ÂèñÊØèÁªÑ‰∫∫Êï∞ÂíåÊôãÁ∫ß‰∫∫Êï∞
            const groupSize = parseInt(document.getElementById('groupSize').value);
            const advanceCount = parseInt(document.getElementById('advanceCount').value);

            // Ê£ÄÊü•ÊôãÁ∫ß‰∫∫Êï∞ÊòØÂê¶ÂêàÁêÜ
            if (advanceCount >= groupSize) {
                alert('ÊôãÁ∫ß‰∫∫Êï∞‰∏çËÉΩÂ§ß‰∫éÊàñÁ≠â‰∫éÂ∞èÁªÑ‰∫∫Êï∞');
                return;
            }

            // ÈöèÊú∫Êâì‰π±ÊàêÂëòÈ°∫Â∫è
            const shuffledMembers = [...selectedMembers].sort(() => Math.random() - 0.5);

            // ÂàÜÁªÑ
            const groups = [];
            for (let i = 0; i < shuffledMembers.length; i += groupSize) {
                const group = shuffledMembers.slice(i, i + groupSize);
                groups.push(group);
            }

            // Â¶ÇÊûúÊúÄÂêé‰∏ÄÁªÑ‰∫∫Êï∞‰∏çË∂≥ÔºåÂ∞ÜÂÖ∂ÂêàÂπ∂Âà∞Ââç‰∏ÄÁªÑ
            if (groups.length > 1 && groups[groups.length - 1].length < groupSize - 1) {
                const lastGroup = groups.pop();
                groups[groups.length - 1].push(...lastGroup);
            }

            // ÂàõÂª∫ÊØîËµõÂØπË±°
            const tournament = {
                name: tournamentName,
                participants: selectedMembers,
                groups: groups,
                group_size: groupSize,
                advance_count: advanceCount,
                timestamp: new Date().toISOString(),
                status: 'created'  // ÊØîËµõÁä∂ÊÄÅÔºöcreated, group_stage, knockout_stage, finished
            };
            
            // ‰øùÂ≠òÊØîËµõËÆ∞ÂΩï
            tournaments[tournamentName] = tournament;

            // Êõ¥Êñ∞ÊØîËµõÂàóË°®
            updateTournamentLists();

            // ÁîüÊàêÂàÜÁªÑÊòæÁ§∫ÊñáÊú¨
            let displayText = `ÊØîËµõÂêçÁß∞: ${tournamentName}\n`;
            displayText += `ÂèÇËµõ‰∫∫Êï∞: ${selectedMembers.length}\n`;
            displayText += `ÂàÜÁªÑÊï∞Èáè: ${groups.length}\n`;
            displayText += `ÊØèÁªÑ‰∫∫Êï∞: ${groupSize}\n`;
            displayText += `ÊØèÁªÑÊôãÁ∫ß‰∫∫Êï∞: ${advanceCount}\n\n`;

            groups.forEach((group, i) => {
                displayText += `Á¨¨ ${i + 1} ÁªÑ:\n`;
                group.forEach((member, j) => {
                    displayText += `  ${j + 1}. ${member} (ÁßØÂàÜ: ${members[member]})\n`;
                });
                displayText += "\n";
            });

            // ÊòæÁ§∫ÂàÜÁªÑÊÉÖÂÜµ
            document.getElementById('groupDisplay').textContent = displayText;

            // ‰øùÂ≠òÊï∞ÊçÆ
            saveDataToFirebase();

            alert(`ÊØîËµõ '${tournamentName}' Â∑≤ÂàõÂª∫ÔºåÂÖ±ÂàÜ‰∏∫ ${groups.length} ÁªÑ`);
        }

        // ËøõÂÖ•ÊØîËµõ
        function enterTournament() {
            const tournamentName = document.getElementById('tournamentSelect').value;
            if (!tournamentName) {
                alert('ËØ∑ÈÄâÊã©ÊØîËµõ');
                return;
            }

            // Êü•ÊâæÊØîËµõ
            currentTournament = tournaments[tournamentName];
            if (!currentTournament) {
                alert('Êú™ÊâæÂà∞ÈÄâÊã©ÁöÑÊØîËµõ');
                return;
            }

            // Êõ¥Êñ∞ÊØîËµõÂØπÊàòÈ°µÈù¢ÊòæÁ§∫
            document.getElementById('currentTournamentName').textContent = `ÂΩìÂâçÊØîËµõ: ${tournamentName}`;
            
            // ÊòæÁ§∫ÂÜ†ÂÜõ‰ø°ÊÅØ
            updateChampionDisplay();
            
            // ÊòæÁ§∫ÊàñÈöêËóèÁîüÊàêÊ∑òÊ±∞ËµõÊåâÈíÆ
            if (currentTournament.status === 'created' || currentTournament.status === 'group_stage') {
                document.getElementById('generateKnockoutBtn').style.display = 'inline-block';
            } else {
                document.getElementById('generateKnockoutBtn').style.display = 'none';
            }
            
            setupGroupStageDisplay();

            // ÂàáÊç¢Âà∞ÊØîËµõÂØπÊàòÈ°µÈù¢
            switchTab('tournament-battle');

            alert(`Â∑≤ËøõÂÖ•ÊØîËµõ: ${tournamentName}`);
        }

        // Êõ¥Êñ∞ÂÜ†ÂÜõÊòæÁ§∫
        function updateChampionDisplay() {
            const championDisplay = document.getElementById('championDisplay');
            if (currentTournament && currentTournament.champion) {
                championDisplay.style.display = 'block';
                championDisplay.textContent = `üèÜ ÂÜ†ÂÜõ: ${currentTournament.champion} üèÜ`;
            } else {
                championDisplay.style.display = 'none';
            }
        }

        // ËÆæÁΩÆÂ∞èÁªÑËµõÊòæÁ§∫
        function setupGroupStageDisplay() {
            const groupStageContent = document.getElementById('groupStageContent');
            groupStageContent.innerHTML = '';

            if (!currentTournament) {
                groupStageContent.innerHTML = '<p>ËØ∑ÂÖàÈÄâÊã©Âπ∂ËøõÂÖ•‰∏Ä‰∏™ÊØîËµõ</p>';
                return;
            }

            // ÂàõÂª∫ÂàÜÁªÑÈÄâÈ°πÂç°
            const groupTabs = document.createElement('div');
            groupTabs.className = 'group-tabs';
            groupStageContent.appendChild(groupTabs);

            // ÂàõÂª∫ÂàÜÁªÑÂÜÖÂÆπÂÆπÂô®
            const groupContents = document.createElement('div');
            groupContents.className = 'group-contents';
            groupStageContent.appendChild(groupContents);

            // ‰∏∫ÊØè‰∏™Â∞èÁªÑÂàõÂª∫ÈÄâÈ°πÂç°ÂíåÂÜÖÂÆπ
            currentTournament.groups.forEach((group, groupIndex) => {
                // ÂàõÂª∫ÈÄâÈ°πÂç°
                const groupTab = document.createElement('button');
                groupTab.className = 'group-tab';
                if (groupIndex === 0) groupTab.classList.add('active');
                groupTab.textContent = `Á¨¨ ${groupIndex + 1} ÁªÑ`;
                groupTab.addEventListener('click', () => {
                    // ÊøÄÊ¥ªÂΩìÂâçÈÄâÈ°πÂç°
                    document.querySelectorAll('.group-tab').forEach(tab => tab.classList.remove('active'));
                    groupTab.classList.add('active');
                    
                    // ÊòæÁ§∫ÂΩìÂâçÂàÜÁªÑÂÜÖÂÆπ
                    document.querySelectorAll('.group-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(`groupContent${groupIndex}`).classList.add('active');
                    
                    currentGroupIndex = groupIndex;
                });
                groupTabs.appendChild(groupTab);

                // ÂàõÂª∫ÂàÜÁªÑÂÜÖÂÆπ
                const groupContent = document.createElement('div');
                groupContent.className = 'group-content';
                groupContent.id = `groupContent${groupIndex}`;
                if (groupIndex === 0) groupContent.classList.add('active');
                groupContents.appendChild(groupContent);

                // Â∞èÁªÑÁßØÂàÜÊ¶ú
                const statsHeader = document.createElement('h4');
                statsHeader.textContent = 'Â∞èÁªÑÁßØÂàÜÊ¶ú:';
                groupContent.appendChild(statsHeader);

                const statsTable = document.createElement('table');
                statsTable.innerHTML = `
                    <thead>
                        <tr>
                            <th>ÊéíÂêç</th>
                            <th>ÂßìÂêç</th>
                            <th>ÁßØÂàÜ</th>
                            <th>ËÉúÂú∫</th>
                            <th>Ë¥üÂú∫</th>
                        </tr>
                    </thead>
                    <tbody id="groupStats${groupIndex}">
                    </tbody>
                `;
                groupContent.appendChild(statsTable);

                // ËÆ°ÁÆóÂ∞èÁªÑÁßØÂàÜ
                const groupStats = calculateGroupStats(group, currentTournament.name);

                // ÊåâÁßØÂàÜÊéíÂ∫è
                const sortedStats = Object.entries(groupStats)
                    .sort((a, b) => b[1].points - a[1].points);

                // Ê∑ªÂä†ÊéíÂêçÊï∞ÊçÆ
                const statsBody = document.getElementById(`groupStats${groupIndex}`);
                sortedStats.forEach(([name, stats], rank) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${rank + 1}</td>
                        <td>${name}</td>
                        <td>${stats.points}</td>
                        <td>${stats.wins}</td>
                        <td>${stats.losses}</td>
                    `;
                    statsBody.appendChild(row);
                });

                // Â∞èÁªÑÂØπÈòµ
                const matchesHeader = document.createElement('h4');
                matchesHeader.textContent = 'Â∞èÁªÑÂØπÈòµ:';
                groupContent.appendChild(matchesHeader);

                const matchesDiv = document.createElement('div');
                matchesDiv.className = 'matches-list';
                groupContent.appendChild(matchesDiv);

                // ÁîüÊàêÊâÄÊúâÂèØËÉΩÁöÑÂØπÊàòÁªÑÂêà
                const matches = [];
                for (let i = 0; i < group.length; i++) {
                    for (let j = i + 1; j < group.length; j++) {
                        matches.push([group[i], group[j]]);
                    }
                }

                // ÊòæÁ§∫ÊâÄÊúâÊØîËµõ
                matches.forEach(match => {
                    const [player1, player2] = match;
                    const matchItem = document.createElement('div');
                    matchItem.className = 'match-item';
                    
                    // Ê£ÄÊü•ÊòØÂê¶Â∑≤ËøõË°åÊØîËµõ
                    const existingBattle = battleHistory.find(b => 
                        b.event_name === currentTournament.name &&
                        ((b.member1 === player1 && b.member2 === player2) ||
                         (b.member1 === player2 && b.member2 === player1))
                    );
                    
                    if (existingBattle) {
                        let resultText = '';
                        if (existingBattle.result === 'member1_win') {
                            resultText = existingBattle.member1 === player1 ? 
                                `${player1} ËÉú` : `${player2} ËÉú`;
                        } else if (existingBattle.result === 'member2_win') {
                            resultText = existingBattle.member2 === player1 ? 
                                `${player1} ËÉú` : `${player2} ËÉú`;
                        } else if (existingBattle.result === 'draw') {
                            resultText = 'Âπ≥Â±Ä';
                        } else if (existingBattle.result === 'forfeit1') {
                            resultText = existingBattle.member1 === player1 ? 
                                `${player1} ÂºÉÊùÉ` : `${player2} ÂºÉÊùÉ`;
                        } else if (existingBattle.result === 'forfeit2') {
                            resultText = existingBattle.member2 === player1 ? 
                                `${player1} ÂºÉÊùÉ` : `${player2} ÂºÉÊùÉ`;
                        }
                        
                        matchItem.innerHTML = `
                            <span>${player1} vs ${player2} (${resultText})</span>
                            <div class="match-actions">
                                <button class="warning" data-action="modify" data-player1="${player1}" data-player2="${player2}">‰øÆÊîπÁªìÊûú</button>
                            </div>
                        `;
                        matchItem.classList.add('completed');
                    } else {
                        matchItem.innerHTML = `
                            <span>${player1} vs ${player2}</span>
                            <div class="match-actions">
                                <button class="success" data-action="record" data-player1="${player1}" data-player2="${player2}">ËÆ∞ÂΩïÁªìÊûú</button>
                            </div>
                        `;
                    }
                    
                    matchesDiv.appendChild(matchItem);
                });

                // ‰∏∫ÊâÄÊúâÊåâÈíÆÊ∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
                matchesDiv.querySelectorAll('.match-actions button').forEach(button => {
                    button.addEventListener('click', function() {
                        const action = this.getAttribute('data-action');
                        const player1 = this.getAttribute('data-player1');
                        const player2 = this.getAttribute('data-player2');
                        
                        if (action === 'record') {
                            openBattleModal(player1, player2, null, false);
                        } else if (action === 'modify') {
                            openBattleModal(player1, player2, null, true);
                        }
                    });
                });
            });
        }

        // ËÆ°ÁÆóÂ∞èÁªÑËµõÁªüËÆ°Êï∞ÊçÆ
        function calculateGroupStats(groupMembers, tournamentName) {
            const stats = {};

            // ÂàùÂßãÂåñÁªüËÆ°
            groupMembers.forEach(member => {
                stats[member] = {
                    points: 0,
                    wins: 0,
                    losses: 0,
                    forfeits: 0
                };
            });

            // Êü•ÊâæËØ•Â∞èÁªÑÁöÑÊâÄÊúâÂØπÊàòËÆ∞ÂΩï
            battleHistory.forEach(battle => {
                if (battle.event_name === tournamentName &&
                    groupMembers.includes(battle.member1) &&
                    groupMembers.includes(battle.member2)) {

                    if (battle.result === 'member1_win') {
                        stats[battle.member1].points += 3;
                        stats[battle.member1].wins += 1;
                        stats[battle.member2].losses += 1;
                    } else if (battle.result === 'member2_win') {
                        stats[battle.member2].points += 3;
                        stats[battle.member2].wins += 1;
                        stats[battle.member1].losses += 1;
                    } else if (battle.result === 'draw') {
                        stats[battle.member1].points += 1;
                        stats[battle.member2].points += 1;
                    } else if (battle.result === 'forfeit1') {
                        stats[battle.member1].forfeits += 1;
                        stats[battle.member2].points += 3;
                        stats[battle.member2].wins += 1;
                    } else if (battle.result === 'forfeit2') {
                        stats[battle.member2].forfeits += 1;
                        stats[battle.member1].points += 3;
                        stats[battle.member1].wins += 1;
                    }
                }
            });

            return stats;
        }

        // ÊâìÂºÄÂØπÊàòËÆ∞ÂΩïÊ®°ÊÄÅÊ°Ü
        function openBattleModal(player1, player2, group, isModify = false) {
            document.getElementById('battleModalTitle').textContent = isModify ? '‰øÆÊîπÊØîËµõÁªìÊûú' : 'ËÆ∞ÂΩïÊØîËµõÂØπÊàòÁªìÊûú';
            document.getElementById('battlePlayers').textContent = `${player1} vs ${player2}`;
            
            // ËÆæÁΩÆÊØîÂàÜÈÄâÈ°π
            const resultOptions = document.getElementById('battleResultOptions');
            resultOptions.innerHTML = `
                <div class="score-option" data-result="member1_win">
                    <input type="radio" name="tournamentBattleResult" value="member1_win" style="display: none;">
                    <span>${player1} Ëé∑ËÉú</span>
                </div>
                <div class="score-option" data-result="member2_win">
                    <input type="radio" name="tournamentBattleResult" value="member2_win" style="display: none;">
                    <span>${player2} Ëé∑ËÉú</span>
                </div>
                <div class="score-option" data-result="draw">
                    <input type="radio" name="tournamentBattleResult" value="draw" style="display: none;">
                    <span>Âπ≥Â±Ä</span>
                </div>
                <div class="score-option" data-result="forfeit1">
                    <input type="radio" name="tournamentBattleResult" value="forfeit1" style="display: none;">
                    <span>${player1} ÂºÉÊùÉ</span>
                </div>
                <div class="score-option" data-result="forfeit2">
                    <input type="radio" name="tournamentBattleResult" value="forfeit2" style="display: none;">
                    <span>${player2} ÂºÉÊùÉ</span>
                </div>
            `;
            
            // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
            document.querySelectorAll('.score-option').forEach(option => {
                option.addEventListener('click', function() {
                    // ÁßªÈô§ÊâÄÊúâÈÄâ‰∏≠Áä∂ÊÄÅ
                    document.querySelectorAll('.score-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    // Ê∑ªÂä†ÂΩìÂâçÈÄâ‰∏≠Áä∂ÊÄÅ
                    this.classList.add('selected');
                    // ÈÄâ‰∏≠ÂØπÂ∫îÁöÑÂçïÈÄâÊåâÈíÆ
                    const radio = this.querySelector('input[type="radio"]');
                    radio.checked = true;
                });
            });
            
            // Â¶ÇÊûúÊòØ‰øÆÊîπÊ®°ÂºèÔºåËÆæÁΩÆÂΩìÂâçÁªìÊûú
            if (isModify) {
                const battleRecord = getBattleRecord(player1, player2, currentTournament.name);
                if (battleRecord) {
                    const result = battleRecord.result;
                    
                    // ÊâæÂà∞ÂØπÂ∫îÁöÑÈÄâÈ°πÂπ∂ÈÄâ‰∏≠
                    const option = document.querySelector(`.score-option[data-result="${result}"]`);
                    if (option) {
                        option.classList.add('selected');
                        const radio = option.querySelector('input[type="radio"]');
                        radio.checked = true;
                    }
                }
                document.getElementById('deleteBattle').style.display = 'inline-block';
            } else {
                document.getElementById('deleteBattle').style.display = 'none';
            }
            
            // Â≠òÂÇ®ÂΩìÂâçÂØπÊàò‰ø°ÊÅØ
            window.currentBattle = { player1, player2, group, isModify };
            window.currentKnockout = null; // Á°Æ‰øùËøôÊòØÂ∞èÁªÑËµõ
            
            document.getElementById('battleResultModal').style.display = 'flex';
        }

        // Ëé∑ÂèñÂØπÊàòËÆ∞ÂΩï
        function getBattleRecord(player1, player2, tournamentName) {
            return battleHistory.find(b => 
                b.event_name === tournamentName &&
                ((b.member1 === player1 && b.member2 === player2) ||
                 (b.member1 === player2 && b.member2 === player1))
            );
        }

        // Á°ÆËÆ§ÂØπÊàòÁªìÊûú
        function confirmBattleResult() {
            const selectedOption = document.querySelector('.score-option.selected');
            if (!selectedOption) {
                alert('ËØ∑ÈÄâÊã©ÊØîËµõÁªìÊûú');
                return;
            }
            
            const result = selectedOption.getAttribute('data-result');
            
            // Â§ÑÁêÜÂ∞èÁªÑËµõÁªìÊûú
            if (window.currentBattle) {
                const { player1, player2, group, isModify } = window.currentBattle;
                const eventName = currentTournament.name;

                // Â¶ÇÊûúÊòØ‰øÆÊîπÊ®°ÂºèÔºåÂÖàÂà†Èô§ÂéüÊù•ÁöÑËÆ∞ÂΩï
                if (isModify) {
                    deleteBattleRecord(player1, player2, false);
                }

                // Ëé∑ÂèñÂΩìÂâçÁßØÂàÜ
                const player1Rating = members[player1];
                const player2Rating = members[player2];

                // ÂàõÂª∫ÂØπÊàòËÆ∞ÂΩï
                const battleRecord = {
                    member1: player1,
                    member2: player2,
                    result: result,
                    timestamp: new Date().toISOString(),
                    date: new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' }),
                    event_name: eventName,
                    member1_rating_before: player1Rating,
                    member2_rating_before: player2Rating
                };

                // Ê†πÊçÆÁªìÊûúËÆ°ÁÆóÁßØÂàÜÂèòÂåñ
                let player1Change, player2Change;

                if (result === 'member1_win') {
                    player1Change = 10;
                    player2Change = -10;
                } else if (result === 'member2_win') {
                    player1Change = -10;
                    player2Change = 10;
                } else if (result === 'draw') {
                    player1Change = 0;
                    player2Change = 0;
                } else if (result === 'forfeit1') {
                    player1Change = -15;
                    player2Change = 5;
                } else if (result === 'forfeit2') {
                    player1Change = 5;
                    player2Change = -15;
                }

                // Êõ¥Êñ∞ÁßØÂàÜ
                members[player1] += player1Change;
                members[player2] += player2Change;

                // ËÆ∞ÂΩïÁßØÂàÜÂèòÂåñ
                battleRecord.member1_change = player1Change;
                battleRecord.member2_change = player2Change;
                battleRecord.member1_rating_after = members[player1];
                battleRecord.member2_rating_after = members[player2];

                // ‰øùÂ≠òÂØπÊàòËÆ∞ÂΩï
                battleHistory.push(battleRecord);

                // Êõ¥Êñ∞ÊØîËµõÁä∂ÊÄÅ
                if (currentTournament.status === 'created') {
                    currentTournament.status = 'group_stage';
                }

                // ‰øùÂ≠òÊï∞ÊçÆ
                saveDataToFirebase();

                // Êõ¥Êñ∞ÊòæÁ§∫
                updateMemberLists();
                updateRanking();
                setupGroupStageDisplay();

                document.getElementById('battleResultModal').style.display = 'none';
                alert(isModify ? 'ÊØîËµõÁªìÊûúÂ∑≤‰øÆÊîπ' : 'ÊØîËµõÂØπÊàòÁªìÊûúÂ∑≤ËÆ∞ÂΩï');
            }
        }

        // Âà†Èô§ÂØπÊàòËÆ∞ÂΩï
        function deleteBattleRecord(player1, player2, showAlert = true) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ÂØπÊàòËÆ∞ÂΩïÂêóÔºü')) {
                return;
            }

            // Êü•ÊâæÂØπÊàòËÆ∞ÂΩï
            const battleIndex = battleHistory.findIndex(battle => 
                battle.event_name === currentTournament.name &&
                ((battle.member1 === player1 && battle.member2 === player2) ||
                 (battle.member1 === player2 && battle.member2 === player1))
            );

            if (battleIndex !== -1) {
                const battle = battleHistory[battleIndex];
                
                // Êí§ÈîÄÁßØÂàÜÂèòÂåñ
                members[battle.member1] = battle.member1_rating_before;
                members[battle.member2] = battle.member2_rating_before;
                
                // Âà†Èô§ÂØπÊàòËÆ∞ÂΩï
                battleHistory.splice(battleIndex, 1);
                
                // ‰øùÂ≠òÊï∞ÊçÆ
                saveDataToFirebase();
                
                // Êõ¥Êñ∞ÊòæÁ§∫
                updateMemberLists();
                updateRanking();
                setupGroupStageDisplay();
                
                if (showAlert) {
                    alert('ÂØπÊàòËÆ∞ÂΩïÂ∑≤Âà†Èô§');
                }
                
                document.getElementById('battleResultModal').style.display = 'none';
            }
        }

        // ÁîüÊàêÊ∑òÊ±∞ËµõÈò∂ÊÆµ
        function generateKnockoutStage() {
            if (!currentTournament) {
                alert('Ê≤°ÊúâÂΩìÂâçÊØîËµõ');
                return;
            }

            // Ëé∑ÂèñÊØè‰∏™Â∞èÁªÑÁöÑÊôãÁ∫ßÈÄâÊâã
            const advancePlayers = [];
            currentTournament.groups.forEach(group => {
                const groupStats = calculateGroupStats(group, currentTournament.name);
                if (!groupStats) {
                    alert('Â∞èÁªÑËµõÊï∞ÊçÆ‰∏çÂÆåÊï¥');
                    return;
                }

                // ÊåâÁßØÂàÜÊéíÂ∫è
                const sortedStats = Object.entries(groupStats)
                    .sort((a, b) => b[1].points - a[1].points);
                
                // ÂèñÂâçadvance_countÂêç
                for (let i = 0; i < Math.min(currentTournament.advance_count, sortedStats.length); i++) {
                    advancePlayers.push(sortedStats[i][0]);
                }
            });

            // Ê£ÄÊü•ÊòØÂê¶ÊúâË∂≥Â§üÁöÑÊôãÁ∫ßÈÄâÊâã
            if (advancePlayers.length < 2) {
                alert('Â∞èÁªÑËµõÂ∞öÊú™ÂÆåÊàêÊàñÊôãÁ∫ßÈÄâÊâã‰∏çË∂≥');
                return;
            }

            // ÈöèÊú∫Êâì‰π±ÊôãÁ∫ßÈÄâÊâãÈ°∫Â∫è
            const shuffledPlayers = [...advancePlayers].sort(() => Math.random() - 0.5);

            // ÁîüÊàêÊ∑òÊ±∞ËµõÂØπÈòµ
            const knockoutBracket = {};
            let roundName;

            if (advancePlayers.length <= 4) {
                roundName = "ÂçäÂÜ≥Ëµõ";
            } else if (advancePlayers.length <= 8) {
                roundName = "ÂÖ´Âº∫Ëµõ";
            } else if (advancePlayers.length <= 16) {
                roundName = "ÂçÅÂÖ≠Âº∫Ëµõ";
            } else {
                roundName = "‰∏âÂçÅ‰∫åÂº∫Ëµõ";
            }

            // ÂàõÂª∫Á¨¨‰∏ÄËΩÆÂØπÈòµ
            const firstRoundMatches = [];
            for (let i = 0; i < shuffledPlayers.length; i += 2) {
                if (i + 1 < shuffledPlayers.length) {
                    firstRoundMatches.push({
                        player1: shuffledPlayers[i],
                        player2: shuffledPlayers[i + 1],
                        completed: false,
                        winner: null
                    });
                }
            }

            knockoutBracket[roundName] = firstRoundMatches;

            // Êõ¥Êñ∞ÊØîËµõÁä∂ÊÄÅÂíåÊ∑òÊ±∞ËµõÂØπÈòµ
            currentTournament.status = 'knockout_stage';
            currentTournament.knockout_bracket = knockoutBracket;

            // ‰øùÂ≠òÊï∞ÊçÆ
            saveDataToFirebase();

            // Êõ¥Êñ∞ÊòæÁ§∫
            document.getElementById('generateKnockoutBtn').style.display = 'none';
            setupKnockoutStageDisplay();

            alert(`Ê∑òÊ±∞ËµõÂ∑≤ÁîüÊàêÔºåÂÖ±${advancePlayers.length}ÂêçÈÄâÊâãÊôãÁ∫ß`);
        }

        // ËÆæÁΩÆÊ∑òÊ±∞ËµõÊòæÁ§∫
        function setupKnockoutStageDisplay() {
            const knockoutStageContent = document.getElementById('knockoutStageContent');
            knockoutStageContent.innerHTML = '';

            if (!currentTournament || !currentTournament.knockout_bracket) {
                knockoutStageContent.innerHTML = '<p>Ê∑òÊ±∞ËµõÂ∞öÊú™ÁîüÊàê</p>';
                return;
            }

            // ÂàõÂª∫Ê∑òÊ±∞ËµõÊ†ëÂΩ¢ËßÜÂõæ
            const knockoutTable = document.createElement('table');
            knockoutTable.innerHTML = `
                <thead>
                    <tr>
                        <th>ËΩÆÊ¨°</th>
                        <th>ÂØπÈòµ</th>
                        <th>Áä∂ÊÄÅ</th>
                        <th>ËÉúËÄÖ</th>
                        <th>Êìç‰Ωú</th>
                    </tr>
                </thead>
                <tbody id="knockoutBody">
                </tbody>
            `;
            knockoutStageContent.appendChild(knockoutTable);

            // Ê∑ªÂä†Ê∑òÊ±∞ËµõÊï∞ÊçÆ
            const knockoutBody = document.getElementById('knockoutBody');
            Object.entries(currentTournament.knockout_bracket).forEach(([roundName, matches]) => {
                matches.forEach(match => {
                    const row = document.createElement('tr');
                    const status = match.completed ? 'Â∑≤ÂÆåÊàê' : 'Êú™ÂºÄÂßã';
                    const winner = match.completed ? match.winner : 'ÂæÖÂÆö';
                    
                    row.innerHTML = `
                        <td>${roundName}</td>
                        <td>${match.player1} vs ${match.player2}</td>
                        <td>${status}</td>
                        <td>${winner}</td>
                        <td class="match-actions">
                            ${match.completed ? 
                                `<button class="warning" data-action="modify" data-round="${roundName}" data-player1="${match.player1}" data-player2="${match.player2}">‰øÆÊîπ</button>` :
                                `<button class="success" data-action="record" data-round="${roundName}" data-player1="${match.player1}" data-player2="${match.player2}">ËÆ∞ÂΩïÁªìÊûú</button>`
                            }
                        </td>
                    `;
                    knockoutBody.appendChild(row);
                });
            });

            // ‰∏∫ÊâÄÊúâÊåâÈíÆÊ∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
            document.querySelectorAll('#knockoutBody .match-actions button').forEach(button => {
                button.addEventListener('click', function() {
                    const action = this.getAttribute('data-action');
                    const player1 = this.getAttribute('data-player1');
                    const player2 = this.getAttribute('data-player2');
                    const roundName = this.getAttribute('data-round');
                    
                    if (action === 'record') {
                        openKnockoutBattleModal(roundName, player1, player2, false);
                    } else if (action === 'modify') {
                        openKnockoutBattleModal(roundName, player1, player2, true);
                    }
                });
            });
        }

        // ÊâìÂºÄÊ∑òÊ±∞ËµõÂØπÊàòÊ®°ÊÄÅÊ°Ü
        function openKnockoutBattleModal(roundName, player1, player2, isModify = false) {
            document.getElementById('battleModalTitle').textContent = isModify ? '‰øÆÊîπÊ∑òÊ±∞ËµõÁªìÊûú' : 'ËÆ∞ÂΩïÊ∑òÊ±∞ËµõÁªìÊûú';
            document.getElementById('battlePlayers').textContent = `${player1} vs ${player2}`;
            
            // ËÆæÁΩÆÂØπÊàòÁªìÊûúÈÄâÈ°π - Ê∑òÊ±∞ËµõÊ≤°ÊúâÂπ≥Â±ÄÂíåÂºÉÊùÉÈÄâÈ°π
            const resultOptions = document.getElementById('battleResultOptions');
            resultOptions.innerHTML = `
                <div class="score-option" data-result="member1_win">
                    <input type="radio" name="tournamentBattleResult" value="member1_win" style="display: none;">
                    <span>${player1} Ëé∑ËÉú</span>
                </div>
                <div class="score-option" data-result="member2_win">
                    <input type="radio" name="tournamentBattleResult" value="member2_win" style="display: none;">
                    <span>${player2} Ëé∑ËÉú</span>
                </div>
            `;
            
            // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
            document.querySelectorAll('.score-option').forEach(option => {
                option.addEventListener('click', function() {
                    // ÁßªÈô§ÊâÄÊúâÈÄâ‰∏≠Áä∂ÊÄÅ
                    document.querySelectorAll('.score-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    // Ê∑ªÂä†ÂΩìÂâçÈÄâ‰∏≠Áä∂ÊÄÅ
                    this.classList.add('selected');
                    // ÈÄâ‰∏≠ÂØπÂ∫îÁöÑÂçïÈÄâÊåâÈíÆ
                    const radio = this.querySelector('input[type="radio"]');
                    radio.checked = true;
                });
            });
            
            // Â¶ÇÊûúÊòØ‰øÆÊîπÊ®°ÂºèÔºåËÆæÁΩÆÂΩìÂâçÁªìÊûú
            if (isModify) {
                const battleRecord = getBattleRecord(player1, player2, currentTournament.name + " - " + roundName);
                if (battleRecord) {
                    const result = battleRecord.result;
                    
                    // ÊâæÂà∞ÂØπÂ∫îÁöÑÈÄâÈ°πÂπ∂ÈÄâ‰∏≠
                    const option = document.querySelector(`.score-option[data-result="${result}"]`);
                    if (option) {
                        option.classList.add('selected');
                        const radio = option.querySelector('input[type="radio"]');
                        radio.checked = true;
                    }
                }
                document.getElementById('deleteBattle').style.display = 'inline-block';
            } else {
                document.getElementById('deleteBattle').style.display = 'none';
            }
            
            // Â≠òÂÇ®ÂΩìÂâçÊ∑òÊ±∞Ëµõ‰ø°ÊÅØ
            window.currentKnockout = { roundName, player1, player2, isModify };
            window.currentBattle = null; // Á°Æ‰øùËøôÊòØÊ∑òÊ±∞Ëµõ
            
            document.getElementById('battleResultModal').style.display = 'flex';
        }

        // ÊòæÁ§∫ÊàêÂëòÂéÜÂè≤ÊàòÁª©
        function showMemberHistory() {
            const member = document.getElementById('historyMember').value;
            if (!member) {
                alert('ËØ∑ÈÄâÊã©ÊàêÂëò');
                return;
            }

            // ÁªüËÆ°ÊàòÁª©
            let wins = 0, losses = 0, draws = 0, forfeits = 0;
            const memberBattles = battleHistory.filter(battle => 
                battle.member1 === member || battle.member2 === member
            );

            memberBattles.forEach(battle => {
                if (battle.result === 'member1_win') {
                    if (battle.member1 === member) wins++;
                    else losses++;
                } else if (battle.result === 'member2_win') {
                    if (battle.member2 === member) wins++;
                    else losses++;
                } else if (battle.result === 'draw') {
                    draws++;
                } else if (battle.result === 'forfeit1') {
                    if (battle.member1 === member) forfeits++;
                    else wins++;
                } else if (battle.result === 'forfeit2') {
                    if (battle.member2 === member) forfeits++;
                    else wins++;
                }
            });

            // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
            const totalBattles = wins + losses + draws + forfeits;
            const winRate = totalBattles > 0 ? (wins / totalBattles * 100).toFixed(1) : 0;

            document.getElementById('winsCount').textContent = wins;
            document.getElementById('lossesCount').textContent = losses;
            document.getElementById('drawsCount').textContent = draws;
            document.getElementById('winRate').textContent = `${winRate}%`;

            // ÊòæÁ§∫ÂéÜÂè≤ÊàòÁª©
            const historyDisplay = document.getElementById('historyDisplay');
            let historyText = `${member} ÁöÑÂéÜÂè≤ÊàòÁª© (ÂÖ± ${totalBattles} Âú∫):\n\n`;

            if (memberBattles.length === 0) {
                historyText += 'ÊöÇÊó†ÂØπÊàòËÆ∞ÂΩï';
            } else {
                // ÊåâÊó∂Èó¥ÂÄíÂ∫èÊéíÂàó
                memberBattles.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                memberBattles.forEach(battle => {
                    let opponent, result;
                    
                    if (battle.member1 === member) {
                        opponent = battle.member2;
                        if (battle.result === 'member1_win') result = 'ËÉúÂà©';
                        else if (battle.result === 'member2_win') result = 'Â§±Ë¥•';
                        else if (battle.result === 'draw') result = 'Âπ≥Â±Ä';
                        else if (battle.result === 'forfeit1') result = 'ÂºÉÊùÉ';
                        else if (battle.result === 'forfeit2') result = 'ÂØπÊâãÂºÉÊùÉ';
                    } else {
                        opponent = battle.member1;
                        if (battle.result === 'member2_win') result = 'ËÉúÂà©';
                        else if (battle.result === 'member1_win') result = 'Â§±Ë¥•';
                        else if (battle.result === 'draw') result = 'Âπ≥Â±Ä';
                        else if (battle.result === 'forfeit2') result = 'ÂºÉÊùÉ';
                        else if (battle.result === 'forfeit1') result = 'ÂØπÊâãÂºÉÊùÉ';
                    }
                    
                    const date = battle.date || 'Êú™Áü•Êó•Êúü';
                    const eventName = battle.event_name || 'Êó•Â∏∏ÂØπÊàò';
                    
                    historyText += `${date} - [${eventName}] ÂØπÊàò ${opponent}: ${result}\n`;
                });
            }

            historyDisplay.textContent = historyText;
        }

        // ÊòæÁ§∫ÊØîËµõÁªìÊûú
        function showTournamentResults() {
            const tournamentName = document.getElementById('resultsTournament').value;
            if (!tournamentName) {
                alert('ËØ∑ÈÄâÊã©ÊØîËµõ');
                return;
            }

            // Êü•ÊâæÊØîËµõ
            const tournament = tournaments[tournamentName];
            if (!tournament) {
                alert('Êú™ÊâæÂà∞ÈÄâÊã©ÁöÑÊØîËµõ');
                return;
            }

            // ÁîüÊàêÊØîËµõÁªìÊûúÊñáÊú¨
            let resultsText = `ÊØîËµõÂêçÁß∞: ${tournament.name}\n`;
            resultsText += `ÂàõÂª∫Êó∂Èó¥: ${tournament.timestamp || 'Êú™Áü•'}\n`;
            resultsText += `ÊØîËµõÁä∂ÊÄÅ: ${tournament.status || 'Êú™Áü•'}\n\n`;

            // ÊòæÁ§∫ÂÜ†ÂÜõ‰ø°ÊÅØ
            if (tournament.champion) {
                resultsText += `üèÜ ÂÜ†ÂÜõ: ${tournament.champion} üèÜ\n`;
            }
            if (tournament.runnerUp) {
                resultsText += `ü•à ‰∫öÂÜõ: ${tournament.runnerUp} ü•à\n`;
            }
            if (tournament.thirdPlace) {
                resultsText += `ü•â Â≠£ÂÜõ: ${tournament.thirdPlace} ü•â\n`;
            }
            resultsText += "\n";

            // ÊòæÁ§∫Â∞èÁªÑËµõÁªìÊûú
            resultsText += "=== Â∞èÁªÑËµõÁªìÊûú ===\n\n";

            if (tournament.groups) {
                tournament.groups.forEach((group, i) => {
                    resultsText += `Á¨¨ ${i + 1} ÁªÑ:\n`;

                    // ËÆ°ÁÆóÂ∞èÁªÑÁßØÂàÜ
                    const groupStats = calculateGroupStats(group, tournament.name);

                    // ÊåâÁßØÂàÜÊéíÂ∫è
                    const sortedStats = Object.entries(groupStats)
                        .sort((a, b) => b[1].points - a[1].points);

                    sortedStats.forEach(([name, stats], index) => {
                        resultsText += `  ${index + 1}. ${name} - ÁßØÂàÜ: ${stats.points}, ËÉú: ${stats.wins}, Ë¥ü: ${stats.losses}, ÂºÉÊùÉ: ${stats.forfeits}\n`;
                    });

                    // ÊòæÁ§∫ÊôãÁ∫ßÈÄâÊâã
                    if (tournament.advance_count && sortedStats.length > 0) {
                        resultsText += `  ÊôãÁ∫ß: `;
                        for (let i = 0; i < Math.min(tournament.advance_count, sortedStats.length); i++) {
                            resultsText += `${sortedStats[i][0]}${i < Math.min(tournament.advance_count, sortedStats.length) - 1 ? ', ' : ''}`;
                        }
                        resultsText += `\n`;
                    }

                    resultsText += "\n";
                });
            }

            // ÊòæÁ§∫Ê∑òÊ±∞ËµõÁªìÊûú
            if (tournament.knockout_bracket) {
                resultsText += "=== Ê∑òÊ±∞ËµõÁªìÊûú ===\n\n";

                Object.entries(tournament.knockout_bracket).forEach(([roundName, matches]) => {
                    resultsText += `${roundName}:\n`;
                    matches.forEach(match => {
                        if (match.completed) {
                            resultsText += `  ${match.player1} vs ${match.player2} -> ${match.winner}\n`;
                        } else {
                            resultsText += `  ${match.player1} vs ${match.player2} (Êú™ÂÆåÊàê)\n`;
                        }
                    });
                    resultsText += "\n";
                });
            }

            // ÊòæÁ§∫ÊØîËµõËøáÁ®ã
            resultsText += "=== ÊØîËµõËøáÁ®ã ===\n\n";

            // Êü•ÊâæËØ•ÊØîËµõÁöÑÊâÄÊúâÂØπÊàòËÆ∞ÂΩï
            const tournamentBattles = battleHistory.filter(battle => 
                battle.event_name === tournament.name
            );

            if (tournamentBattles.length > 0) {
                // ÊåâÊó∂Èó¥ÊéíÂ∫è
                tournamentBattles.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                tournamentBattles.forEach(battle => {
                    const date = battle.date || 'Êú™Áü•Êó•Êúü';
                    const { member1, member2 } = battle;

                    let result;
                    if (battle.result === 'member1_win') {
                        result = `${member1} ËÉú`;
                    } else if (battle.result === 'member2_win') {
                        result = `${member2} ËÉú`;
                    } else if (battle.result === 'draw') {
                        result = 'Âπ≥Â±Ä';
                    } else if (battle.result === 'forfeit1') {
                        result = `${member1} ÂºÉÊùÉ`;
                    } else if (battle.result === 'forfeit2') {
                        result = `${member2} ÂºÉÊùÉ`;
                    }

                    resultsText += `${date}: ${member1} vs ${member2} -> ${result}\n`;
                });
            } else {
                resultsText += "ÊöÇÊó†ÊØîËµõËÆ∞ÂΩï\n";
            }

            // ÊòæÁ§∫ÁªìÊûú
            document.getElementById('tournamentResultsDisplay').textContent = resultsText;
        }

        // Â§á‰ªΩÊï∞ÊçÆ
        function backupData() {
            const backupData = {
                members: members,
                battleHistory: battleHistory,
                tournaments: tournaments,
                backup_time: new Date().toISOString()
            };

            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pingpong_backup_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Êï∞ÊçÆÂ§á‰ªΩÊàêÂäü');
        }

        // ÊÅ¢Â§çÊï∞ÊçÆ
        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const backupData = JSON.parse(event.target.result);
                        
                        members = backupData.members || {};
                        battleHistory = backupData.battleHistory || [];
                        tournaments = backupData.tournaments || {};
                        currentTournament = null;
                        
                        saveDataToFirebase();
                        updateMemberLists();
                        updateRanking();
                        updateAdminStats();
                        updateTournamentLists();
                        
                        alert('Êï∞ÊçÆÊÅ¢Â§çÊàêÂäü');
                    } catch (error) {
                        alert('ÊÅ¢Â§çÂ§±Ë¥•: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // ÂàùÂßãÂåñÁ≥ªÁªü
        function initializeSystem() {
            if (confirm('Á°ÆÂÆöË¶ÅÂàùÂßãÂåñÁ≥ªÁªüÂêóÔºüËøôÂ∞ÜÂà†Èô§ÊâÄÊúâÊï∞ÊçÆÔºåÊìç‰Ωú‰∏çÂèØÈÄÜÔºÅ')) {
                members = {};
                battleHistory = [];
                tournaments = {};
                currentTournament = null;
                
                saveDataToFirebase();
                updateMemberLists();
                updateRanking();
                updateAdminStats();
                updateTournamentLists();
                
                alert('Á≥ªÁªüÂ∑≤ÂàùÂßãÂåñÔºåÊâÄÊúâÊï∞ÊçÆÂ∑≤Ê∏ÖÁ©∫');
            }
        }
    </script>
</body>
</html>